<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Visualizador ‚Äî Suas Fotos üì∏</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter, Arial, Helvetica, sans-serif;min-height:100vh;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;padding:18px;display:flex;flex-direction:column;align-items:center}
    .wrap{width:100%;max-width:860px}
    .header{background:rgba(255,255,255,0.06);padding:18px;border-radius:14px;display:flex;align-items:center;gap:12px;margin-bottom:16px;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.04)}
    .header h1{font-size:22px;margin:0}
    .header .sub{opacity:0.9;font-size:14px;margin-left:auto}
    .expiry{margin-top:8px;background:rgba(255,193,7,0.12);color:#fff;padding:10px;border-radius:10px;border:1px solid rgba(255,193,7,0.2);font-size:13px}
    .gallery{display:flex;flex-direction:column;gap:20px;margin-top:18px}
    .stories-card{background:linear-gradient(135deg,#833AB4,#C13584,#E1306C,#FD1D1D);padding:18px;border-radius:16px;display:flex;flex-direction:column;align-items:center;gap:12px}
    .stories-card h2{margin:0;font-size:20px}
    .stories-img{width:100%;max-width:630px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:3px solid rgba(255,255,255,0.12)}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;width:100%}
    .btn{padding:12px 18px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
    .btn-download{background:linear-gradient(135deg,#28a745,#20c997);color:#fff}
    .btn-instagram{background:linear-gradient(135deg,#405DE6,#833AB4,#FD1D1D);color:#fff}
    .photo-card{background:rgba(255,255,255,0.04);padding:14px;border-radius:12px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .photo-card img{width:100%;max-width:360px;border-radius:10px;border:3px solid rgba(255,255,255,0.06)}
    .photo-actions{display:flex;gap:8px;flex-direction:column;align-items:center}
    .loading{color:#ddd;padding:40px;text-align:center}
    .no-photos{color:#ddd;padding:40px;text-align:center}
    footer{margin-top:28px;color:#cbd5e1;opacity:0.9;font-size:13px;text-align:center}
    @media (max-width:680px){
      .stories-img{max-width:100%}
      .photo-card img{max-width:100%}
      .btn-row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>üì∏ Suas Fotos</h1>
        <div class="expiry">ID da sess√£o: <strong id="viewerIdDisplay">‚Äî</strong></div>
      </div>
      <div class="sub">Baixe suas fotos ‚Äî ficar√£o dispon√≠veis por 7 dias</div>
    </div>

    <div id="gallery" class="gallery">
      <div class="loading">üîÑ Carregando suas fotos...</div>
    </div>

    <footer>Visualizador ‚Äî pegue suas fotos e compartilhe üéâ</footer>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const viewerId = params.get("viewerId");
  const gallery = document.getElementById("gallery");
  const viewerIdDisplay = document.getElementById("viewerIdDisplay");

  // Important: use the project's backend
  const SERVER = "https://festadodavi-production-0591.up.railway.app";
  const socket = io(SERVER, { transports: ['websocket','polling'], path: '/socket.io' });

  viewerIdDisplay.textContent = viewerId || '‚Äî';

  let currentPhotos = [];
  let currentStories = null;

  // show text
  function showLoading(msg){ gallery.innerHTML = `<div class="loading">${msg}</div>`; }
  function showNoPhotos(msg){ gallery.innerHTML = `<div class="no-photos">${msg}</div>`; }

  if (!viewerId) {
    showNoPhotos("‚ùå ID de visualizador n√£o encontrado na URL. Verifique o QR ou pe√ßa ao operador.");
    throw new Error("viewerId missing");
  }

  // Connector: request the server for the viewer payload, but also listen for push
  socket.on('connect', () => {
    console.log('visualizador socket connected', socket.id);
    // tell server who we are; server should respond by emitting 'viewer_photos_ready' to this socket or broadcast
    socket.emit('viewer_join', { viewerId });
    // also proactively ask in case server requires request
    socket.timeout(5000).emit('request_viewer_session', { viewerId }, (err, resp) => {
      if (err) {
        // timed out or no response ‚Äî we'll wait for pushed event
        console.log('request_viewer_session timeout/no-response', err);
      } else {
        if (resp && resp.photos) {
          // server returned data
          processIncoming({ photos: resp.photos, storiesMontage: resp.storiesMontage || resp.stories });
        }
      }
    });
  });

  socket.on('disconnect', () => console.log('visualizador socket disconnected'));

  // Server should emit 'viewer_photos_ready' with payload { viewerId, photos:[], storiesMontage? }
  socket.on('viewer_photos_ready', (payload) => {
    console.log('viewer_photos_ready', payload);
    if (!payload || payload.viewerId !== viewerId) return;
    processIncoming(payload);
  });

  // Some servers may emit 'photos_ready' with session info and visualizadorUrl; handle generic shapes
  socket.on('photos_ready', (payload) => {
    console.log('photos_ready', payload);
    if (!payload) return;
    // if server includes viewerId or visualizador link, try to extract photos
    if (payload.session && payload.uploaded && Array.isArray(payload.uploaded)) {
      // fallback: not viewer-specific, but show uploaded urls if any
      processIncoming({ photos: payload.uploaded, storiesMontage: payload.storiesMontage || null });
    }
  });

  // fallback: operator created a viewer session and emits 'viewer_session_created' with viewerId and photos
  socket.on('viewer_session_created', (payload) => {
    console.log('viewer_session_created', payload);
    if (!payload) return;
    if (payload.viewerId === viewerId && payload.photos) processIncoming({ photos: payload.photos, storiesMontage: payload.storiesMontage || null });
  });

  // If the server sends 'show_qr' or similar with a URL, ignore here (visualizador just shows photos)

  function processIncoming(payload){
    if (!payload || !Array.isArray(payload.photos) || payload.photos.length === 0) {
      showNoPhotos("üì∑ Nenhuma foto dispon√≠vel no momento.");
      return;
    }
    currentPhotos = payload.photos.slice(0,3);
    currentStories = payload.storiesMontage || payload.stories || null;
    renderGallery();
  }

  function renderGallery(){
    gallery.innerHTML = '';
    // STORIES first (if exists)
    if (currentStories) {
      const storiesCard = document.createElement('div');
      storiesCard.className = 'stories-card';
      const title = document.createElement('h2');
      title.textContent = 'üì± Pronto para o Instagram';
      const img = document.createElement('img');
      img.className = 'stories-img';
      img.src = currentStories;
      img.alt = 'Stories pronto';
      storiesCard.appendChild(title);
      storiesCard.appendChild(img);

      const row = document.createElement('div');
      row.className = 'btn-row';
      const btnInsta = document.createElement('button');
      btnInsta.className = 'btn btn-instagram';
      btnInsta.innerHTML = 'üì≤ Baixar pronto pro Instagram';
      btnInsta.addEventListener('click', () => downloadImage(currentStories, `stories-${viewerId}.jpg`));
      row.appendChild(btnInsta);

      const btnAll = document.createElement('button');
      btnAll.className = 'btn btn-download';
      btnAll.innerHTML = 'üì• Baixar todas as fotos';
      btnAll.addEventListener('click', () => {
        currentPhotos.forEach((p, idx) => {
          setTimeout(()=> downloadImage(p, `foto-${idx+1}.jpg`), idx * 250);
        });
      });
      row.appendChild(btnAll);

      storiesCard.appendChild(row);
      gallery.appendChild(storiesCard);
    }

    // Then individual photos
    currentPhotos.forEach((p, idx) => {
      const card = document.createElement('div');
      card.className = 'photo-card';
      const img = document.createElement('img');
      img.src = p;
      img.alt = `Foto ${idx+1}`;
      const actions = document.createElement('div');
      actions.className = 'photo-actions';
      const btn = document.createElement('button');
      btn.className = 'btn btn-download';
      btn.textContent = `üì• Baixar Foto ${idx+1}`;
      btn.addEventListener('click', ()=> downloadImage(p, `foto-${idx+1}.jpg`));
      actions.appendChild(btn);
      card.appendChild(img);
      card.appendChild(actions);
      gallery.appendChild(card);
    });

    // small note
    const note = document.createElement('div');
    note.style.textAlign = 'center';
    note.style.opacity = '0.9';
    note.style.marginTop = '6px';
    note.textContent = 'Se quiser baixar todas de uma vez, use o bot√£o "Baixar todas as fotos" acima.';
    gallery.appendChild(note);
  }

  // download helper
  function downloadImage(dataUrl, filename){
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // If after 5s nothing arrived, show message
  setTimeout(() => {
    if (!currentPhotos.length) {
      showNoPhotos('‚ùå N√£o foi poss√≠vel carregar as fotos. Pe√ßa ao operador gerar o visualizador para voc√™ (QR correto).');
    }
  }, 5000);

</script>
</body>
</html>
