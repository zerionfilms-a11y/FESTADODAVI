<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>üì∏ Suas Fotos ‚Äî Visualizador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Arial,Helvetica,sans-serif;
      background:linear-gradient(135deg,#1a1a2e,#16213e);
      color:#fff;
      min-height:100vh;
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .session-info{
      background:rgba(255,255,255,0.06);
      padding:18px;
      border-radius:16px;
      width:100%;
      max-width:760px;
      text-align:center;
      backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,0.04);
      margin-bottom:16px;
    }
    .session-info h1{font-size:28px;margin-bottom:6px}
    .session-info p{opacity:0.9;margin-bottom:6px}
    .expiry-info{
      background:rgba(255,193,7,0.12);
      padding:10px;
      border-radius:10px;
      margin-top:8px;
      color:#fff;
      border:1px solid rgba(255,193,7,0.15)
    }
    .gallery{
      width:100%;
      max-width:760px;
      display:flex;
      flex-direction:column;
      gap:20px;
      margin-top:12px;
    }
    .photo-container{
      background:rgba(255,255,255,0.04);
      padding:16px;
      border-radius:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      border:1px solid rgba(255,255,255,0.03);
    }
    .stories-container{
      border-radius:16px;
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      background:linear-gradient(135deg,#833AB4,#C13584,#E1306C,#FD1D1D);
    }
    .stories-title{
      font-size:20px;
      font-weight:800;
      text-align:center;
    }
    img{
      max-width:100%;
      height:auto;
      border-radius:12px;
      border:3px solid rgba(255,255,255,0.12);
      box-shadow:0 8px 30px rgba(0,0,0,0.4);
    }
    .download-all-btn{
      padding:14px 18px;
      border-radius:12px;
      background:linear-gradient(135deg,#0b84ff,#0066cc);
      color:#fff;
      border:0;
      font-weight:800;
      cursor:pointer;
      margin-bottom:12px;
    }
    .instagram-btn{
      padding:12px 16px;
      border-radius:12px;
      background:linear-gradient(135deg,#405DE6,#833AB4,#E1306C);
      color:#fff;
      border:0;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      max-width:320px;
    }
    .download-btn{
      padding:10px 14px;
      border-radius:10px;
      background:linear-gradient(135deg,#28a745,#20c997);
      color:#fff;
      border:0;
      font-weight:700;
      cursor:pointer;
      width:100%;
      max-width:300px;
    }
    .no-photos{
      padding:28px;
      text-align:center;
      color:#ddd;
    }
    .meta { font-size:13px; opacity:0.9; margin-top:8px; color:#dfe; }
    @media (max-width:480px){
      .session-info h1{font-size:22px}
      .download-all-btn,.instagram-btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="session-info">
    <h1>üì∏ Suas Fotos</h1>
    <p><strong>Sess√£o:</strong> <span id="viewerIdDisplay">‚Äî</span></p>
    <div class="expiry-info">‚è∞ Estas fotos ficar√£o dispon√≠veis por 7 dias</div>
  </div>

  <button id="downloadAllBtn" class="download-all-btn" style="display:none">üì• Baixar Todas as Fotos</button>

  <div id="gallery" class="gallery">
    <div class="no-photos">üîÑ Aguardando suas fotos...</div>
  </div>

<script>
  (function(){
    const params = new URLSearchParams(window.location.search);
    // accept viewer param (preferred) or session param (legacy / operator sometimes uses session=<viewerId>)
    const viewerParam = params.get('viewer');
    const sessionParam = params.get('session');
    const session = viewerParam || sessionParam || null;

    const viewerIdDisplay = document.getElementById('viewerIdDisplay');
    const gallery = document.getElementById('gallery');
    const downloadAllBtn = document.getElementById('downloadAllBtn');

    viewerIdDisplay.textContent = session || '‚Äî';

    const BACKEND = (location.origin.indexOf('localhost') !== -1) ? location.origin : 'https://festadodavi-production-0591.up.railway.app';
    const socket = io(BACKEND, { transports:['websocket','polling'], path:'/socket.io' });

    let currentPhotos = [];
    let currentStories = null;
    let receivedAny = false;

    socket.on('connect', () => {
      console.log('‚úÖ Conectado ao servidor:', socket.id);
      // Try to join viewer room both ways for compatibility with different server implementations
      if (session) {
        // older code used 'viewer_join' with session param; server implementation may expect 'join_viewer' with viewerId
        try { socket.emit('viewer_join', { session }); } catch(e){}
        try { socket.emit('join_viewer', { viewerId: session }); } catch(e){}
        try { socket.emit('join_session', { session, role: 'viewer' }); } catch(e){}
      }
    });

    // Accept multiple event names for compatibility
    socket.on('viewer_photos_ready', (data) => handleViewerPayload(data, 'viewer_photos_ready'));
    socket.on('photos_ready', (data) => handleViewerPayload(data, 'photos_ready'));
    socket.on('photos_submit_saved', (data) => handleViewerPayload(data, 'photos_submit_saved'));
    socket.on('photos_submit', (data) => handleViewerPayload(data, 'photos_submit'));
    // fallback show_qr maybe useful
    socket.on('show_qr', (data) => {
      // sometimes server sends { visualizadorUrl } - we can show it as an image tile
      if (!data) return;
      console.log('show_qr', data);
      if (data.visualizadorUrl) {
        // Show a small link tile so visitor can open in new tab
        gallery.innerHTML = '';
        const tile = document.createElement('div');
        tile.className = 'photo-container';
        tile.innerHTML = `<div class="meta">Abrir visualizador:</div><a href="${data.visualizadorUrl}" target="_blank" rel="noopener" style="color:#fff;word-break:break-all">${data.visualizadorUrl}</a>`;
        gallery.appendChild(tile);
      }
    });

    function handleViewerPayload(payload, src){
      console.log('üì• payload via', src, payload);
      try {
        // server sometimes doesn't include session/viewer fields; be permissive
        // Accept payload that contains photos array or storiesMontage / storiesUrl
        if(!payload) return;
        let photos = Array.isArray(payload.photos) ? payload.photos : (Array.isArray(payload.uploaded) ? payload.uploaded : []);
        // older flows might put photos in payload.data or payload.photosArray
        if ((!photos || photos.length === 0) && Array.isArray(payload.photosArray)) photos = payload.photosArray;

        const stories = payload.storiesMontage || payload.storiesUrl || payload.stories || null;
        const printUrl = payload.print || null;
        // If server included viewer id, update display
        if (payload.viewerId) viewerIdDisplay.textContent = payload.viewerId;
        if (payload.session && !session) viewerIdDisplay.textContent = payload.session;

        currentPhotos = (photos || []).slice(0,3);
        currentStories = stories || null;
        receivedAny = true;
        renderGallery(currentPhotos, currentStories, printUrl);
        if (currentPhotos.length) downloadAllBtn.style.display = 'block';
      } catch(e){
        console.error('Erro handleViewerPayload', e);
      }
    }

    function renderGallery(photos, storiesMontage, printUrl){
      gallery.innerHTML = '';

      // show story montage first if present
      if (storiesMontage) {
        const storiesContainer = document.createElement('div');
        storiesContainer.className = 'photo-container stories-container';
        const title = document.createElement('div');
        title.className = 'stories-title';
        title.textContent = 'üì± Pronto para o Instagram';
        const img = document.createElement('img');
        img.src = storiesMontage;
        img.alt = 'Stories Pronto';
        img.loading = 'lazy';

        const instagramBtn = document.createElement('button');
        instagramBtn.className = 'instagram-btn';
        instagramBtn.innerHTML = 'üì• Baixar Pronto pro Instagram';
        instagramBtn.onclick = () => downloadImageForced(storiesMontage, `pronto-instagram-${session || Date.now()}.jpg`);

        storiesContainer.appendChild(title);
        storiesContainer.appendChild(img);
        storiesContainer.appendChild(instagramBtn);
        gallery.appendChild(storiesContainer);
      }

      if (!Array.isArray(photos) || photos.length === 0) {
        if (!storiesMontage) gallery.innerHTML = `<div class="no-photos">üì∑ Nenhuma foto dispon√≠vel no momento.</div>`;
        return;
      }

      photos.forEach((p, idx) => {
        const container = document.createElement('div');
        container.className = 'photo-container';
        const img = document.createElement('img');
        img.src = p;
        img.alt = `Foto ${idx+1}`;
        img.loading = 'lazy';

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'download-btn';
        downloadBtn.textContent = `üì• Baixar Foto ${idx+1}`;
        downloadBtn.onclick = () => downloadImageForced(p, `foto-${idx+1}.jpg`);

        container.appendChild(img);
        container.appendChild(downloadBtn);
        gallery.appendChild(container);
      });
    }

    // Force download: if data: URL ‚Üí direct anchor; if remote URL ‚Üí fetch blob then download (works better to avoid opening Imgbb link)
    async function downloadImageForced(url, filename){
      if (!url) return alert('URL inv√°lida.');
      try {
        if (url.startsWith('data:')) {
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          return;
        }
        // Attempt to fetch the file and download as blob
        const res = await fetch(url, { mode:'cors' });
        if (!res.ok) throw new Error('Falha ao baixar: ' + res.status);
        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = objectUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        // cleanup
        setTimeout(() => { URL.revokeObjectURL(objectUrl); }, 30000);
      } catch (err) {
        console.warn('downloadImageForced fallback', err);
        // fallback: open in new tab so user can save manually
        window.open(url, '_blank', 'noopener');
      }
    }

    downloadAllBtn.addEventListener('click', () => {
      if (!currentPhotos || currentPhotos.length === 0) return;
      currentPhotos.forEach((p,i) => {
        setTimeout(()=>downloadImageForced(p,`foto-${i+1}.jpg`), i*300);
      });
      alert('üì• Download de todas as fotos iniciado!');
    });

    // fallback timeout: if nothing received after a few seconds, show helpful message (don't block if we already received)
    setTimeout(()=> {
      if (!receivedAny) {
        gallery.innerHTML = `<div class="no-photos">‚ùå N√£o foi poss√≠vel carregar as fotos. Verifique a sess√£o (session param na URL).</div>`;
      }
    }, 7000);

    // safety: listen for explicit disconnect / reset from server
    socket.on('reset_session', () => {
      gallery.innerHTML = `<div class="no-photos">üîÅ Sess√£o reiniciada pelo operador.</div>`;
      downloadAllBtn.style.display = 'none';
      currentPhotos = [];
      currentStories = null;
    });

  })();
</script>
</body>
</html>
