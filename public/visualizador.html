<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Suas Fotos üì∏</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;display:flex;flex-direction:column;align-items:center;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;font-family:Arial,Helvetica,sans-serif;padding:18px}
    .container{width:100%;max-width:820px}
    .session-info{background:rgba(255,255,255,0.06);padding:20px;border-radius:16px;text-align:center;margin-bottom:18px;border:1px solid rgba(255,255,255,0.04)}
    .session-info h1{font-size:26px;margin-bottom:6px}
    .expiry-info{background:rgba(255,193,7,0.12);padding:10px;border-radius:10px;margin-top:10px;color:#fff;border:1px solid rgba(255,193,7,0.18)}
    .download-all-btn{display:none;margin:14px 0;padding:14px;border-radius:12px;border:0;background:linear-gradient(135deg,#007bff,#0056b3);font-weight:700;color:#fff;cursor:pointer;width:100%}
    .gallery{display:flex;flex-direction:column;gap:20px}
    .photo-container{background:rgba(255,255,255,0.03);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center}
    .stories-container{padding:18px;border-radius:14px;display:flex;flex-direction:column;align-items:center;gap:12px;background:linear-gradient(135deg,#833AB4,#C13584,#E1306C,#FD1D1D)}
    .stories-title{font-size:20px;font-weight:800;color:#fff}
    img.responsive{width:100%;max-width:420px;border-radius:12px;border:3px solid rgba(255,255,255,0.12);object-fit:cover}
    .download-btn{padding:12px 18px;border-radius:10px;border:0;background:linear-gradient(135deg,#28a745,#20c997);color:#fff;font-weight:700;cursor:pointer;margin-top:8px}
    .instagram-btn{padding:12px 18px;border-radius:12px;border:0;background:linear-gradient(135deg,#405DE6,#5851DB,#833AB4,#C13584,#E1306C,#FD1D1D);color:#fff;font-weight:800;cursor:pointer;display:flex;gap:10px;align-items:center}
    .no-photos{color:#ccc;padding:24px;text-align:center}
    @media(max-width:480px){
      .session-info h1{font-size:20px}
      .download-all-btn{padding:12px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="session-info" id="sessionInfo">
      <h1>üì∏ Suas Fotos</h1>
      <p>Sess√£o: <span id="viewerIdDisplay">‚Äî</span></p>
      <div class="expiry-info">‚è∞ Estas fotos ficar√£o dispon√≠veis por 7 dias</div>
    </div>

    <button id="downloadAllBtn" class="download-all-btn">üì• Baixar todas as fotos</button>

    <div id="gallery" class="gallery">
      <div class="no-photos" id="loading">üîÑ Carregando suas fotos...</div>
    </div>
  </div>

<script>
  (function(){
    const BASE = location.origin.replace(/\/+$/,'') || window.location.origin;
    // viewerId pode vir pela path /visualizador/:viewerId
    const pathParts = location.pathname.split('/').filter(Boolean);
    // URL exemplos:
    // /visualizador/<viewerId> -> pathParts = ['visualizador', '<viewerId>']
    let viewerId = null;
    if (pathParts.length >= 2 && pathParts[0] === 'visualizador') viewerId = pathParts[1];
    else {
      // fallback para ?viewerId=
      const params = new URLSearchParams(location.search);
      viewerId = params.get('viewerId');
    }

    const viewerIdDisplay = document.getElementById('viewerIdDisplay');
    const gallery = document.getElementById('gallery');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const loading = document.getElementById('loading');

    viewerIdDisplay.textContent = viewerId || '‚Äî';

    if (!viewerId) {
      gallery.innerHTML = '<div class="no-photos">‚ùå ID do visualizador n√£o encontrado na URL.</div>';
      loading && loading.remove();
      return;
    }

    async function fetchViewerData() {
      try {
        const res = await fetch(BASE + '/api/viewer/' + encodeURIComponent(viewerId));
        if (!res.ok) {
          const text = await res.text();
          console.warn('fetch viewer error', res.status, text);
          gallery.innerHTML = '<div class="no-photos">‚ùå N√£o foi poss√≠vel carregar as fotos. Verifique o ID da sess√£o.</div>';
          loading && loading.remove();
          return;
        }
        const j = await res.json();
        if (!j || !j.ok) {
          gallery.innerHTML = '<div class="no-photos">‚ùå Nenhuma foto dispon√≠vel no momento.</div>';
          loading && loading.remove();
          return;
        }
        renderGallery(j.photos || [], j.storiesMontage || null);
      } catch (e) {
        console.error(e);
        gallery.innerHTML = '<div class="no-photos">‚ùå Erro ao carregar. Tente novamente.</div>';
      } finally {
        loading && loading.remove();
      }
    }

    function renderGallery(photos, storiesMontage) {
      gallery.innerHTML = '';
      // stories first
      if (storiesMontage) {
        const storiesContainer = document.createElement('div');
        storiesContainer.className = 'photo-container stories-container';
        const title = document.createElement('div');
        title.className = 'stories-title';
        title.textContent = 'üì± Pronto para o Instagram';
        const img = document.createElement('img');
        img.className = 'responsive';
        img.src = storiesMontage;
        img.alt = 'Pronto para o Instagram';
        const instagramBtn = document.createElement('button');
        instagramBtn.className = 'instagram-btn';
        instagramBtn.innerHTML = '<span>üì• Baixar Pronto pro Instagram</span>';
        instagramBtn.onclick = () => downloadImage(storiesMontage, `pronto-instagram-${viewerId}.jpg`);
        storiesContainer.appendChild(title);
        storiesContainer.appendChild(img);
        storiesContainer.appendChild(instagramBtn);
        gallery.appendChild(storiesContainer);
      }

      if (!Array.isArray(photos) || photos.length === 0) {
        const no = document.createElement('div');
        no.className = 'no-photos';
        no.textContent = 'üì∑ Nenhuma foto dispon√≠vel no momento.';
        gallery.appendChild(no);
        downloadAllBtn.style.display = 'none';
        return;
      }

      photos.forEach((p, idx) => {
        const c = document.createElement('div');
        c.className = 'photo-container';
        const img = document.createElement('img');
        img.className = 'responsive';
        img.src = p;
        img.alt = `Foto ${idx+1}`;
        const btn = document.createElement('button');
        btn.className = 'download-btn';
        btn.textContent = `üì• Baixar Foto ${idx+1}`;
        btn.onclick = () => downloadImage(p, `foto-${idx+1}.jpg`);
        c.appendChild(img);
        c.appendChild(btn);
        gallery.appendChild(c);
      });

      downloadAllBtn.style.display = 'block';
      downloadAllBtn.onclick = () => {
        photos.forEach((p, i) => {
          setTimeout(() => downloadImage(p, `foto-${i+1}.jpg`), i * 250);
        });
      };
    }

    function downloadImage(dataUrl, filename) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // try fetch
    fetchViewerData();

    // fallback message if nothing after 6s
    setTimeout(() => {
      if (gallery.children.length === 0) {
        gallery.innerHTML = '<div class="no-photos">‚ùå N√£o foi poss√≠vel carregar as fotos. Verifique o ID da sess√£o.</div>';
      }
    }, 6000);
  })();
</script>
</body>
</html>
