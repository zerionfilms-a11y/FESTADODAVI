<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>üì∏ Suas Fotos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    :root{
      --bg1: #1a1a2e;
      --bg2: #16213e;
      --glass: rgba(255,255,255,0.06);
      --accent: linear-gradient(135deg,#405DE6,#C13584,#FD1D1D);
      --card: rgba(255,255,255,0.05);
      --muted: #bfc9d6;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100vh;
      font-family: Inter, Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px;
    }

    .page {
      width:100%;
      max-width:980px;
    }

    .hero {
      position:relative;
      border-radius:14px;
      overflow:hidden;
      background: url('iniciar.png') center/cover no-repeat;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      padding:22px;
      margin-bottom:18px;
      border:1px solid rgba(255,255,255,0.04);
    }

    .hero-inner {
      background: linear-gradient(180deg, rgba(0,0,0,0.36), rgba(0,0,0,0.18));
      padding:18px;
      border-radius:12px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      backdrop-filter: blur(6px);
    }

    .title-block h1{
      font-size:26px;
      margin-bottom:6px;
    }
    .title-block p{color:var(--muted);font-size:14px}

    .hero-actions{
      display:flex;
      gap:12px;
      align-items:center;
    }

    button.big{
      background:var(--accent);
      border:0;
      color:#fff;
      padding:14px 18px;
      border-radius:12px;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,0.35);
    }

    button.ghost{
      background:transparent;
      color:#fff;
      border:1px solid rgba(255,255,255,0.08);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
    }

    .expiry{
      margin-top:10px;
      font-size:13px;
      color: #ffe7b0;
      background: rgba(255,193,7,0.08);
      padding:8px 10px;border-radius:8px;border:1px solid rgba(255,193,7,0.12);
      display:inline-block;
    }

    .gallery {
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .stories-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:18px;
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      border:1px solid rgba(255,255,255,0.03);
    }

    .stories-preview{
      width:100%;
      max-width:520px;
      border-radius:12px;
      overflow:hidden;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:260px;
    }

    .stories-preview img{width:100%;height:auto;display:block}

    .stories-actions{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      min-width:220px;
    }

    .photo-card{
      background:var(--card);
      padding:14px;
      border-radius:12px;
      display:flex;
      gap:14px;
      align-items:center;
      border:1px solid rgba(255,255,255,0.03);
    }

    .photo-thumb{width:120px;height:120px;flex:0 0 120px;border-radius:10px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
    .photo-thumb img{width:100%;height:100%;object-fit:cover;display:block}

    .photo-info{flex:1;display:flex;flex-direction:column;gap:8px}
    .photo-info .label{font-weight:700}
    .photo-info .sub{color:var(--muted);font-size:13px}

    .photo-actions{display:flex;gap:10px;align-items:center}
    .btn-download{
      background: linear-gradient(135deg,#28a745,#20c997);
      padding:10px 14px;border-radius:10px;border:0;color:#fff;font-weight:800;cursor:pointer;
    }

    .no-photos{padding:22px;border-radius:12px;text-align:center;color:#ddd;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}

    footer.note{margin-top:16px;color:var(--muted);text-align:center;font-size:13px}

    @media (max-width:820px){
      .hero-inner{flex-direction:column;align-items:flex-start}
      .stories-actions{min-width:unset;flex-direction:row}
      .photo-card{flex-direction:column;align-items:flex-start}
      .photo-thumb{width:100%;height:auto;aspect-ratio:1/1}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="hero" role="banner" aria-label="Suas Fotos - Cabe√ßalho com fundo">
      <div class="hero-inner">
        <div class="title-block">
          <h1>üì∏ Suas Fotos</h1>
          <p id="sessionLine">Sess√£o: <span id="viewerIdDisplay">‚Äî</span></p>
          <div class="expiry">‚è∞ Estas fotos ficar√£o dispon√≠veis por 7 dias</div>
        </div>

        <div class="hero-actions">
          <button id="downloadAllBtn" class="big" style="display:none">üì• Baixar todas</button>
          <button id="openGalleryBtn" class="ghost">Abrir galeria</button>
        </div>
      </div>
    </div>

    <div id="gallery" class="gallery" aria-live="polite">
      <div class="no-photos" id="loadingBox">üîÑ Carregando suas fotos...</div>
    </div>

    <footer class="note">Baixe e compartilhe ‚Äî use como quiser. Se precisar, pe√ßa pro operador regenerar a sess√£o.</footer>
  </div>

<script>
/* visualizador.html (entrega do usu√°rio) - comportamento:
   - Conecta via socket ao backend
   - Espera evento 'viewer_photos_ready' com payload { viewerId?, photos: [dataURL,...], storiesMontage?: url }
   - Se storiesMontage dispon√≠vel: usa direto
   - Senao: monta stories localmente usando storiesdavi.png + moldura.png + posicionamento das 3 fotos
   - Mostra bot√£o para baixar montagem e bot√µes para cada foto
*/

const params = new URLSearchParams(location.search);
const viewerId = params.get('viewerId') || params.get('viewer') || params.get('id') || null;
const viewerIdDisplay = document.getElementById('viewerIdDisplay');
const gallery = document.getElementById('gallery');
const loadingBox = document.getElementById('loadingBox');
const downloadAllBtn = document.getElementById('downloadAllBtn');

viewerIdDisplay.textContent = viewerId || '‚Äî';

// BACKEND CONFIG - ajuste se necess√°rio
const BACKEND = (location.origin && location.origin !== 'null') ? location.origin : 'https://festadodavi-production-0591.up.railway.app';
// prefer explicit if you want: const BACKEND = 'https://festadodavi.onrender.com';

const socket = io(BACKEND, { transports: ['websocket','polling'], path:'/socket.io' });

let currentPhotos = [];
let currentStoriesMontage = null;

function clearGallery(){
  gallery.innerHTML = '';
}

// Utility to force download a dataURL or URL
function downloadToFilename(urlOrData, filename){
  const a = document.createElement('a');
  a.style.display = 'none';
  a.href = urlOrData;
  a.download = filename || 'download';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=> { document.body.removeChild(a); }, 150);
}

// draw cover-style (like object-fit: cover) into canvas area
function drawImageCover(ctx, img, x, y, w, h){
  const imgRatio = img.width / img.height;
  const boxRatio = w / h;
  let sx = 0, sy = 0, sw = img.width, sh = img.height;
  if (imgRatio > boxRatio) {
    // image wider than box -> cut sides
    sw = img.height * boxRatio;
    sx = (img.width - sw) / 2;
  } else {
    // image taller -> cut top/bottom
    sh = img.width / boxRatio;
    sy = (img.height - sh) / 2;
  }
  ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
}

// build stories montage on canvas (sizes: 3375 x 6000)
// coords given by user:
// areas: (366,203)-(2997,1657), (363,1773)-(2997,3227), (363,3346)-(2997,4794)
async function buildStoriesMontage(photosArray){
  // ensure we have three photos
  const photos = (Array.isArray(photosArray) ? photosArray.slice(0,3) : []).slice();
  while (photos.length < 3) photos.push(photos[photos.length-1] || photos[0] || null);

  const W = 3375, H = 6000;
  const canvas = document.createElement('canvas');
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');

  // load background stories template
  const bg = new Image();
  bg.crossOrigin = "anonymous";
  bg.src = 'storiesdavi.png';
  await new Promise((res, rej) => {
    bg.onload = res; bg.onerror = ()=>{ console.warn('storiesdavi.png not found or failed to load'); res(); };
  });

  // draw background (if loaded) or fill
  if (bg.complete && bg.naturalWidth) {
    ctx.drawImage(bg, 0, 0, W, H);
  } else {
    ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H);
  }

  // positions from your spec
  const coords = [
    { x: 366, y: 203, x2:2997, y2:1657 },
    { x: 363, y: 1773, x2:2997, y2:3227 },
    { x: 363, y: 3346, x2:2997, y2:4794 }
  ];

  // draw each photo into area (cover)
  for (let i=0;i<3;i++){
    const p = photos[i];
    if(!p) continue;
    try {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = p;
      await new Promise((res, rej) => { img.onload = res; img.onerror = ()=>{ console.warn('photo load failed', i); res(); }; });
      const c = coords[i];
      const w = c.x2 - c.x;
      const h = c.y2 - c.y;
      drawImageCover(ctx, img, c.x, c.y, w, h);
    } catch(e){ console.warn('error drawing photo', e); }
  }

  // overlay moldura.png if exists
  const frame = new Image();
  frame.crossOrigin = "anonymous";
  frame.src = 'moldura.png';
  await new Promise((res)=>{ frame.onload = ()=>res(); frame.onerror = ()=>res(); });

  if (frame.complete && frame.naturalWidth) {
    ctx.drawImage(frame, 0, 0, W, H);
  }

  // export as jpeg
  try {
    const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
    return dataUrl;
  } catch(e){
    console.error('toDataURL error', e);
    return null;
  }
}

// Render UI
function renderGallery(photos, storiesMontageUrl){
  clearGallery();

  // stories block (if storiesMontageUrl or can be generated)
  const storiesExists = !!storiesMontageUrl || (Array.isArray(photos) && photos.length > 0);
  if (storiesExists){
    const card = document.createElement('div');
    card.className = 'stories-card';

    const preview = document.createElement('div');
    preview.className = 'stories-preview';
    preview.setAttribute('aria-hidden', 'false');

    const imageEl = document.createElement('img');
    imageEl.alt = 'Pronto para o Instagram';
    imageEl.loading = 'lazy';
    preview.appendChild(imageEl);

    const actions = document.createElement('div');
    actions.className = 'stories-actions';

    const title = document.createElement('div');
    title.style.fontWeight = '800';
    title.style.fontSize = '16px';
    title.style.textAlign = 'center';
    title.style.color = '#fff';
    title.textContent = 'üì± Pronto para o Instagram';

    const instaBtn = document.createElement('button');
    instaBtn.className = 'big';
    instaBtn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" style="width:24px;height:24px;object-fit:contain;border-radius:0;margin-right:8px"> Baixar Pronto pro Instagram';
    instaBtn.onclick = () => {
      if (currentStoriesMontage) downloadToFilename(currentStoriesMontage, `stories-${viewerId || 'session'}.jpg`);
      else alert('Montagem ainda n√£o pronta, aguarde.');
    };

    const smallNote = document.createElement('div');
    smallNote.style.fontSize = '13px'; smallNote.style.color = 'var(--muted)'; smallNote.style.marginTop = '6px';
    smallNote.textContent = 'Baixe a montagem (com moldura) otimizada para Instagram Stories.';

    actions.appendChild(title);
    actions.appendChild(instaBtn);
    actions.appendChild(smallNote);

    card.appendChild(preview);
    card.appendChild(actions);
    gallery.appendChild(card);

    // set preview image (if storiesMontageUrl provided use it, else will be generated)
    if (storiesMontageUrl) {
      imageEl.src = storiesMontageUrl;
      currentStoriesMontage = storiesMontageUrl;
      downloadAllBtn.style.display = currentPhotos.length ? 'inline-flex' : 'none';
    } else {
      // set placeholder & generate montage
      imageEl.src = '';
      imageEl.alt = 'Gerando montagem...';
      const loader = document.createElement('div');
      loader.textContent = 'üîÑ Gerando montagem...';
      loader.style.color = '#ddd';
      loader.style.padding = '6px';
      preview.innerHTML = '';
      preview.appendChild(loader);

      // generate montage
      buildStoriesMontage(photos).then((dataUrl) => {
        currentStoriesMontage = dataUrl;
        preview.innerHTML = '';
        imageEl.src = dataUrl;
        preview.appendChild(imageEl);
        downloadAllBtn.style.display = currentPhotos.length ? 'inline-flex' : 'none';
      }).catch((e)=>{
        preview.innerHTML = '<div style="color:#ddd">Erro ao gerar montagem</div>';
        console.error(e);
      });
    }
  }

  // individual photos
  if (!Array.isArray(photos) || photos.length === 0) {
    const no = document.createElement('div');
    no.className = 'no-photos';
    no.textContent = 'üì∑ Nenhuma foto dispon√≠vel no momento.';
    gallery.appendChild(no);
    downloadAllBtn.style.display = 'none';
    return;
  }

  photos.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = 'photo-card';

    const thumb = document.createElement('div');
    thumb.className = 'photo-thumb';
    const img = document.createElement('img');
    img.src = p;
    img.alt = `Foto ${idx+1}`;
    thumb.appendChild(img);

    const info = document.createElement('div');
    info.className = 'photo-info';
    const label = document.createElement('div'); label.className = 'label'; label.textContent = `Foto ${idx+1}`;
    const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = 'Clique em baixar para salvar';

    info.appendChild(label);
    info.appendChild(sub);

    const actions = document.createElement('div');
    actions.className = 'photo-actions';
    const dl = document.createElement('button');
    dl.className = 'btn-download';
    dl.textContent = `üì• Baixar Foto ${idx+1}`;
    dl.onclick = () => downloadToFilename(p, `foto-${idx+1}-${viewerId || 'session'}.jpg`);

    actions.appendChild(dl);

    card.appendChild(thumb);
    card.appendChild(info);
    card.appendChild(actions);

    gallery.appendChild(card);
  });

  // show "download all" button
  if (currentPhotos.length > 0) {
    downloadAllBtn.style.display = 'inline-flex';
  } else {
    downloadAllBtn.style.display = 'none';
  }
}

// socket events
socket.on('connect', () => {
  console.log('socket connected', socket.id);
  // if viewerId present, ask to join viewer room or inform server
  if (viewerId) {
    socket.emit('join_viewer', { viewerId });
  } else {
    // no viewerId ‚Äî try to request latest for session? We still listen for events.
    console.warn('Nenhum viewerId na URL ‚Äî aguardando evento viewer_photos_ready.');
  }
});

// primary event: viewer_photos_ready
// payload expected: { viewerId?, photos: [dataURL,...], storiesMontage?: url }
socket.on('viewer_photos_ready', (payload) => {
  console.log('viewer_photos_ready', payload);
  try {
    if (!payload) return;
    // if payload has viewerId and doesn't match current viewerId, ignore (unless no viewerId set)
    if (payload.viewerId && viewerId && payload.viewerId !== viewerId) return;
    // accept
    const photos = Array.isArray(payload.photos) ? payload.photos.slice(0,3) : [];
    currentPhotos = photos;
    currentStoriesMontage = payload.storiesMontage || null;
    document.getElementById('loadingBox')?.remove();
    renderGallery(currentPhotos, currentStoriesMontage);
  } catch (e) {
    console.error('Erro processando viewer_photos_ready', e);
  }
});

// fallback event names some servers may use:
socket.on('photos_from_cell', (payload) => {
  console.log('photos_from_cell (visualizador)', payload);
  try {
    const photos = Array.isArray(payload.photos) ? payload.photos.slice(0,3) : [];
    currentPhotos = photos;
    document.getElementById('loadingBox')?.remove();
    renderGallery(currentPhotos, null);
  } catch(e){ console.error(e); }
});

// server might send a direct url for stories (photos ready)
socket.on('photos_ready', (payload) => {
  console.log('photos_ready', payload);
  try {
    // payload.uploaded may be array of URLs, payload.visualizadorUrl etc.
    // Some servers include 'storiesMontage' here ‚Äî we check
    const photos = Array.isArray(payload.uploaded) ? payload.uploaded.slice(0,3) : (Array.isArray(payload.photos) ? payload.photos.slice(0,3) : []);
    if (photos.length) currentPhotos = photos;
    if (payload.storiesMontage) currentStoriesMontage = payload.storiesMontage;
    document.getElementById('loadingBox')?.remove();
    renderGallery(currentPhotos, currentStoriesMontage);
  } catch(e){ console.error(e); }
});

// safe defaults / errors
setTimeout(() => {
  if (!currentPhotos || currentPhotos.length === 0) {
    // leave the loading text for a short time, then show helpful message
    const el = document.getElementById('loadingBox');
    if (el) el.textContent = 'üîÑ Aguardando fotos... Se nada aparecer, pe√ßa ao operador para reenviar a sess√£o.';
  }
}, 3500);

// download all button behavior
downloadAllBtn.addEventListener('click', () => {
  if (!currentPhotos || currentPhotos.length === 0) return alert('Nenhuma foto dispon√≠vel.');
  currentPhotos.forEach((p, i) => {
    setTimeout(() => {
      downloadToFilename(p, `foto-${i+1}-${viewerId || 'session'}.jpg`);
    }, i * 300);
  });
  if (currentStoriesMontage) {
    setTimeout(() => {
      downloadToFilename(currentStoriesMontage, `stories-${viewerId || 'session'}.jpg`);
    }, currentPhotos.length * 350);
  }
  alert('üì• Downloads iniciados (verifique as transfer√™ncias do navegador).');
});
</script>
</body>
</html>
