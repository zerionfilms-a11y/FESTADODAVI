<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>üì∏ Suas Fotos ‚Äî Visualizador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Arial,Helvetica,sans-serif;
      background:linear-gradient(135deg,#1a1a2e,#16213e);
      color:#fff;
      min-height:100vh;
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .session-info{
      background:rgba(255,255,255,0.06);
      padding:18px;
      border-radius:16px;
      width:100%;
      max-width:760px;
      text-align:center;
      backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,0.04);
      margin-bottom:16px;
    }
    .session-info h1{font-size:28px;margin-bottom:6px}
    .session-info p{opacity:0.9;margin-bottom:6px}
    .expiry-info{
      background:rgba(255,193,7,0.12);
      padding:10px;
      border-radius:10px;
      margin-top:8px;
      color:#fff;
      border:1px solid rgba(255,193,7,0.15)
    }
    .gallery{
      width:100%;
      max-width:760px;
      display:flex;
      flex-direction:column;
      gap:20px;
      margin-top:12px;
    }
    .photo-container{
      background:rgba(255,255,255,0.04);
      padding:16px;
      border-radius:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      border:1px solid rgba(255,255,255,0.03);
    }
    .stories-container{
      border-radius:16px;
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      background:linear-gradient(135deg,#833AB4,#C13584,#E1306C,#FD1D1D);
    }
    .stories-title{
      font-size:20px;
      font-weight:800;
      text-align:center;
    }
    img{
      max-width:100%;
      height:auto;
      border-radius:12px;
      border:3px solid rgba(255,255,255,0.12);
      box-shadow:0 8px 30px rgba(0,0,0,0.4);
    }
    .download-all-btn{
      padding:14px 18px;
      border-radius:12px;
      background:linear-gradient(135deg,#0b84ff,#0066cc);
      color:#fff;
      border:0;
      font-weight:800;
      cursor:pointer;
      margin-bottom:12px;
    }
    .instagram-btn{
      padding:12px 16px;
      border-radius:12px;
      background:linear-gradient(135deg,#405DE6,#833AB4,#E1306C);
      color:#fff;
      border:0;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      max-width:320px;
    }
    .download-btn{
      padding:10px 14px;
      border-radius:10px;
      background:linear-gradient(135deg,#28a745,#20c997);
      color:#fff;
      border:0;
      font-weight:700;
      cursor:pointer;
      width:100%;
      max-width:300px;
    }
    .no-photos{
      padding:28px;
      text-align:center;
      color:#ddd;
    }
    .hint-actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center }
    .small-btn { padding:8px 12px; border-radius:8px; background:#222; border:0; color:#fff; cursor:pointer }
    .status-line { margin-top:8px; font-size:13px; color:#ddd; opacity:0.9 }
    .spinner { display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.12);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin { to { transform:rotate(360deg) } }
    @media (max-width:480px){
      .session-info h1{font-size:22px}
      .download-all-btn,.instagram-btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="session-info">
    <h1>üì∏ Suas Fotos</h1>
    <p><strong>Sess√£o / Viewer:</strong> <span id="viewerIdDisplay">‚Äî</span></p>
    <div class="expiry-info">‚è∞ Estas fotos ficar√£o dispon√≠veis por 7 dias</div>
    <div id="status" class="status-line">Aguardando dados do servidor...</div>
  </div>

  <button id="downloadAllBtn" class="download-all-btn" style="display:none">üì• Baixar Todas as Fotos</button>

  <div id="gallery" class="gallery">
    <div class="no-photos">üîÑ Aguardando suas fotos...</div>
  </div>

<script>
  (function(){
    const params = new URLSearchParams(window.location.search);
    const viewerParam = params.get('viewer') || params.get('viewerId') || null;
    const sessionParam = params.get('session') || null;
    const dataParam = params.get('data') || null; // base64 payload fallback
    let session = null;
    let viewerId = null;

    if (viewerParam) {
      viewerId = viewerParam;
    } else if (sessionParam) {
      // heur√≠stica: se parecer viewerId (uuid/long) trate como viewerId, sen√£o como session
      if (sessionParam.indexOf(':') !== -1 || sessionParam.length >= 10) {
        viewerId = sessionParam;
      } else {
        session = sessionParam;
      }
    }

    const viewerIdDisplay = document.getElementById('viewerIdDisplay');
    const gallery = document.getElementById('gallery');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const statusEl = document.getElementById('status');

    viewerIdDisplay.textContent = viewerId || session || '‚Äî';

    const BACKEND = (location.origin.indexOf('localhost') !== -1) ? location.origin : 'https://festadodavi-production-0591.up.railway.app';
    const socket = io(BACKEND, { transports:['websocket','polling'], path:'/socket.io' });

    let currentPhotos = [];
    let currentStories = null;
    let currentPrint = null;
    let receivedViaSocket = false;
    let triedHttpFallback = false;
    let noDataTimer = null;

    function setStatus(txt, loading){
      statusEl.innerHTML = txt + (loading ? ' <span class="spinner"></span>' : '');
    }
    function log(...args){ console.log('[visualizador]', ...args); }

    // Try HTTP fetch to /api/viewer/:viewerId (server persistence) ‚Äî returns viewer payload
    async function httpFetchViewer(vid){
      try {
        if (!vid) return null;
        setStatus('üîé Buscando viewer via HTTP (/api/viewer/' + vid + ')...', true);
        const resp = await fetch(`${BACKEND.replace(/\/+$/,'')}/api/viewer/${encodeURIComponent(vid)}`, { method:'GET', mode:'cors' });
        if (!resp.ok) {
          log('httpFetchViewer not ok', resp.status);
          setStatus('‚ö†Ô∏è /api/viewer retornou ' + resp.status, false);
          return null;
        }
        const j = await resp.json();
        if (!j || !j.ok || !j.viewer) {
          log('httpFetchViewer invalid payload', j);
          setStatus('‚ö†Ô∏è /api/viewer n√£o retornou viewer v√°lido', false);
          return null;
        }
        setStatus('‚úÖ Dados recuperados via HTTP (/api/viewer).', false);
        return j.viewer;
      } catch (e) {
        console.warn('httpFetchViewer error', e);
        setStatus('‚ùå Falha ao buscar /api/viewer (verifique CORS e origem).', false);
        return null;
      }
    }

    function renderGallery(photos, storiesMontage, printUrl){
      gallery.innerHTML = '';
      // stories montage
      if (storiesMontage) {
        const storiesContainer = document.createElement('div');
        storiesContainer.className = 'photo-container stories-container';
        const title = document.createElement('div');
        title.className = 'stories-title';
        title.textContent = 'üì± Pronto para o Instagram';
        const img = document.createElement('img');
        img.src = storiesMontage;
        img.alt = 'Stories Pronto';
        img.loading = 'lazy';
        const instagramBtn = document.createElement('button');
        instagramBtn.className = 'instagram-btn';
        instagramBtn.innerHTML = 'üì• Baixar Pronto pro Instagram';
        instagramBtn.onclick = () => downloadImage(storiesMontage, `pronto-instagram-${Date.now()}.jpg`);
        storiesContainer.appendChild(title);
        storiesContainer.appendChild(img);
        storiesContainer.appendChild(instagramBtn);
        gallery.appendChild(storiesContainer);
      }

      if (!Array.isArray(photos) || photos.length === 0) {
        if (!storiesMontage) gallery.innerHTML = `<div class="no-photos">üì∑ Nenhuma foto dispon√≠vel no momento.</div>`;
        return;
      }

      photos.forEach((p, idx) => {
        const container = document.createElement('div');
        container.className = 'photo-container';
        const img = document.createElement('img');
        img.src = p;
        img.alt = `Foto ${idx+1}`;
        img.loading = 'lazy';
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'download-btn';
        downloadBtn.textContent = `üì• Baixar Foto ${idx+1}`;
        downloadBtn.onclick = () => downloadImage(p, `foto-${idx+1}.jpg`);
        container.appendChild(img);
        container.appendChild(downloadBtn);
        gallery.appendChild(container);
      });
    }

    async function downloadImage(dataUrlOrUrl, filename){
      try {
        if (!dataUrlOrUrl) return;
        if (/^data:/.test(dataUrlOrUrl)) {
          const a = document.createElement('a');
          a.href = dataUrlOrUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          return;
        }
        try {
          const urlObj = new URL(dataUrlOrUrl, location.href);
          const sameOrigin = urlObj.origin === location.origin;
          if (sameOrigin) {
            const a = document.createElement('a');
            a.href = dataUrlOrUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            return;
          }
        } catch(e){}
        const res = await fetch(dataUrlOrUrl, { mode:'cors' });
        if (!res.ok) throw new Error('Fetch failed: ' + res.status);
        const blob = await res.blob();
        const objUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = objUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(objUrl), 15000);
      } catch (e) {
        console.error('downloadImage failed', e);
        try { window.open(dataUrlOrUrl, '_blank', 'noopener'); } catch(e){}
      }
    }

    downloadAllBtn.addEventListener('click', () => {
      if ((!currentPhotos || currentPhotos.length === 0) && !currentStories) return;
      if (currentStories) downloadImage(currentStories, `stories-${Date.now()}.jpg`);
      if (currentPhotos && currentPhotos.length) {
        currentPhotos.forEach((p,i) => setTimeout(()=>downloadImage(p,`foto-${i+1}.jpg`), i*300));
      }
      alert('üì• Download iniciado!');
    });

    // socket handlers
    socket.on('connect', () => {
      log('socket connect', socket.id);
      setStatus('üîå Conectado ao servidor via socket.', false);
      // try to join by viewerId or session
      if (viewerId) {
        socket.emit('viewer_join', { viewerId });
        log('emit viewer_join by id', viewerId);
      } else if (session) {
        socket.emit('viewer_join', { session });
        log('emit viewer_join by session', session);
      }
    });

    socket.on('disconnect', (reason) => {
      log('socket disconnect', reason);
      setStatus('‚ö†Ô∏è Socket desconectado: ' + (reason || '‚Äî'), false);
    });

    socket.on('viewer_photos_ready', async (data) => {
      log('viewer_photos_ready', data);
      receivedViaSocket = true;
      try {
        if (!data) return;
        if (data.viewerId) {
          viewerId = data.viewerId;
          viewerIdDisplay.textContent = viewerId;
        }
        const photos = Array.isArray(data.photos) ? data.photos : [];
        currentPhotos = photos.slice(0,3);
        currentStories = data.storiesMontage || data.storiesUrl || null;
        currentPrint = data.print || null;
        renderGallery(currentPhotos, currentStories, currentPrint);
        if (currentPhotos.length || currentStories) {
          downloadAllBtn.style.display = 'block';
          setStatus('‚úÖ Fotos carregadas via socket.', false);
        }
      } catch(e){ console.error(e); }
    });

    socket.on('photos_ready', (data) => {
      log('photos_ready', data);
      try {
        if (!data) return;
        const uploaded = Array.isArray(data.uploaded) ? data.uploaded : (Array.isArray(data.photos) ? data.photos : []);
        if (uploaded && uploaded.length) {
          currentPhotos = uploaded.slice(0,3);
          renderGallery(currentPhotos, data.storiesUrl || null, data.printUrl || null);
          downloadAllBtn.style.display = 'block';
          setStatus('‚úÖ Fotos carregadas via photos_ready.', false);
        }
      } catch(e){ console.warn(e); }
    });

    socket.on('viewer_session_created', ({ viewerId: createdId }) => {
      log('viewer_session_created', createdId);
      if (createdId) {
        viewerId = createdId;
        viewerIdDisplay.textContent = viewerId;
        setStatus('üÜï Viewer criado: ' + viewerId, false);
      }
    });

    // if we receive nothing via socket within N seconds, attempt HTTP fetch
    function startNoDataTimer(){
      clearTimeout(noDataTimer);
      noDataTimer = setTimeout(async () => {
        if (receivedViaSocket) return;
        // attempt HTTP fallback if viewerId present
        if (viewerId && !triedHttpFallback) {
          triedHttpFallback = true;
          const v = await httpFetchViewer(viewerId);
          if (v) {
            // map server payload to our UI fields
            currentPhotos = Array.isArray(v.photos) ? v.photos.slice(0,3) : [];
            currentStories = v.storiesMontage || v.storiesUrl || null;
            currentPrint = v.print || null;
            renderGallery(currentPhotos, currentStories, currentPrint);
            if (currentPhotos.length || currentStories) {
              downloadAllBtn.style.display = 'block';
              setStatus('‚úÖ Dados carregados via /api/viewer fallback.', false);
              return;
            }
          }
        }
        // if still nothing, show hint UI
        if (!receivedViaSocket && !(currentPhotos && currentPhotos.length) && !currentStories) {
          showNoDataHint();
        }
      }, 2500); // short timeout to be responsive
    }

    function showNoDataHint(){
      gallery.innerHTML = `<div class="no-photos">‚ùå N√£o foi poss√≠vel carregar as fotos. Verifique a sess√£o (session param na URL) ou pe√ßa ao operador para criar o visualizador.<div class="hint-actions"><button id="retryBtn" class="small-btn">Tentar buscar visualizador mais recente</button><button id="openLinkBtn" class="small-btn">Abrir link atual</button></div><div style="margin-top:12px;word-break:break-all"><small>URL atual: ${location.href}</small></div></div>`;
      document.getElementById('retryBtn').addEventListener('click', retryFetch);
      document.getElementById('openLinkBtn').addEventListener('click', ()=> { try { window.open(location.href, '_blank','noopener'); } catch(e){} });
      setStatus('‚ùó Nenhum dado dispon√≠vel ainda. Tente "Tentar buscar visualizador mais recente".', false);
    }

    async function retryFetch(){
      setStatus('üîÅ Tentando buscar visualizador mais recente...', true);
      // 1) try socket viewer_join again
      try {
        if (viewerId) {
          socket.emit('viewer_join', { viewerId });
          log('retry: viewer_join by id', viewerId);
        } else if (session) {
          socket.emit('viewer_join', { session });
          log('retry: viewer_join by session', session);
        }
      } catch(e){ log('retry socket emit failed', e); }

      // 2) try HTTP /api/viewer by viewerId if available
      if (viewerId) {
        const v = await httpFetchViewer(viewerId);
        if (v) {
          currentPhotos = Array.isArray(v.photos) ? v.photos.slice(0,3) : [];
          currentStories = v.storiesMontage || v.storiesUrl || null;
          currentPrint = v.print || null;
          renderGallery(currentPhotos, currentStories, currentPrint);
          if (currentPhotos.length || currentStories) {
            downloadAllBtn.style.display = 'block';
            setStatus('‚úÖ Dados recuperados por retry via HTTP.', false);
            return;
          }
        }
      }

      // 3) try fetch /visualizador/:session (some servers may respond with HTML/redirect)
      if (session) {
        try {
          const resp = await fetch(`${BACKEND.replace(/\/+$/,'')}/visualizador/${encodeURIComponent(session)}`, { method:'GET', mode:'cors' });
          if (resp.ok) {
            const text = await resp.text();
            // If server returned a redirect HTML, user can open it; we try to parse viewerId if embedded
            const m = text.match(/visualizador.html\?session=([a-z0-9\-_:]+)/i);
            if (m && m[1]) {
              viewerId = decodeURIComponent(m[1]);
              viewerIdDisplay.textContent = viewerId;
              setStatus('‚úÖ Encontrado viewer via /visualizador redirect: ' + viewerId, false);
              // try API for that viewerId
              const v2 = await httpFetchViewer(viewerId);
              if (v2) {
                currentPhotos = Array.isArray(v2.photos) ? v2.photos.slice(0,3) : [];
                currentStories = v2.storiesMontage || v2.storiesUrl || null;
                currentPrint = v2.print || null;
                renderGallery(currentPhotos, currentStories, currentPrint);
                if (currentPhotos.length || currentStories) {
                  downloadAllBtn.style.display = 'block';
                  return;
                }
              }
            } else {
              setStatus('‚ö†Ô∏è /visualizador respondeu, mas n√£o conseguimos extrair viewerId.', false);
            }
          } else {
            setStatus('‚ö†Ô∏è /visualizador retornou ' + resp.status, false);
          }
        } catch(e) {
          console.warn('retry fetch /visualizador failed', e);
          setStatus('‚ùå Falha ao buscar /visualizador (CORS ou network).', false);
        }
      }

      // still nothing
      setStatus('‚ùå N√£o foi poss√≠vel recuperar visualizador automaticamente. Pe√ßa ao operador para gerar novamente.', false);
      showNoDataHint();
    }

    // initial attempt: if viewerId present, call HTTP immediately (fast path)
    (async function initialFetch(){
      if (viewerId) {
        setStatus('üîé Procurando viewer via HTTP (fast-path)...', true);
        const v = await httpFetchViewer(viewerId);
        if (v) {
          currentPhotos = Array.isArray(v.photos) ? v.photos.slice(0,3) : [];
          currentStories = v.storiesMontage || v.storiesUrl || null;
          currentPrint = v.print || null;
          renderGallery(currentPhotos, currentStories, currentPrint);
          if (currentPhotos.length || currentStories) {
            downloadAllBtn.style.display = 'block';
            setStatus('‚úÖ Carregado via /api/viewer (fast-path).', false);
            return;
          }
        }
      }
      // start no-data timer to fallback after a short wait for socket
      startNoDataTimer();
    })();

    // support inline payload via ?data=base64(...) (quick preview fallback)
    if (dataParam) {
      try {
        const decoded = atob(decodeURIComponent(dataParam));
        const parsed = JSON.parse(decoded);
        if (parsed.photos) {
          currentPhotos = parsed.photos.slice(0,3);
          currentStories = parsed.stories || null;
          renderGallery(currentPhotos, currentStories, parsed.print || null);
          downloadAllBtn.style.display = 'block';
          setStatus('‚úÖ Carregado via data param.', false);
        }
      } catch (e) { console.warn('failed parse data param', e); }
    }

  })();
</script>
</body>
</html>
