<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Visualizador — Cabine Fotográfica</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg-overlay: rgba(0,0,0,0.45);
      --card: rgba(255,255,255,0.04);
      --accent: #0b84ff;
      --muted: #cbd5e1;
      --glass: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:Inter,system-ui,Arial,sans-serif;background:#000;color:#fff}
    /* background image (iniciar.png) */
    body{
      background-image: url('iniciar.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    /* overlay so text is readable */
    .page-overlay{
      position:fixed; inset:0; background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.45) 40%, rgba(0,0,0,0.7) 100%);
      display:flex; flex-direction:column;
    }

    header{
      display:flex;align-items:center;gap:12px;padding:18px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      backdrop-filter: blur(6px);
    }
    header .brand{display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0}
    header .small{color:var(--muted);font-size:13px}
    .container{padding:18px;display:flex;flex-direction:column;gap:18px;flex:1;overflow:auto}

    /* Main hero: stories */
    .hero{
      display:flex;gap:18px;align-items:flex-start;
      width:100%;
      justify-content:center;
    }
    .stories-card{
      background: var(--card);
      border-radius:14px;
      padding:14px;
      width:100%;
      max-width:1200px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    .stories-preview{
      width:100%;
      height:auto;
      background:#000;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }

    .stories-preview img, .stories-preview canvas{
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
    }

    .stories-actions{
      display:flex;gap:10px;align-items:center;
    }
    .btn{
      padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer;
      background:var(--accent); color:#001; color: #fff;
      box-shadow:0 6px 18px rgba(11,132,255,0.18);
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .download-ig{
      background: linear-gradient(90deg,#ff6a00,#ff0066);
      color:#fff;
      border-radius:12px;
      padding:12px 16px;
      font-weight:900;
      letter-spacing:0.6px;
    }

    /* photos grid */
    .photos-grid{
      display:flex;gap:12px;flex-wrap:wrap;justify-content:center;
      margin-top:8px;
    }
    .photo-card{
      background:var(--glass);padding:8px;border-radius:10px;display:flex;flex-direction:column;gap:8px;align-items:center;width:240px;
    }
    .photo-card img{width:100%;height:auto;border-radius:8px;object-fit:cover}
    .photo-actions{display:flex;gap:8px;width:100%;justify-content:center}

    /* mobile adjustments */
    @media(max-width:900px){
      .stories-card{max-width:940px}
      .photo-card{width:45%}
    }
    @media(max-width:480px){
      header{padding:12px}
      .container{padding:12px}
      .photo-card{width:100%}
      .stories-card{padding:10px}
    }

    /* small info / debug */
    .info-row{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="page-overlay" role="application" aria-label="Visualizador da cabine">
    <header>
      <div class="brand">
        <img src="logo.png" alt="Logo" style="height:44px;width:auto;border-radius:8px" onerror="this.style.display='none'">
        <div>
          <h1>Visualizador — Cabine Fotográfica</h1>
          <div class="small">Baixe sua foto — Stories em destaque</div>
        </div>
      </div>
      <div style="flex:1"></div>
      <div class="info-row">
        <div id="statusText">Conectando...</div>
      </div>
    </header>

    <main class="container" id="mainContainer">
      <!-- Stories hero -->
      <section class="hero">
        <div class="stories-card" aria-live="polite">
          <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
            <div style="display:flex;flex-direction:column">
              <strong style="font-size:16px">Stories — Faça o download para postar</strong>
              <span class="small" id="storiesSub">Montagem adaptada para Instagram Stories</span>
            </div>
            <div>
              <button id="refreshBtn" class="btn ghost" title="Atualizar">Atualizar</button>
            </div>
          </div>

          <div class="stories-preview" id="storiesPreview" style="min-height:420px;">
            <!-- either canvas or image preview -->
            <div id="storiesPlaceholder" style="color:#999;padding:20px;text-align:center">
              Aguardando montagem...
            </div>
            <!-- canvas inserted dynamically -->
          </div>

          <div style="display:flex;gap:12px;align-items:center;justify-content:center" class="stories-actions">
            <button id="downloadStoriesBtn" class="download-ig" title="Baixar montagem para Instagram">⬇️ Baixar para Instagram</button>
            <button id="downloadStoriesFullBtn" class="btn ghost">⬇️ Baixar (Alta)</button>
            <button id="openAllBtn" class="btn ghost">Abrir todas as fotos</button>
          </div>
        </div>
      </section>

      <!-- Fotos soltas -->
      <section id="photosSection">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <strong style="font-size:16px">Fotos individuais</strong>
            <div class="small">Baixe cada foto separadamente</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="downloadAllBtn" class="btn ghost">Baixar todas</button>
          </div>
        </div>

        <div class="photos-grid" id="photosGrid" style="margin-top:12px">
          <!-- photo cards inserted here -->
        </div>
      </section>

      <!-- optional boomerang area -->
      <section id="boomerangSection" style="margin-top:18px;display:none">
        <strong>Boomerang / Vídeo</strong>
        <div id="boomerangPreview" style="margin-top:8px"></div>
      </section>

    </main>
  </div>

<script>
/*
  Visualizador (estático)
  - conecta via socket ao backend (BACKEND)
  - espera eventos: photos_from_cell (array of dataURLs), photos_ready (uploaded urls), photo_ready, boomerang_ready
  - monta/mostra stories (canvas 3375x6000 com moldura.png por cima quando disponível)
  - exibe primeiro a montagem stories com botão "Baixar para Instagram"
  - exibe as fotos individuais abaixo
  - NÃO mostra QR code
*/

const BACKEND = (location.protocol === 'https:' ? 'https://' : 'http://') + (location.hostname || 'festadodavi-production-0591.up.railway.app');
/* Se seu servidor estiver em domínio fixo, você pode sobrescrever:
   const BACKEND = 'https://festadodavi.onrender.com';
*/

const socket = io(BACKEND, { transports: ['websocket','polling'], path: '/socket.io' });

const state = {
  session: (new URLSearchParams(location.search)).get('session') || (location.pathname.includes('/visualizador/') ? location.pathname.split('/').pop() : 'cabine-fixa'),
  photos: [],          // array of urls or dataURLs
  storiesMontageUrl: null, // if server provides ready montage url
  storiesCanvasDataUrl: null,
  boomerangUrl: null
};

// DOM refs
const statusText = document.getElementById('statusText');
const storiesPreview = document.getElementById('storiesPreview');
const storiesPlaceholder = document.getElementById('storiesPlaceholder');
const downloadStoriesBtn = document.getElementById('downloadStoriesBtn');
const downloadStoriesFullBtn = document.getElementById('downloadStoriesFullBtn');
const openAllBtn = document.getElementById('openAllBtn');
const photosGrid = document.getElementById('photosGrid');
const downloadAllBtn = document.getElementById('downloadAllBtn');
const refreshBtn = document.getElementById('refreshBtn');
const boomerangSection = document.getElementById('boomerangSection');
const boomerangPreview = document.getElementById('boomerangPreview');

const STORIES_CANVAS_W = 3375;
const STORIES_CANVAS_H = 6000;

// coordinates for photos on stories (from your spec)
const STORIES_COORDS = [
  { x: 366, y: 203, w: 2997 - 366, h: 1657 - 203 },
  { x: 363, y: 1773, w: 2997 - 363, h: 3227 - 1773 },
  { x: 363, y: 3346, w: 2997 - 363, h: 4794 - 3346 }
];

// load helper
function loadImage(urlOrData) {
  return new Promise((res, rej) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => res(img);
    img.onerror = (e) => rej(e);
    img.src = urlOrData;
  });
}

// render stories: if server supplied an URL (state.storiesMontageUrl) use it; else build with template + moldura
async function renderStories() {
  // clear preview
  storiesPreview.innerHTML = '';
  storiesPlaceholder.style.display = 'none';

  if(state.storiesMontageUrl) {
    // show image provided by server
    const img = document.createElement('img');
    img.src = state.storiesMontageUrl;
    img.alt = 'Stories';
    img.onload = () => {
      storiesPreview.appendChild(img);
      // update canvas dataurl also (fetch image then convert)
      // convert to dataURL by drawing on a canvas scaled down for preview storage
      try {
        const c = document.createElement('canvas');
        c.width = img.naturalWidth || STORIES_CANVAS_W;
        c.height = img.naturalHeight || STORIES_CANVAS_H;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, c.width, c.height);
        state.storiesCanvasDataUrl = c.toDataURL('image/jpeg', 0.95);
      } catch(e) { console.warn('Não foi possível gerar dataURL da montagem remota', e); }
    };
    img.onerror = () => {
      storiesPlaceholder.style.display = 'block';
      storiesPlaceholder.textContent = 'Erro ao carregar montagem enviada pelo servidor.';
    };
    return;
  }

  // if no photos, show placeholder
  if(!state.photos || state.photos.length === 0) {
    storiesPlaceholder.style.display = 'block';
    storiesPlaceholder.textContent = 'Aguardando fotos...';
    return;
  }

  // build canvas 3375x6000
  const canvas = document.createElement('canvas');
  canvas.width = STORIES_CANVAS_W;
  canvas.height = STORIES_CANVAS_H;
  const ctx = canvas.getContext('2d');

  try {
    // optional base template storiesdavi.png if exists on public
    let baseImg = null;
    try {
      baseImg = await loadImage('storiesdavi.png');
    } catch(e) {
      baseImg = null;
    }

    if(baseImg) {
      ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);
    } else {
      // draw neutral background
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    // draw each photo into coords
    for(let i=0;i<3;i++){
      const src = state.photos[i] || state.photos[state.photos.length-1];
      try {
        const img = await loadImage(src);
        // cover mode: compute sx, sy, sw, sh
        const c = STORIES_COORDS[i] || STORIES_COORDS[0];
        // implement cover cropping
        const imgRatio = img.width / img.height;
        const boxRatio = c.w / c.h;
        let sx = 0, sy = 0, sw = img.width, sh = img.height;
        if(imgRatio > boxRatio) {
          sw = img.height * boxRatio;
          sx = (img.width - sw) / 2;
        } else {
          sh = img.width / boxRatio;
          sy = (img.height - sh) / 2;
        }
        ctx.drawImage(img, sx, sy, sw, sh, c.x, c.y, c.w, c.h);
      } catch(e) {
        console.warn('Erro ao carregar foto para montagem', e);
      }
    }

    // optional overlay moldura.png on top
    try {
      const mold = await loadImage('moldura.png');
      if(mold) {
        ctx.drawImage(mold, 0, 0, canvas.width, canvas.height);
      }
    } catch(e) {
      // ignore if not present
    }

    // convert to dataURL and show a scaled image for preview
    state.storiesCanvasDataUrl = canvas.toDataURL('image/jpeg', 0.95);

    // create preview image (fit to container)
    const previewImg = document.createElement('img');
    previewImg.src = state.storiesCanvasDataUrl;
    previewImg.alt = 'Stories montagem';
    storiesPreview.appendChild(previewImg);

  } catch(err) {
    console.error('Erro montar stories:', err);
    storiesPlaceholder.style.display = 'block';
    storiesPlaceholder.textContent = 'Erro ao montar stories.';
  }
}

// show photo cards
function renderPhotoCards() {
  photosGrid.innerHTML = '';
  const photos = state.photos || [];
  photos.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = 'photo-card';
    const img = document.createElement('img');
    img.src = p;
    img.alt = 'Foto ' + (idx+1);
    card.appendChild(img);

    const actions = document.createElement('div');
    actions.className = 'photo-actions';

    const dl = document.createElement('button');
    dl.className = 'btn';
    dl.textContent = '⬇️ Baixar';
    dl.addEventListener('click', ()=> downloadResource(p, `foto_${idx+1}.jpg`));
    actions.appendChild(dl);

    // open in new tab
    const openBtn = document.createElement('button');
    openBtn.className = 'btn ghost';
    openBtn.textContent = 'Abrir';
    openBtn.addEventListener('click', ()=> window.open(p, '_blank'));
    actions.appendChild(openBtn);

    card.appendChild(actions);
    photosGrid.appendChild(card);
  });
}

// download helper for dataURL or http url
function downloadResource(url, filename = 'arquivo.jpg') {
  if(!url) return;
  // data URL
  if(url.startsWith('data:')) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    return;
  }
  // blob from fetch
  fetch(url, { mode: 'cors' })
    .then(r => r.blob())
    .then(blob => {
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(blobUrl), 2000);
    })
    .catch(err => {
      console.warn('Erro ao baixar recurso remoto:', err);
      // fallback: open in new tab
      window.open(url, '_blank');
    });
}

// download stories (preferred size)
function downloadStories(filename = `stories_${state.session || 'session'}.jpg`) {
  if(state.storiesMontageUrl) {
    // if server provided a ready image, download it
    downloadResource(state.storiesMontageUrl, filename);
    return;
  }
  if(state.storiesCanvasDataUrl) {
    downloadResource(state.storiesCanvasDataUrl, filename);
    return;
  }
  alert('Montagem ainda não disponível.');
}

// download high-res (attempt to request full-res from server if available)
function downloadStoriesHighRes() {
  // attempt: if server provided storiesMontageUrl and it points to remote resource, download it
  if(state.storiesMontageUrl) {
    downloadResource(state.storiesMontageUrl, `stories_full_${state.session}.jpg`);
    return;
  }
  // else fallback to canvas dataURL - already high resolution in our canvas
  if(state.storiesCanvasDataUrl) {
    downloadResource(state.storiesCanvasDataUrl, `stories_full_${state.session}.jpg`);
    return;
  }
  alert('Montagem ainda não disponível.');
}

// show boomerang preview if any
function renderBoomerang() {
  boomerangPreview.innerHTML = '';
  if(!state.boomerangUrl) {
    boomerangSection.style.display = 'none';
    return;
  }
  boomerangSection.style.display = 'block';
  const v = document.createElement('video');
  v.src = state.boomerangUrl;
  v.controls = true;
  v.loop = true;
  v.autoplay = true;
  v.style.maxWidth = '880px';
  v.style.width = '100%';
  boomerangPreview.appendChild(v);

  const dl = document.createElement('button');
  dl.className = 'btn';
  dl.textContent = '⬇️ Baixar Vídeo';
  dl.style.marginLeft = '12px';
  dl.addEventListener('click', ()=> downloadResource(state.boomerangUrl, `boomerang_${state.session}.webm`));
  boomerangPreview.appendChild(dl);
}

// socket events wiring
socket.on('connect', () => {
  statusText.textContent = 'Conectado';
  console.log('Visualizador conectado ao backend', socket.id);
  // let server know which session we are showing (if server needs to push)
  socket.emit('viewer_join', { session: state.session });
});

// handle server-sent photo events
socket.on('photo_ready', (payload) => {
  // single photo
  try {
    if(payload && payload.session && payload.session !== state.session) return;
    const { index, photo } = payload;
    // add at correct position (index may be 0-based)
    if(typeof index === 'number') {
      state.photos[index] = photo;
    } else {
      state.photos.push(photo);
    }
    // update UI
    renderPhotoCards();
    renderStories();
  } catch(e) { console.warn('photo_ready handler error', e); }
});

socket.on('photos_from_cell', (payload) => {
  try {
    if(!payload) return;
    if(payload.session && payload.session !== state.session) return;
    const photos = Array.isArray(payload.photos) ? payload.photos : payload;
    state.photos = photos.slice(0,3);
    // clear any preexisting montage url (we'll rebuild)
    state.storiesMontageUrl = null;
    renderPhotoCards();
    renderStories();
  } catch(e) { console.warn('photos_from_cell handler error', e); }
});

// server may emit photos_ready (with uploaded URLs) — prefer these
socket.on('photos_ready', (payload) => {
  try {
    if(!payload) return;
    if(payload.session && payload.session !== state.session) return;
    if(payload.uploaded && Array.isArray(payload.uploaded) && payload.uploaded.length) {
      state.photos = payload.uploaded.slice(0,3);
      renderPhotoCards();
    }
    // server may provide a ready visualizador or montage url:
    if(payload.visualizadorUrl && payload.visualizadorUrl.includes('/visualizador/')) {
      // server link for the viewer (not needed here)
    }
    // server might also include 'storiesMontage' or similar; accept any recognized field
    if(payload.storiesMontageUrl) {
      state.storiesMontageUrl = payload.storiesMontageUrl;
    }
    if(payload.storiesUrl) state.storiesMontageUrl = payload.storiesUrl;
    if(payload.stories) state.storiesMontageUrl = payload.stories;
    renderStories();
  } catch(e){ console.warn('photos_ready handler error', e); }
});

// boomerang
socket.on('boomerang_ready', (payload) => {
  try {
    if(payload.session && payload.session !== state.session) return;
    // server may send video url
    if(payload.videoUrl) {
      state.boomerangUrl = payload.videoUrl;
      renderBoomerang();
      return;
    }
    if(payload.url) {
      state.boomerangUrl = payload.url;
      renderBoomerang();
      return;
    }
    // some servers might send base64 or data property
    if(payload.data && typeof payload.data === 'string' && payload.data.startsWith('data:')) {
      state.boomerangUrl = payload.data;
      renderBoomerang();
      return;
    }
  } catch(e){ console.warn('boomerang_ready handler error', e); }
});

// server may send complete pre-built items list on request
socket.on('request_items_response', (rsp) => {
  console.log('request_items_response', rsp);
});

// allow user to request server list manually
refreshBtn.addEventListener('click', () => {
  // ask server for current items for this session (server must implement 'request_items' to respond)
  try {
    socket.timeout(5000).emit('request_items', { session: state.session }, (resp) => {
      if(resp && Array.isArray(resp.items)) {
        // resp.items should contain objects { type:'photoset'|'photo'|'boomerang', url or photos[] }
        // we'll pick the most relevant
        const it = resp.items[0];
        if(it) {
          if(it.type === 'photoset' && Array.isArray(it.photos)) {
            state.photos = it.photos.slice(0,3);
            renderPhotoCards();
            renderStories();
          } else if(it.type === 'photo' && it.url) {
            state.photos = [it.url];
            renderPhotoCards();
            renderStories();
          } else if(it.type === 'boomerang' && it.url) {
            state.boomerangUrl = it.url;
            renderBoomerang();
          }
        }
      } else {
        console.log('request_items resposta vazia', resp);
      }
    });
  } catch(e) {
    console.warn('request_items falhou (socket):', e);
  }
});

// download handlers
downloadStoriesBtn.addEventListener('click', ()=> downloadStories());
downloadStoriesFullBtn.addEventListener('click', ()=> downloadStoriesHighRes());
openAllBtn.addEventListener('click', ()=> {
  // open all individual photos in new tabs sequentially
  (state.photos || []).forEach((p) => window.open(p, '_blank'));
});
downloadAllBtn.addEventListener('click', ()=> {
  // attempt to download all photos as separate files (will trigger multiple downloads)
  (state.photos || []).forEach((p, i) => downloadResource(p, `foto_${i+1}.jpg`));
});

// initial render state
renderPhotoCards();
renderStories();
renderBoomerang();

// graceful fallback: if visualizador was opened via server route /visualizador/:session (server-rendered),
// the server may have embedded direct links. Try fetching /visualizador/${session}.json (optional) — skip if not present.
(async function tryFetchServerData(){
  try {
    const url = new URL(`/visualizador/${encodeURIComponent(state.session)}`, BACKEND);
    // Some servers provide a JSON endpoint; attempt to fetch JSON by appending ?json=1
    const probe = url.toString() + '?json=1';
    const r = await fetch(probe, { method:'GET' });
    if(r.ok) {
      const j = await r.json().catch(()=>null);
      if(j) {
        if(j.photos && Array.isArray(j.photos)) {
          state.photos = j.photos.slice(0,3);
        }
        if(j.boomerang) state.boomerangUrl = j.boomerang.url || j.boomerang;
        if(j.stories) state.storiesMontageUrl = j.stories;
        renderPhotoCards();
        renderStories();
        renderBoomerang();
        return;
      }
    }
  } catch(e) {
    // ignore if endpoint doesn't exist
  }
})();

</script>
</body>
</html>
