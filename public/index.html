<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Operador (Webcam)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body{font-family:Arial, sans-serif;background:#0b0b0d;color:#eee;margin:0;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    h1{margin:0 0 8px 0}
    .btn{background:#0b84ff;color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.secondary{background:#333}
    .section{background:#0f0f10;padding:12px;border-radius:10px;margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
    #webcamPreview{width:640px;height:480px;border-radius:8px;background:#000;object-fit:cover;border:1px solid #222;display:block}
    #thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    #thumbs img{width:150px;border-radius:6px;border:2px solid #222;object-fit:cover}
    #log{font-family:monospace;margin-top:12px;color:#9f9;max-height:260px;overflow:auto;background:#070707;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ðŸ“¸ Cabine FotogrÃ¡fica â€” Operador</h1>
      <div id="connectionStatus" style="background:#333;padding:6px;border-radius:6px">ðŸ”´ Desconectado</div>
    </div>
    <div>
      <button id="genQrBtn" class="btn secondary" disabled>Gerar QR Celular</button>
      <button id="genVisQrBtn" class="btn secondary" disabled>Gerar QR Visualizador</button>
      <button id="finalizarBtn" class="btn secondary" disabled>Finalizar SessÃ£o</button>
    </div>
  </header>

  <div class="section">
    <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap">
      <div>
        <strong>SessÃ£o fixa:</strong> <span id="sessionId">cabine-fixa</span>
      </div>
      <div id="qrcode" style="background:#fff;padding:8px;border-radius:8px"></div>
      <div id="qrcodeVis" style="background:#fff;padding:8px;border-radius:8px"></div>
    </div>

    <div style="margin-top:12px">
      <label>Servidor</label>
      <input id="serverUrl" value="https://festadodavi.onrender.com" style="padding:8px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:#eee;width:340px">
      <label style="margin-left:12px">IMGBB Key</label>
      <input id="imgbbKey" placeholder="opcional" style="padding:8px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:#eee;width:300px">
    </div>
  </div>

  <div class="section">
    <h3>Webcam & Stream</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button id="startCam" class="btn">Iniciar Webcam</button>
      <button id="stopCam" class="btn secondary" disabled>Parar Webcam</button>
      <button id="startStream" class="btn secondary" disabled>Iniciar Stream</button>
      <button id="stopStream" class="btn secondary" disabled>Parar Stream</button>

      <label style="margin-left:10px">ResoluÃ§Ã£o</label>
      <select id="res" style="padding:8px;border-radius:6px;background:#0b0b0b;border:1px solid #222;color:#eee">
        <option>1280x720</option>
        <option>1920x1080</option>
        <option>640x480</option>
      </select>

      <label>FPS</label>
      <select id="fps" style="padding:8px;border-radius:6px;background:#0b0b0b;border:1px solid #222;color:#eee">
        <option>15</option><option>24</option><option selected>30</option><option>60</option>
      </select>
    </div>

    <video id="webcamPreview" autoplay muted playsinline></video>
    <div id="streamStatus" style="margin-top:8px">Stream: parado</div>
  </div>

  <div class="section">
    <h3>Fotos & Montagens</h3>
    <div id="thumbs"></div>
    <div style="margin-top:8px">
      <button id="saveBtn" class="btn secondary">Salvar Todas</button>
      <button id="clearBtn" class="btn secondary">Limpar Miniaturas</button>
      <button id="testImgbb" class="btn secondary">Testar IMGBB</button>
    </div>
    <canvas id="storiesCanvas" width="3375" height="6000" style="display:block;margin-top:12px;border:1px solid #222"></canvas>
    <canvas id="printCanvas" width="3322" height="5167" style="display:block;margin-top:12px;border:1px solid #222"></canvas>
  </div>

  <div id="log"></div>

<script>
/*
  index.js embedded â€” operador
  - auto inicia socket
  - tenta auto iniciar webcam+stream (se permissÃ£o)
  - take_photo handler para capturar high-res e enviar photo_ready (com mirror:true)
  - nÃ£o removei nenhum controle manual, apenas auto-start se possÃ­vel
*/
const SESSION = 'cabine-fixa';
let SERVER = document.getElementById('serverUrl').value || 'https://festadodavi.onrender.com';
const el = id => document.getElementById(id);

const connectionStatus = el('connectionStatus'), qrcodeEl = el('qrcode'), qrcodeVis = el('qrcodeVis');
const startCamBtn = el('startCam'), stopCamBtn = el('stopCam'), startStreamBtn = el('startStream'), stopStreamBtn = el('stopStream');
const webcamPreview = el('webcamPreview'), resSel = el('res'), fpsSel = el('fps');
const genQrBtn = el('genQrBtn'), genVisQrBtn = el('genVisQrBtn'), finalizarBtn = el('finalizarBtn');
const thumbs = el('thumbs'), logEl = el('log'), streamStatus = el('streamStatus');

let socket = null;
let localStream = null;
let streamHandle = null;
let lastPhotos = [];
let mirrorFinal = true; // envia mirror:true para que o final chegue com mesma orientaÃ§Ã£o do preview

function log(msg){ const t = new Date().toLocaleTimeString(); logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent; console.log(msg); }
function setConnected(c){ connectionStatus.textContent = c ? 'ðŸŸ¢ Conectado' : 'ðŸ”´ Desconectado'; connectionStatus.style.background = c ? '#0b4' : '#333'; }

function initSocket(){
  if(socket && socket.connected) return socket;
  SERVER = document.getElementById('serverUrl').value || SERVER;
  socket = io(SERVER, { transports:['websocket'], reconnection:true });

  socket.on('connect', ()=>{
    setConnected(true); log('Conectado ao servidor'); socket.emit('join_session', { session: SESSION, role: 'operator' }); generateQr(); generateVisPlaceholder(); tryAutoStart();
  });
  socket.on('disconnect', ()=>{ setConnected(false); log('Desconectado'); });

  socket.on('take_photo', ({ session, index, viewerId })=>{
    log('take_photo request index ' + index + ' for viewer ' + viewerId);
    captureHighResAndSend(index, viewerId);
  });

  socket.on('photos_submit', ({ viewerId, photos })=>{
    log('photos_submit recebido: ' + viewerId + ' cnt:' + photos.length);
    lastPhotos = photos.slice(0,3);
    renderThumbs();
  });

  socket.on('request_stream', ({ session, viewerId })=>{
    log('request_stream recebido para ' + viewerId + ' - iniciando stream automaticamente se possÃ­vel');
    if(localStream) startStreamingToSession(session || SESSION);
  });

  socket.on('reset_session', ({ session })=>{
    log('reset_session recebido - limpando UI');
    lastPhotos = []; renderThumbs(); drawStories([]); drawPrint([]);
  });

  return socket;
}

function generateQr(){
  qrcodeEl.innerHTML = '';
  const url = `${location.origin}/celular.html?session=${encodeURIComponent(SESSION)}`;
  const c = document.createElement('canvas');
  QRCode.toCanvas(c, url, { width:220 }, (err)=>{ if(err) log('Erro QR: ' + err); });
  qrcodeEl.appendChild(c);
  log('QR gerado: ' + url);
}
function generateVisPlaceholder(){
  qrcodeVis.innerHTML = '';
  qrcodeVis.textContent = 'QR Visualizador (gerar quando houver fotos)';
}

async function startCam(){
  try{
    const [w,h] = resSel.value.split('x').map(Number);
    const fps = Number(fpsSel.value) || 30;
    localStream = await navigator.mediaDevices.getUserMedia({ video: { width: w, height: h, frameRate: { ideal: fps } }, audio:false });
    webcamPreview.srcObject = localStream; webcamPreview.play().catch(()=>{});
    startCamBtn.disabled = true; stopCamBtn.disabled = false; startStreamBtn.disabled = false;
    log(`Webcam iniciada ${w}x${h} @${fps}fps`);
  } catch(e){
    log('Erro iniciar webcam: ' + e.message); alert('PermissÃ£o webcam necessÃ¡ria');
  }
}
function stopCam(){
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  webcamPreview.srcObject = null;
  startCamBtn.disabled = false; stopCamBtn.disabled = true; startStreamBtn.disabled = true;
  stopStream();
  log('Webcam parada');
}

async function captureHighResAndSend(index, viewerId){
  if(!localStream){ log('Nenhuma webcam ativa p/ captura'); return; }
  try{
    const v = document.createElement('video'); v.srcObject = localStream; v.muted = true;
    await v.play().catch(()=>{});
    const c = document.createElement('canvas'); c.width = v.videoWidth || 1280; c.height = v.videoHeight || 720;
    const ctx = c.getContext('2d');
    // mirror when capturing to match preview orientation
    ctx.save(); ctx.translate(c.width,0); ctx.scale(-1,1);
    ctx.drawImage(v,0,0,c.width,c.height);
    ctx.restore();
    const photo = c.toDataURL('image/jpeg', 0.95);
    socket.emit('photo_ready', { session: SESSION, index, viewerId, photo, mirror: true });
    log('photo_ready enviado para ' + viewerId);
  } catch(e){ log('Erro capture/send: ' + e.message); }
}

let streamingInterval = null;
function startStreamingToSession(targetSession){
  if(!localStream){ log('Sem webcam para stream'); return; }
  const fps = Number(fpsSel.value) || 30;
  const interval = Math.max(16, Math.round(1000 / fps));
  const v = document.createElement('video'); v.srcObject = localStream; v.muted = true; v.playsInline = true;
  v.play().catch(()=>{});
  const canvas = document.createElement('canvas'); const res = resSel.value.split('x').map(Number);
  canvas.width = Math.min(900, Math.round(res[0]/1.3)); canvas.height = Math.round(canvas.width * (res[1]/res[0]));
  const ctx = canvas.getContext('2d');
  if(streamingInterval) clearInterval(streamingInterval);
  streamingInterval = setInterval(()=> {
    try {
      ctx.save(); ctx.translate(canvas.width,0); ctx.scale(-1,1);
      ctx.drawImage(v,0,0,canvas.width,canvas.height);
      ctx.restore();
      const frame = canvas.toDataURL('image/jpeg', 0.6);
      socket.emit('stream_frame', { session: targetSession || SESSION, frame });
    } catch(e){}
  }, interval);
  startStreamBtn.disabled = true; stopStreamBtn.disabled = false;
  streamStatus.textContent = `Streaming @ ${fps}fps`;
  log('Stream iniciado @' + fps + 'fps');
}
function stopStream(){
  if(streamingInterval){ clearInterval(streamingInterval); streamingInterval = null; }
  startStreamBtn.disabled = false; stopStreamBtn.disabled = true;
  streamStatus.textContent = 'Stream parado';
  log('Stream parado');
}

function renderThumbs(){
  thumbs.innerHTML = '';
  lastPhotos.forEach((p,i)=>{ const img = document.createElement('img'); img.src = p; img.alt = `foto-${i+1}`; thumbs.appendChild(img); });
}
function drawStories(photos){ const canvas = document.getElementById('storiesCanvas'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); /* background template load if needed */ }
function drawPrint(photos){ const canvas = document.getElementById('printCanvas'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); }

/* auto-start helper: try to init socket and camera and stream, but only after user gesture if required */
async function tryAutoStart(){
  initSocket();
  // try to start webcam once (browsers require gesture â€” but if permission stored, this will succeed)
  try {
    if(!localStream) await startCam();
    if(localStream && socket && socket.connected) startStreamingToSession(SESSION);
  } catch(e){ log('Auto start falhou (permissÃ£o/click necessÃ¡rio): ' + e.message); }
}

/* init */
window.addEventListener('DOMContentLoaded', () => {
  initSocket();
  generateQr();
  generateVisPlaceholder();
  // keep UI responsive
});

// Attach button events
startCamBtn.addEventListener('click', startCam);
stopCamBtn.addEventListener('click', stopCam);
startStreamBtn.addEventListener('click', ()=>startStreamingToSession(SESSION));
stopStreamBtn.addEventListener('click', ()=>{ socket && socket.emit('stop_stream', { session: SESSION }); stopStream(); });
genQrBtn.addEventListener('click', generateQr);
genVisQrBtn.addEventListener('click', ()=>{ if(lastPhotos.length){ socket.emit('create_viewer_session', { photos: lastPhotos, session: SESSION }); } else alert('Nenhuma foto para gerar visualizador'); });
finalizarBtn.addEventListener('click', ()=>{ socket && socket.emit('reset_session', { session: SESSION }); });

</script>
</body>
</html>
