<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine Fotogr√°fica ‚Äî Operador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/favicon.ico">

  <!-- Socket.io + QRCode + jsPDF -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{--bg:#0f1113;--panel:#0b0d0f;--accent:#0b84ff;--muted:#7f8c8d}
    *{box-sizing:border-box}
    body{font-family:Inter, Arial, Helvetica, sans-serif;background:var(--bg);color:#eee;margin:0;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0 0 8px 0;font-size:20px}
    .buttons-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;margin-right:8px}
    button.secondary{background:#333}
    button.danger{background:#dc3545}
    button:disabled{background:#444;cursor:not-allowed;opacity:0.7}
    .qrcode-container{margin:12px 0;padding:10px;background:#111;border-radius:8px;display:inline-block}
    .qrcode-section{margin:20px 0}
    #thumbs{display:flex;flex-wrap:wrap;gap:8px}
    #thumbs img{width:170px;height:auto;border-radius:6px;border:2px solid #222;object-fit:cover}
    canvas{max-width:100%;display:block;margin-top:12px;border:1px solid #333;background:#000}
    #log{color:#9f9;margin-top:12px;white-space:pre-wrap;font-family:monospace;font-size:12px;max-height:360px;overflow-y:auto;background:#091012;padding:10px;border-radius:8px}
    .status{background:#111;padding:8px;border-radius:4px;margin:8px 0;display:inline-block;border:1px solid rgba(255,255,255,0.03)}
    .connected{color:#4CAF50;}
    .disconnected{color:#f44336;}
    .viewer-info{background:#0b0d0f;padding:10px;border-radius:5px;margin:10px 0}
    .viewer-history{background:#08090a;padding:10px;border-radius:5px;margin:10px 0;max-height:240px;overflow-y:auto}
    .viewer-item{margin:5px 0;padding:5px;background:#0a0b0c;border-radius:3px}
    .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    label.inline{display:inline-flex;gap:8px;align-items:center}
    .small{font-size:13px;padding:6px 10px}
    .info-block{background:#0b0c0d;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:12px;max-width:100%}
    #webcamPreview{width:480px;height:360px;background:#000;border:1px solid #222;display:block;margin-top:10px;border-radius:6px;object-fit:cover}
    @media(max-width:900px){#webcamPreview{width:320px;height:240px}}
    .muted{color:var(--muted)}
    .flex-col{display:flex;flex-direction:column}
    .viz-link{color:#9ad1ff;word-break:break-all;display:inline-block;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üì∏ Cabine Fotogr√°fica ‚Äî Operador</h1>
      <div id="connectionStatus" class="status disconnected">üî¥ Desconectado</div>
    </div>

    <div class="buttons-row">
      <button id="genQr" class="small" disabled>Gerar QR Celular</button>
      <button id="genVisualizadorQr" class="small" disabled>Gerar QR Visualizador</button>
      <button id="finalizarSessao" class="small danger" disabled>Finalizar Sess√£o</button>
      <button id="printBtn" class="small secondary" disabled>Imprimir (5x15)</button>
      <button id="limparVisualizadorBtn" class="small secondary">Limpar Visualizador</button>
      <button id="debugBtn" class="small secondary">Debug</button>
    </div>
  </header>

  <div class="info-block">
    <div>Sess√£o: <strong id="sessionId">‚Äî</strong></div>
    <div style="margin-top:6px" id="sessionControls">
      <label class="inline"><input id="autoStartWebcam" type="checkbox"> Auto-start webcam ao conectar</label>
    </div>
  </div>

  <div class="qrcode-section">
    <h3>QR Code para Celular (Cabine)</h3>
    <div id="qrcode" class="qrcode-container"></div>
  </div>

  <div class="qrcode-section">
    <h3>QR Code do Visualizador (Convidado)</h3>
    <div id="qrcodeVisualizador" class="qrcode-container"></div>
    <div id="viewerInfo" class="viewer-info" style="display:none;">
      <p><strong>Visualizador link:</strong> <span id="viewerSessionId">‚Äî</span></p>
      <p><strong>Expira em:</strong> 7 dias</p>
    </div>
  </div>

  <div class="qrcode-section">
    <h3>Hist√≥rico de Visualizadores</h3>
    <div id="viewerHistory" class="viewer-history">
      <div class="viewer-item">Nenhum visualizador gerado ainda</div>
    </div>
  </div>

  <h3>Controle da Webcam (opcional)</h3>
  <div class="controls-row">
    <button id="startWebcamBtn">Iniciar Webcam</button>
    <button id="stopWebcamBtn" disabled>Parar Webcam</button>
    <button id="startStreamBtn" disabled>Iniciar Stream</button>
    <button id="stopStreamBtn" disabled>Parar Stream</button>
    <select id="streamSelect" style="min-width:220px">
      <option value="">Enviar para sess√£o (autom√°tico request)</option>
    </select>
  </div>
  <video id="webcamPreview" autoplay muted playsinline></video>

  <h3>Fotos recebidas (√∫ltimas)</h3>
  <div id="thumbs"></div>

  <h3>Preview ‚Äî Montagem Stories (alto-res)</h3>
  <canvas id="storiesCanvas" width="3375" height="6000" style="display:block;border:1px solid #222;margin-top:12px;max-width:100%"></canvas>

  <h3>Preview ‚Äî Impress√£o (5x15)</h3>
  <canvas id="printCanvas" width="1845" height="5536" style="display:block;border:1px solid #222;margin-top:12px;max-width:100%"></canvas>

  <div id="log"></div>

<script>
(function(){
  // -----------------------
  // CONFIG
  // -----------------------
  var SERVER_URL = 'https://festadodavi-production-0591.up.railway.app';
  var FIXED_SESSION = 'cabine-fixa';
  var STORIES_TEMPLATE = 'storiesdavi.png';
  var PRINT_TEMPLATE = 'imprimirdavi.png';
  var FRAME_OVERLAY = 'moldura.png';
  var MAX_WAIT_MS_FOR_BATCH = 1400;
  var UPLOAD_TIMEOUT_MS = 30000;

  // -----------------------
  // DOM refs
  // -----------------------
  function el(id){ return document.getElementById(id); }
  var qrcodeEl = el('qrcode'), qrcodeVisualizadorEl = el('qrcodeVisualizador');
  var sessionIdEl = el('sessionId'), viewerSessionIdEl = el('viewerSessionId');
  var viewerInfoEl = el('viewerInfo'), viewerHistoryEl = el('viewerHistory');
  var thumbsEl = el('thumbs'), storiesCanvas = el('storiesCanvas'), printCanvas = el('printCanvas');
  var logEl = el('log'), connectionStatusEl = el('connectionStatus');

  var genQrBtn = el('genQr'), finalizarBtn = el('finalizarSessao');
  var genVisualizadorQrBtn = el('genVisualizadorQr'), printBtn = el('printBtn');
  var debugBtn = el('debugBtn'), limparVisualizadorBtn = el('limparVisualizadorBtn');

  var startWebcamBtn = el('startWebcamBtn'), stopWebcamBtn = el('stopWebcamBtn');
  var startStreamBtn = el('startStreamBtn'), stopStreamBtn = el('stopStreamBtn');
  var streamSelect = el('streamSelect'), webcamPreview = el('webcamPreview');
  var autoStartWebcamCheckbox = el('autoStartWebcam');

  // -----------------------
  // STATE
  // -----------------------
  var socket = null;
  var lastPhotos = [];
  var viewerHistory = [];
  var localStream = null;
  var streamingInterval = null;
  var currentStoriesMontageDataUrl = null;
  var currentPrintMontageDataUrl = null;
  var currentBoomerangUrl = null;

  var pendingBySession = {};

  // store last viewerId the server created (viewer_session_created)
  var lastCreatedViewerId = null;

  // -----------------------
  // UTIL / LOG
  // -----------------------
  function log(msg){
    var ts = new Date().toLocaleTimeString();
    logEl.textContent = '[' + ts + '] ' + msg + '\n' + logEl.textContent;
    console.log(msg);
  }
  function setStatus(text, cssClass){
    connectionStatusEl.textContent = text;
    connectionStatusEl.className = 'status';
    if(cssClass) connectionStatusEl.classList.add(cssClass);
  }

  // -----------------------
  // SOCKET INIT
  // -----------------------
  function initSocket(){
    if (socket && socket.connected) return;
    log('üì° Inicializando socket para ' + SERVER_URL);
    try {
      socket = io(SERVER_URL, {
        transports: ['websocket','polling'],
        reconnection: true,
        reconnectionAttempts: 20,
        reconnectionDelay: 2000,
        timeout: 20000
      });
    } catch(e){
      log('‚ùå Erro ao criar socket: ' + e);
      return;
    }

    socket.on('connect', function(){
      log('‚úÖ Conectado ao servidor: ' + SERVER_URL + ' (id: ' + socket.id + ')');
      setStatus('üü¢ Conectado', 'connected');
      try { socket.emit('join_session', { session: FIXED_SESSION, role: 'operator' }); } catch(e){}
      sessionIdEl.textContent = FIXED_SESSION;
      genQrBtn.disabled = false;
      finalizarBtn.disabled = false;
      genVisualizadorQrBtn.disabled = false;
      printBtn.disabled = false;
      if (autoStartWebcamCheckbox.checked) attemptAutoStartWebcam();
    });

    socket.on('disconnect', function(reason){
      log('‚ùå Desconectado: ' + reason);
      setStatus('üî¥ Desconectado', 'disconnected');
      genQrBtn.disabled = true;
      finalizarBtn.disabled = true;
    });

    socket.on('connect_error', function(err){
      log('‚ùå Erro de conex√£o: ' + (err && err.message ? err.message : err));
      setStatus('‚ö†Ô∏è Erro de conex√£o', null);
    });

    // central async handler that ensures montages are ready before showing visualizador
    async function handleIncomingServerPhotos(obj){
      try {
        var session = obj.session || FIXED_SESSION;
        // get any uploaded URLs array (server may use 'uploaded' or 'photos')
        var uploaded = obj.uploaded || obj.photos || obj.photosArray || null;
        var visualizadorUrl = obj.visualizadorUrl || obj.visualizador || null;
        var storiesUrl = obj.storiesUrl || obj.storiesMontage || obj.stories || null;
        var printUrl = obj.print || obj.printUrl || null;
        // prefer viewerId from payload; fallback to lastCreatedViewerId
        var vid = obj.viewerId || obj.viewer || lastCreatedViewerId || null;

        log('üì• handleIncomingServerPhotos (session:' + (session||'‚Äî') + ')');

        // update lastPhotos if provided
        if (Array.isArray(uploaded) && uploaded.length) {
          lastPhotos = uploaded.slice(0,3);
          renderThumbs();
        }

        // 1) if server provided a remote storiesUrl, try to fetch & render it first
        if (storiesUrl && typeof storiesUrl === 'string' && /^https?:\/\//i.test(storiesUrl)) {
          log('‚è¨ storiesUrl fornecido pelo servidor, baixando e desenhando antes de mostrar visualizador...');
          try {
            await displayStoriesFromUrl(storiesUrl);
            currentStoriesMontageDataUrl = storiesUrl;
            log('‚úÖ stories remoto desenhado com sucesso');
          } catch(e){
            log('‚ö†Ô∏è Falha ao desenhar stories remoto: ' + e);
            // fallback: try to generate locally from photos
            await drawStories(lastPhotos).catch(function(e){ log('‚ö†Ô∏è drawStories fallback falhou: ' + e); });
          }
        } else {
          // 2) no stories remoto ‚Äî generate locally (ensure canvases are ready)
          log('‚è≥ Garantindo gera√ß√£o local da montagem stories antes de mostrar visualizador...');
          await drawStories(lastPhotos).catch(function(e){ log('‚ö†Ô∏è drawStories local falhou: ' + e); });
        }

        // Ensure print montage too
        if (printUrl && typeof printUrl === 'string' && /^https?:\/\//i.test(printUrl)) {
          currentPrintMontageDataUrl = printUrl;
          printBtn.disabled = false;
          log('‚úÖ print remote dispon√≠vel: ' + printUrl);
        } else {
          await drawPrint(lastPhotos).catch(function(e){ log('‚ö†Ô∏è drawPrint local falhou: ' + e); });
        }

        // If server did NOT provide remote stories URL, upload from operator to server now
        var needToUploadToServer = !(storiesUrl && /^https?:\/\//i.test(storiesUrl));
        if (needToUploadToServer) {
          // if we generated local dataURL for stories, use it; otherwise, nothing to upload
          var montageToUpload = currentStoriesMontageDataUrl && currentStoriesMontageDataUrl.indexOf('data:') === 0 ? currentStoriesMontageDataUrl : null;
          if (montageToUpload) {
            log('‚è´ Enviando montagem (operador) para o servidor para obter URL remota...');
            try {
              // try upload: this endpoint must exist no server (see note)
              var urls = await uploadPhotosAndMontageToServer(lastPhotos, montageToUpload);
              if (urls) {
                log('‚úÖ Upload via /upload-to-imgbb retornou: ' + JSON.stringify(urls));
                // build remote photos/montage
                var remotePhotos = [];
                remotePhotos.push(urls.photo1 || lastPhotos[0] || null);
                remotePhotos.push(urls.photo2 || lastPhotos[1] || lastPhotos[0] || null);
                remotePhotos.push(urls.photo3 || lastPhotos[2] || lastPhotos[0] || null);
                var remoteMontage = urls.montage || null;
                var remotePrint = urls.montage || null;
                // ensure we have a viewer id to register with
                if (!vid) vid = 'v-' + Date.now() + '-' + Math.floor(Math.random()*1e6);
                // tell server to create viewer session with the final URLs (so server/visualizador use remote URLs)
                try {
                  socket.emit('create_viewer_session', {
                    session: session,
                    viewerId: vid,
                    photos: remotePhotos,
                    storiesMontage: remoteMontage,
                    print: remotePrint
                  });
                  log('üì® create_viewer_session emitido com URLs ao servidor para viewer: ' + vid);
                  // set local pointers so showVisualizador uses remoteMontage if available
                  if (remoteMontage) currentStoriesMontageDataUrl = remoteMontage;
                  if (remotePrint) currentPrintMontageDataUrl = remotePrint;
                  printBtn.disabled = !!currentPrintMontageDataUrl;
                  // show visualizador using the viewer id (server will also emit photos_ready eventually)
                  var visualizadorLink = SERVER_URL.replace(/\/+$/,'') + '/visualizador.html?session=' + encodeURIComponent(vid);
                  showVisualizadorQr(visualizadorLink);
                } catch(e){
                  log('‚ö†Ô∏è Falha ao emitir create_viewer_session ap√≥s upload: ' + e);
                }
              } else {
                log('‚ö†Ô∏è /upload-to-imgbb n√£o retornou URLs; enviando dataURLs via socket como fallback');
                // fallback: send dataURLs via socket so server attempts upload itself
                if (!vid) vid = 'v-' + Date.now() + '-' + Math.floor(Math.random()*1e6);
                try {
                  socket.emit('create_viewer_session', {
                    session: session,
                    viewerId: vid,
                    photos: lastPhotos,
                    storiesMontage: montageToUpload,
                    print: currentPrintMontageDataUrl || null
                  });
                  log('üîÅ Fallback create_viewer_session (dataURLs) enviado ao servidor para viewer: ' + vid);
                  var visualizadorLink = SERVER_URL.replace(/\/+$/,'') + '/visualizador.html?session=' + encodeURIComponent(vid);
                  showVisualizadorQr(visualizadorLink);
                } catch(e){ log('‚ö†Ô∏è Fallback emit falhou: ' + e); }
              }
            } catch(e){
              log('‚ùå Erro upload montage to server: ' + e);
            }
          } else {
            log('‚ÑπÔ∏è N√£o h√° montage dataURL local para upload (n√£o foi gerada). Aguardando servidor.');
          }
        } else {
          // server provided remote montage: show visualizador now
          if (visualizadorUrl || vid) {
            var vlink = visualizadorUrl ? normalizeVisualizerUrl(visualizadorUrl) : (SERVER_URL.replace(/\/+$/,'') + '/visualizador.html?session=' + encodeURIComponent(vid));
            log('‚úÖ Mostrando visualizador somente ap√≥s montagens estarem prontas: ' + vlink);
            showVisualizadorQr(vlink);
          } else {
            log('‚ÑπÔ∏è Nenhum visualizadorUrl/vid fornecido ainda ‚Äî aguardando servidor (ou crie manualmente).');
          }
        }

      } catch(e){
        log('‚ùå handleIncomingServerPhotos error: ' + (e && e.message ? e.message : e));
      }
    }

    // wire socket events to the centralized handler
    socket.on('photos_from_cell', function(payload){ handleIncomingServerPhotos(payload).catch(function(e){ log('‚ùå photos_from_cell handler error: ' + e); }); });
    socket.on('photos_submit', function(payload){ handleIncomingServerPhotos(payload).catch(function(e){ log('‚ùå photos_submit handler error: ' + e); }); });
    socket.on('photos_submit_saved', function(payload){ handleIncomingServerPhotos(payload).catch(function(e){ log('‚ùå photos_submit_saved handler error: ' + e); }); });

    socket.on('photos_ready', function(payload){ handleIncomingServerPhotos(payload).catch(function(e){ log('‚ùå photos_ready handler error: ' + e); }); });

    socket.on('viewer_photos_ready', function(payload){ handleIncomingServerPhotos(payload).catch(function(e){ log('‚ùå viewer_photos_ready handler error: ' + e); }); });

    // boomerang: keep existing behavior (preview + show visualizador if present)
    socket.on('boomerang_ready', function(obj){
      var session = obj.session, videoUrl = obj.videoUrl, visualizadorUrl = obj.visualizadorUrl;
      log('üéû boomerang_ready recebido (viewer:' + (session||'‚Äî') + ')');
      currentBoomerangUrl = videoUrl || null;
      renderBoomerangPreview(currentBoomerangUrl);
      if (visualizadorUrl) {
        (async function(){
          await drawStories(lastPhotos).catch(function(){});
          showVisualizadorQr(normalizeVisualizerUrl(visualizadorUrl));
        })();
      }
    });

    // store last created viewer id (server-created)
    socket.on('viewer_session_created', function(obj){
      var viewerId = obj.viewerId;
      log('üéâ Sess√£o do visualizador criada no servidor: ' + viewerId);
      lastCreatedViewerId = viewerId;
      addToViewerHistory(viewerId, lastPhotos.length);
    });

    socket.on('reset_session', function(obj){
      var session = obj.session;
      log('üîÅ reset_session recebido para ' + session);
      lastPhotos = [];
      renderThumbs();
      clearCanvases();
      qrcodeVisualizadorEl.innerHTML = '';
      genVisualizadorQrBtn.disabled = true;
      printBtn.disabled = true;
    });

    socket.on('stream_frame', function(obj){
      log('üîÅ stream_frame relay recebido (len=' + (obj && obj.frame ? obj.frame.length : 0) + ')');
    });
  } // initSocket

  // -----------------------
  // PENDING BATCH MANAGEMENT
  // -----------------------
  function appendToPendingAndMaybeProcess(session, photosArray, viewerId) {
    if (!pendingBySession[session]) pendingBySession[session] = { photos: [], timer: null, viewerId: viewerId || null };
    var p = pendingBySession[session];
    p.photos.push.apply(p.photos, photosArray);
    if (viewerId) p.viewerId = viewerId;
    if (p.photos.length >= 3) {
      var take = p.photos.slice(0,3);
      p.photos = p.photos.slice(3);
      var vid = p.viewerId;
      clearTimeout(p.timer);
      p.timer = null;
      processPhotosAndUpload(take, vid).catch(function(e){ log('‚ùå processPhotosAndUpload error: ' + e); });
      return;
    }
    if (p.timer) clearTimeout(p.timer);
    p.timer = setTimeout(function(){
      var take = p.photos.splice(0,3);
      var vid = p.viewerId;
      p.timer = null;
      if (take && take.length) processPhotosAndUpload(take, vid).catch(function(e){ log('‚ùå processPhotosAndUpload error: ' + e); });
    }, MAX_WAIT_MS_FOR_BATCH);
  }

  // -----------------------
  // QR Generation & Normalization
  // -----------------------
  function generateQrCodeForCell(){
    qrcodeEl.innerHTML = '';
    var url = SERVER_URL.replace(/\/+$/,'') + '/celular.html?session=' + encodeURIComponent(FIXED_SESSION);
    var canvas = document.createElement('canvas');
    QRCode.toCanvas(canvas, url, { width: 220 }, function(err){ if(err) log('‚ùå Erro ao gerar QR Code: ' + err); });
    qrcodeEl.appendChild(canvas);
    log('üì± QR Code Celular gerado: ' + url);
  }

  function normalizeVisualizerUrl(url){
    if(!url) return url;
    try {
      if (url.indexOf('visualizador.html') !== -1) return url;
      var m = url.match(/\/visualizador(?:\/session)?\/([^\/\?]+)/i);
      if (m && m[1]) {
        var sid = decodeURIComponent(m[1]);
        var base = SERVER_URL.replace(/\/+$/,'');
        return base + '/visualizador.html?session=' + encodeURIComponent(sid);
      }
      return url;
    } catch(e){ return url; }
  }

  function showVisualizadorQr(visualizadorUrl){
    qrcodeVisualizadorEl.innerHTML = '';
    var qrCanvas = document.createElement('canvas');
    QRCode.toCanvas(qrCanvas, visualizadorUrl, { width: 220 }, function(err){ if (err) log('‚ùå Erro ao gerar QR: ' + err); });
    qrcodeVisualizadorEl.appendChild(qrCanvas);

    var a = document.createElement('a');
    a.href = visualizadorUrl;
    a.target = '_blank';
    a.rel = 'noopener';
    a.className = 'viz-link';
    a.textContent = visualizadorUrl;
    viewerSessionIdEl.innerHTML = '';
    viewerSessionIdEl.appendChild(a);

    viewerInfoEl.style.display = 'block';
    log('üîó Visualizador pronto: ' + visualizadorUrl);
  }

  // -----------------------
  // THUMBS AND MONTAGES (with moldura overlay)
  // -----------------------
  function renderThumbs(){
    thumbsEl.innerHTML = '';
    lastPhotos.forEach(function(p, idx){
      var img = document.createElement('img'); img.src = p; img.alt = 'foto-' + (idx+1);
      thumbsEl.appendChild(img);
    });
    // draws will be awaited by upload flow or handlers when needed
    drawStories(lastPhotos).catch(function(){});
    drawPrint(lastPhotos).catch(function(){});
  }

  function clearCanvases(){
    try { storiesCanvas.getContext('2d').clearRect(0,0,storiesCanvas.width,storiesCanvas.height); } catch(e){}
    try { printCanvas.getContext('2d').clearRect(0,0,printCanvas.width,printCanvas.height); } catch(e){}
    currentStoriesMontageDataUrl = null;
    currentPrintMontageDataUrl = null;
    printBtn.disabled = true;
  }

  function drawImageCover(ctx, img, x, y, w, h){
    var imgRatio = img.width / img.height;
    var boxRatio = w / h;
    var sx = 0, sy = 0, sw = img.width, sh = img.height;
    if (imgRatio > boxRatio) {
      sw = img.height * boxRatio; sx = (img.width - sw) / 2;
    } else {
      sh = img.width / boxRatio; sy = (img.height - sh) / 2;
    }
    ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
  }

  var STORIES_COORDS = [
    { x:366, y:203, w:2997 - 366, h:1657 - 203 },
    { x:363, y:1773, w:2997 - 363, h:3227 - 1773 },
    { x:363, y:3346, w:2997 - 363, h:4794 - 3346 }
  ];
  var PRINT_COORDS = [
    { x:158, y:202, w:1685 - 158, h:1432 - 202 },
    { x:158, y:1502, w:1685 - 158, h:2733 - 1502 },
    { x:158, y:2808, w:1684 - 158, h:4036 - 2808 }
  ];

  function displayStoriesFromUrl(url) {
    return new Promise(function(resolve, reject){
      try {
        if (!url) return resolve(null);
        var ctx = storiesCanvas.getContext('2d');
        var img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function(){
          try {
            ctx.clearRect(0,0,storiesCanvas.width,storiesCanvas.height);
            var ratio = Math.min(storiesCanvas.width / img.width, storiesCanvas.height / img.height);
            var w = img.width * ratio;
            var h = img.height * ratio;
            var x = (storiesCanvas.width - w) / 2;
            var y = (storiesCanvas.height - h) / 2;
            ctx.drawImage(img, x, y, w, h);
            currentStoriesMontageDataUrl = url;
            log('‚úÖ stories montagem (remota) desenhada no canvas: ' + url);
            resolve(url);
          } catch (e) {
            log('‚ö†Ô∏è erro ao desenhar stories remota: ' + e);
            reject(e);
          }
        };
        img.onerror = function(){
          log('‚ùå falha ao carregar stories remota: ' + url);
          reject(new Error('load error'));
        };
        img.src = url;
      } catch(e){ reject(e); }
    });
  }

  function drawStories(photos){
    return new Promise(function(resolve){
      try {
        var ctx = storiesCanvas.getContext('2d');
        ctx.clearRect(0,0,storiesCanvas.width,storiesCanvas.height);
        var bg = new Image();
        bg.crossOrigin = 'anonymous';
        bg.onload = (function(){
          return function(){
            (async function(){
              try { ctx.drawImage(bg, 0, 0, storiesCanvas.width, storiesCanvas.height); } catch(e){ log('‚ö†Ô∏è draw bg stories error: ' + e); }
              var loaders = photos.slice(0,3).map(function(p, i){ return new Promise(function(res){ var img = new Image(); img.crossOrigin = 'anonymous'; img.onload = function(){ res({ ok:true, img:img, i:i }); }; img.onerror = function(){ res({ ok:false, img:null, i:i }); }; img.src = p; }); });
              var results = await Promise.all(loaders);
              results.forEach(function(r){
                if (r.ok && r.img) {
                  var i = r.i;
                  var c = STORIES_COORDS[i] || STORIES_COORDS[0];
                  try { drawImageCover(ctx, r.img, c.x, c.y, c.w, c.h); log('‚úÖ Foto ' + (i+1) + ' posicionada no stories: ' + c.x + ',' + c.y + ' ' + c.w + 'x' + c.h); } catch(e){ log('‚ö†Ô∏è drawImageCover stories error: ' + e); }
                } else {
                  log('‚ö†Ô∏è Foto ' + (r.i+1) + ' falhou ao carregar para stories');
                }
              });
              var frame = new Image();
              frame.crossOrigin = 'anonymous';
              frame.onload = function(){
                try { ctx.drawImage(frame, 0, 0, storiesCanvas.width, storiesCanvas.height); } catch(e){ log('‚ö†Ô∏è Erro ao desenhar moldura: ' + e); }
                try { currentStoriesMontageDataUrl = storiesCanvas.toDataURL('image/jpeg', 0.95); log('‚úÖ stories montage dataURL gerado'); } catch(e){ log('‚ö†Ô∏è toDataURL stories failed: ' + e); currentStoriesMontageDataUrl = null; }
                resolve(currentStoriesMontageDataUrl);
              };
              frame.onerror = function(){
                try { currentStoriesMontageDataUrl = storiesCanvas.toDataURL('image/jpeg', 0.95); log('‚úÖ stories montage dataURL gerado (sem moldura)'); } catch(e){ currentStoriesMontageDataUrl = null; }
                resolve(currentStoriesMontageDataUrl);
              };
              frame.src = FRAME_OVERLAY;
            })();
          };
        })();
        bg.onerror = function(){
          log('‚ùå Erro ao carregar background stories (verifique STORIES_TEMPLATE path)');
          var ctx2 = storiesCanvas.getContext('2d');
          ctx2.fillStyle = '#000';
          ctx2.fillRect(0,0,storiesCanvas.width,storiesCanvas.height);
          (async function(){
            var loaders = photos.slice(0,3).map(function(p, i){ return new Promise(function(res){ var img = new Image(); img.crossOrigin = 'anonymous'; img.onload = function(){ res({ ok:true, img:img, i:i }); }; img.onerror = function(){ res({ ok:false, img:null, i:i }); }; img.src = p; }); });
            var results = await Promise.all(loaders);
            results.forEach(function(r){ if (r.ok && r.img) { var c = STORIES_COORDS[r.i] || STORIES_COORDS[0]; try { drawImageCover(ctx2, r.img, c.x, c.y, c.w, c.h); } catch(e){} } });
            try { currentStoriesMontageDataUrl = storiesCanvas.toDataURL('image/jpeg', 0.95); log('‚úÖ stories montage dataURL gerado (bg fail)'); } catch(e){ currentStoriesMontageDataUrl = null; }
            resolve(currentStoriesMontageDataUrl);
          })();
        };
        bg.src = STORIES_TEMPLATE;
      } catch(e){ log('‚ùå drawStories fatal error: ' + e); resolve(null); }
    });
  }

  function drawPrint(photos){
    return new Promise(function(resolve){
      try {
        var ctx = printCanvas.getContext('2d');
        ctx.clearRect(0,0,printCanvas.width,printCanvas.height);
        var bg = new Image();
        bg.crossOrigin = 'anonymous';
        bg.onload = (function(){
          return async function(){
            try { ctx.drawImage(bg, 0, 0, printCanvas.width, printCanvas.height); } catch(e){ log('‚ö†Ô∏è draw bg print error: ' + e); }
            var loaders = photos.slice(0,3).map(function(p, i){ return new Promise(function(res){ var img = new Image(); img.crossOrigin = 'anonymous'; img.onload = function(){ res({ ok:true, img:img, i:i }); }; img.onerror = function(){ res({ ok:false, img:null, i:i }); }; img.src = p; }); });
            var results = await Promise.all(loaders);
            results.forEach(function(r){
              if (r.ok && r.img) {
                var c = PRINT_COORDS[r.i] || PRINT_COORDS[0];
                try { drawImageCover(ctx, r.img, c.x, c.y, c.w, c.h); log('‚úÖ Foto ' + (r.i+1) + ' posicionada no print: ' + c.x + ',' + c.y + ' ' + c.w + 'x' + c.h); } catch(e){ log('‚ö†Ô∏è drawImageCover print error: ' + e); }
              } else {
                log('‚ö†Ô∏è Foto ' + (r.i+1) + ' falhou ao carregar para print');
              }
            });
            try { currentPrintMontageDataUrl = printCanvas.toDataURL('image/jpeg', 0.95); log('‚úÖ print montage dataURL gerado'); } catch(e){ log('‚ö†Ô∏è toDataURL print failed: ' + e); currentPrintMontageDataUrl = null; }
            if (currentPrintMontageDataUrl) printBtn.disabled = false;
            resolve(currentPrintMontageDataUrl);
          };
        })();
        bg.onerror = function(){
          log('‚ùå Erro ao carregar background print (verifique PRINT_TEMPLATE path)');
          var ctx2 = printCanvas.getContext('2d');
          ctx2.fillStyle = '#000';
          ctx2.fillRect(0,0,printCanvas.width,printCanvas.height);
          (async function(){
            var loaders = photos.slice(0,3).map(function(p, i){ return new Promise(function(res){ var img = new Image(); img.crossOrigin = 'anonymous'; img.onload = function(){ res({ ok:true, img:img, i:i }); }; img.onerror = function(){ res({ ok:false, img:null, i:i }); }; img.src = p; }); });
            var results = await Promise.all(loaders);
            results.forEach(function(r){ if (r.ok && r.img) { var c = PRINT_COORDS[r.i] || PRINT_COORDS[0]; try { drawImageCover(ctx2, r.img, c.x, c.y, c.w, c.h); } catch(e){} } });
            try { currentPrintMontageDataUrl = printCanvas.toDataURL('image/jpeg', 0.95); log('‚úÖ print montage dataURL gerado (bg fail)'); } catch(e){ currentPrintMontageDataUrl = null; }
            if (currentPrintMontageDataUrl) printBtn.disabled = false;
            resolve(currentPrintMontageDataUrl);
          })();
        };
        bg.src = PRINT_TEMPLATE;
      } catch(e){ log('‚ùå drawPrint fatal error: ' + e); resolve(null); }
    });
  }

  // -----------------------
  // HELPERS: dataURL <-> Blob
  // -----------------------
  function dataURLtoBlob(dataurl) {
    var arr = dataurl.split(',');
    var mime = arr[0].match(/:(.*?);/)[1];
    var bstr = atob(arr[1]);
    var n = bstr.length;
    var u8arr = new Uint8Array(n);
    while(n--) u8arr[n] = bstr.charCodeAt(n);
    return new Blob([u8arr], {type:mime});
  }

  // -----------------------
  // Upload aggregator -> SERVER /upload-to-imgbb
  // -----------------------
  async function uploadPhotosAndMontageToServer(photosDataUrls, montageDataUrl) {
    var form = new FormData();
    for (var i=0;i<3;i++){
      var d = photosDataUrls[i];
      if (!d) continue;
      var blob = dataURLtoBlob(d);
      var name = 'photo' + (i+1) + '.png';
      form.append('photo' + (i+1), blob, name);
    }
    if (montageDataUrl){
      var blobM = dataURLtoBlob(montageDataUrl);
      form.append('montage', blobM, 'stories_montage.png');
    }
    var controller = new AbortController();
    var id = setTimeout(function(){ controller.abort(); }, UPLOAD_TIMEOUT_MS);
    try {
      var res = await fetch(SERVER_URL.replace(/\/+$/,'' ) + '/upload-to-imgbb', { method: 'POST', body: form, signal: controller.signal });
      clearTimeout(id);
      var json = await res.json();
      if (!json || !json.ok) {
        log('‚ùå /upload-to-imgbb retornou erro: ' + JSON.stringify(json));
        return null;
      }
      log('‚úÖ /upload-to-imgbb retornou URLs: ' + JSON.stringify(json.urls));
      return json.urls || null;
    } catch(e) {
      clearTimeout(id);
      log('‚ùå Falha fetch /upload-to-imgbb: ' + (e.message || e));
      return null;
    }
  }

  // -----------------------
  // PROCESS PHOTOS / PUBLISH VISUALIZADOR (corrigido)
  // -----------------------
  async function processPhotosAndUpload(photosArray, providedViewerId){
    try {
      if (!Array.isArray(photosArray) || photosArray.length === 0) { log('Nenhuma foto para processar'); return; }
      var photos = photosArray.slice(0,3);
      while (photos.length < 3) photos.push(photos[photos.length - 1] || photosArray[0]);

      log('üîÑ Gerando montagem stories e print (aguardando canvases)...');
      lastPhotos = photos.slice(0,3);

      var storiesDataUrl = await drawStories(photos);
      var printDataUrl = await drawPrint(photos);

      var storiesMontageDataUrl = storiesDataUrl || currentStoriesMontageDataUrl || null;
      var printMontageDataUrl = printDataUrl || currentPrintMontageDataUrl || null;

      genVisualizadorQrBtn.disabled = true;

      var viewerIdLocal = providedViewerId || ('v-' + Date.now() + '-' + Math.floor(Math.random()*1e6));

      log('‚è´ Enviando 3 fotos + montagem ao servidor (/upload-to-imgbb)...');
      var urls = await uploadPhotosAndMontageToServer(photos, storiesMontageDataUrl);
      if (!urls) {
        log('‚ö†Ô∏è Upload ao servidor falhou ‚Äî tentando enviar via socket (dataURLs) para que o servidor processe');
        try {
          socket.emit('create_viewer_session', {
            session: FIXED_SESSION, viewerId: viewerIdLocal, photos: photos, storiesMontage: storiesMontageDataUrl || null, print: printMontageDataUrl || null
          });
        } catch(e){ log('‚ö†Ô∏è emit create_viewer_session falhou: ' + e); }
        var visualizadorUrlFallback = SERVER_URL.replace(/\/+$/,'') + '/visualizador.html?session=' + encodeURIComponent(viewerIdLocal);
        showVisualizadorQr(visualizadorUrlFallback);
        genVisualizadorQrBtn.disabled = false;
        printBtn.disabled = false;
        addToViewerHistory(viewerIdLocal, photos.length);
        log('üîÅ Fallback: enviado dados via socket (server far√° upload). Visualizador (preview) criado: ' + visualizadorUrlFallback);
        return;
      }

      var remotePhotos = [];
      remotePhotos.push(urls.photo1 || photos[0]);
      remotePhotos.push(urls.photo2 || photos[1] || photos[0]);
      remotePhotos.push(urls.photo3 || photos[2] || photos[0]);
      var remoteMontage = urls.montage || storiesMontageDataUrl || null;
      var remotePrint = urls.montage || printMontageDataUrl || null;

      log('‚úÖ Upload conclu√≠do no servidor. Enviando create_viewer_session com URLs e viewerId ' + viewerIdLocal);
      try {
        socket.emit('create_viewer_session', { session: FIXED_SESSION, viewerId: viewerIdLocal, photos: remotePhotos, storiesMontage: remoteMontage, print: remotePrint });
      } catch(e){ log('‚ö†Ô∏è Falha ao emitir create_viewer_session: ' + e); }

      var visualizadorUrl = SERVER_URL.replace(/\/+$/,'') + '/visualizador.html?session=' + encodeURIComponent(viewerIdLocal);

      // ensure remote montage shown before we present visualizador
      if (remoteMontage && /^https?:\/\//i.test(remoteMontage)) {
        try { await displayStoriesFromUrl(remoteMontage); } catch(e) { log('‚ö†Ô∏è displayStoriesFromUrl fail: ' + e); }
      } else if (remoteMontage && remoteMontage.indexOf('data:') === 0) {
        currentStoriesMontageDataUrl = remoteMontage;
      }

      currentPrintMontageDataUrl = remotePrint || currentPrintMontageDataUrl;
      if (currentPrintMontageDataUrl) printBtn.disabled = false;

      showVisualizadorQr(visualizadorUrl);
      genVisualizadorQrBtn.disabled = false;
      addToViewerHistory(viewerIdLocal, remotePhotos.length || photos.length);
      log('üéâ Visualizador criado e enviado: ' + visualizadorUrl);
    } catch(e){
      log('‚ùå ERRO no processPhotosAndUpload: ' + (e && e.message ? e.message : e));
      genVisualizadorQrBtn.disabled = false;
    }
  }

  // -----------------------
  // BOOMERANG / HISTORY / WEBCAM / STREAM / PRINT
  // -----------------------
  async function processBoomerangAndPublish(videoUrlOrData, viewerId){
    try {
      if (!videoUrlOrData) { log('‚ö†Ô∏è boomerang sem URL/data'); return; }
      if (typeof videoUrlOrData === 'string' && videoUrlOrData.indexOf('data:') === 0) {
        log('‚è´ Enviando boomerang (dataURL) para o servidor (upload server-side recomendado)...');
        socket.emit('boomerang_ready', { session: FIXED_SESSION, viewerId: viewerId, data: videoUrlOrData, filename: 'boomerang_' + Date.now() + '.webm' });
      } else {
        socket.emit('boomerang_ready', { session: FIXED_SESSION, viewerId: viewerId, videoUrl: videoUrlOrData });
      }
      var visualizadorUrl = location.origin + '/visualizador.html?data=' + encodeURIComponent(btoa(JSON.stringify({ photos: lastPhotos.slice(0,3), boomerang: videoUrlOrData })));
      showVisualizadorQr(visualizadorUrl);
      addToViewerHistory(visualizadorUrl, lastPhotos.length);
      log('üéâ Visualizador do boomerang (fluxo iniciado): ' + visualizadorUrl);
    } catch(e){
      log('‚ùå ERRO processBoomerangAndPublish: ' + (e.message || e));
    }
  }

  function renderBoomerangPreview(url){
    if (!url) return;
    log('‚ñ∂Ô∏è Preview boomerang dispon√≠vel: ' + url);
    var existing = document.getElementById('boomerangPreview');
    if (existing) existing.remove();
    var v = document.createElement('video');
    v.id = 'boomerangPreview';
    v.style.width = '280px';
    v.style.display = 'block';
    v.style.marginTop = '8px';
    v.controls = true;
    v.loop = true;
    v.src = url;
    thumbsEl.appendChild(v);
    v.play().catch(function(){});
  }

  function addToViewerHistory(id, photosCount){
    viewerHistory.unshift({ id:id, timestamp:new Date().toLocaleString(), photosCount:photosCount });
    updateViewerHistory();
  }
  function updateViewerHistory(){
    viewerHistoryEl.innerHTML = '';
    if (!viewerHistory.length) { viewerHistoryEl.innerHTML = '<div class="viewer-item">Nenhum visualizador gerado ainda</div>'; return; }
    viewerHistory.forEach(function(it){
      var div = document.createElement('div'); div.className = 'viewer-item';
      div.innerHTML = '<strong>' + it.timestamp + '</strong> - ' + (it.photosCount || 0) + ' fotos - <span style="word-break:break-all">' + it.id + '</span>';
      viewerHistoryEl.appendChild(div);
    });
  }

  // WEBCAM, STREAM, captureHighRes (mantidos)
  async function startWebcam(){
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video:{ width:{ ideal:1920 }, height:{ ideal:1080 } }, audio:false });
      webcamPreview.srcObject = localStream;
      await webcamPreview.play().catch(function(){});
      startWebcamBtn.disabled = true;
      stopWebcamBtn.disabled = false;
      startStreamBtn.disabled = false;
      log('üé• Webcam iniciada (operador)');
      try {
        var devices = await navigator.mediaDevices.enumerateDevices();
        streamSelect.innerHTML = '<option value="">Enviar para sess√£o (autom√°tico request)</option>';
        devices.filter(function(d){ return d.kind === 'videoinput'; }).forEach(function(d){ var opt = document.createElement('option'); opt.value = FIXED_SESSION; opt.textContent = (d.label || 'C√¢mera') + ' ‚Äî sess√£o atual'; streamSelect.appendChild(opt); });
      } catch(e){}
    } catch(e){ log('‚ùå Erro ao iniciar webcam: ' + (e.message || e)); throw e; }
  }
  function stopWebcam(){ if (localStream){ localStream.getTracks().forEach(function(t){ t.stop(); }); localStream = null; } webcamPreview.srcObject = null; startWebcamBtn.disabled = false; stopWebcamBtn.disabled = true; startStreamBtn.disabled = true; stopStream(); log('üõë Webcam parada'); }

  async function captureHighResAndSend(index, viewerId){
    if(!localStream){ log('‚ö†Ô∏è Webcam n√£o ativa para captura high-res'); return; }
    try {
      var v = document.createElement('video'); v.srcObject = localStream; v.muted = true; await v.play().catch(function(){});
      var c = document.createElement('canvas'); c.width = v.videoWidth || 1920; c.height = v.videoHeight || 1080;
      var ctx = c.getContext('2d'); ctx.save(); ctx.translate(c.width, 0); ctx.scale(-1, 1); ctx.drawImage(v, 0, 0, c.width, c.height); ctx.restore();
      var photo = c.toDataURL('image/jpeg', 0.95);
      socket.emit('photo_ready', { session: FIXED_SESSION, index: index, viewerId: viewerId, photo: photo });
      log('‚úÖ photo_ready enviado para ' + viewerId + ' (index ' + index + ')');
    } catch(e){ log('‚ùå Erro capture high-res: ' + (e.message || e)); }
  }

  function startStreamingToSession(session){
    if(!localStream){ log('‚ö†Ô∏è Webcam n√£o iniciada'); return; }
    var fps = 18;
    var intervalMs = Math.max(16, Math.round(1000 / fps));
    var v = document.createElement('video'); v.srcObject = localStream; v.muted = true; v.playsInline = true; v.play().catch(function(){});
    var canvas = document.createElement('canvas'); canvas.width = 1200; canvas.height = 800;
    var ctx = canvas.getContext('2d');
    if(streamingInterval){ clearInterval(streamingInterval); streamingInterval = null; }
    streamingInterval = setInterval(function(){
      try {
        ctx.save(); ctx.translate(canvas.width,0); ctx.scale(-1,1); ctx.drawImage(v,0,0,canvas.width,canvas.height); ctx.restore();
        var frame = canvas.toDataURL('image/jpeg', 0.6);
        socket.emit('stream_frame', { session: session || FIXED_SESSION, frame: frame });
      } catch(e){}
    }, intervalMs);
    startStreamBtn.disabled = true;
    stopStreamBtn.disabled = false;
    log('‚ñ∂Ô∏è Iniciando stream para sess√£o ' + (session||FIXED_SESSION) + ' @ ~' + fps + 'fps');
  }
  function stopStream(){ if(streamingInterval){ clearInterval(streamingInterval); streamingInterval = null; log('‚è∏ Stream parado'); } stopStreamBtn.disabled = true; startStreamBtn.disabled = false; }

  function sleep(ms){ return new Promise(function(r){ setTimeout(r,ms); }); }

  // PRINT button (corrigido para abrir blob URL)
  printBtn.addEventListener('click', async function(){
    try {
      var data = currentPrintMontageDataUrl || printCanvas.toDataURL('image/png');
      if (data && typeof data === 'string' && /^https?:\/\//i.test(data)) {
        try {
          var resp = await fetch(data);
          var blob = await resp.blob();
          data = await new Promise(function(resolve){ var reader = new FileReader(); reader.onload = function(){ resolve(reader.result); }; reader.readAsDataURL(blob); });
        } catch(e){ log('‚ùå falha ao baixar imagem remota para imprimir: ' + (e.message || e)); data = null; }
      }
      if (!data) { alert('Montagem de impress√£o n√£o dispon√≠vel.'); return; }
      var jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : (window.jspdf ? window.jspdf.jsPDF : null);
      if (!jsPDF) { alert('jsPDF n√£o carregado.'); return; }
      var pdf = new jsPDF({ unit: 'mm', format: [50,150], orientation: 'portrait' });
      pdf.addImage(data, 'JPEG', 0, 0, 50, 150);
      var blobPdf = pdf.output('blob');
      var blobUrl = URL.createObjectURL(blobPdf);
      var w = window.open(blobUrl, '_blank', 'noopener');
      if (!w) {
        var html = '<!doctype html><html><head><meta charset="utf-8"><title>Impress√£o 5x15</title><style>html,body{height:100%;margin:0;background:#fff} embed{width:100%;height:100%;display:block;border:0}</style></head><body><embed id="pdfEmbed" src="' + blobUrl + '" type="application/pdf"></embed><script>setTimeout(function(){ try{ window.print(); } catch(e){} }, 700);</' + 'script></body></html>';
        var win = window.open('', '_blank', 'noopener');
        if (!win) { alert('Permita popups para abrir a janela de impress√£o.'); return; }
        win.document.open(); win.document.write(html); win.document.close();
      } else {
        setTimeout(function(){ try { w.focus(); w.print(); } catch(e){} }, 800);
      }
    } catch(e){ log('‚ùå Erro imprimir: ' + (e.message || e)); }
  });

  // BUTTONS wiring
  genQrBtn.addEventListener('click', generateQrCodeForCell);
  limparVisualizadorBtn.addEventListener('click', function(){ if (confirm('Limpar visualizador da UI?')) { qrcodeVisualizadorEl.innerHTML = ''; viewerInfoEl.style.display = 'none'; log('üßπ Visualizador limpo da interface'); } });

  debugBtn.addEventListener('click', function(){
    log('üêõ DEBUG - Estado atual:');
    log('- Sess√£o FIXA: ' + FIXED_SESSION);
    log('- Socket conectado: ' + (socket ? socket.connected : false));
    log('- Socket ID: ' + (socket ? socket.id : '‚Äî'));
    log('- Fotos recebidas: ' + lastPhotos.length);
    log('- Visualizadores no hist√≥rico: ' + viewerHistory.length);
    fetch(SERVER_URL + '/health').then(function(r){ return r.json(); }).then(function(data){ log('ü©∫ Health: ' + JSON.stringify(data)); }).catch(function(e){ log('‚ùå Health check falhou: ' + (e.message || e)); });
  });

  finalizarBtn.addEventListener('click', function(){ if (!confirm('Finalizar sess√£o e limpar fotos?')) return; lastPhotos = []; renderThumbs(); clearCanvases(); qrcodeVisualizadorEl.innerHTML = ''; genVisualizadorQrBtn.disabled = true; printBtn.disabled = true; try { socket && socket.emit('reset_session', { session: FIXED_SESSION }); log('üîÅ reset_session emitido'); } catch(e){ log('Erro ao emitir reset_session: ' + e); } });

  genVisualizadorQrBtn.addEventListener('click', function(){ if (!lastPhotos.length) { log('‚ùå Nenhuma foto para gerar visualizador'); return; } processPhotosAndUpload(lastPhotos, null).catch(function(e){ log('‚ùå processPhotosAndUpload manual: ' + e); }); });

  startWebcamBtn.addEventListener('click', function(){ startWebcam().catch(function(){}); });
  stopWebcamBtn.addEventListener('click', stopWebcam);
  startStreamBtn.addEventListener('click', function(){ startStreamingToSession(streamSelect.value || FIXED_SESSION); });
  stopStreamBtn.addEventListener('click', function(){ try { socket && socket.emit('stop_stream', { session: FIXED_SESSION }); } catch(e){} stopStream(); });

  window.addEventListener('DOMContentLoaded', function(){
    initSocket();
    genVisualizadorQrBtn.disabled = true;
    printBtn.disabled = true;
    generateQrCodeForCell();
    log('Operador pronto. Aguardando intera√ß√£o e/ou fotos do celular.');
    if (typeof streamingInterval === 'undefined') streamingInterval = null;
  });

  function attemptAutoStartWebcam(){ startWebcam().catch(function(e){ log('Auto-start webcam falhou: ' + e.message); }); }

  window._operator = {
    socketRef: function(){ return socket; },
    lastPhotosRef: function(){ return lastPhotos; },
    sendTestPhotos: function(){ var fake = [ 'data:image/png;base64, ...' ]; try { socket.emit('photos_from_cell', { session: FIXED_SESSION, photos: fake }); } catch(e){} }
  };

})(); // IIFE end
</script>
</body>
</html>
