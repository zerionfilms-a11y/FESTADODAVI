<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Operador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
    video{width:90%;max-width:800px;border:3px solid #ffd600;border-radius:10px}
    #qrcode{margin-top:20px}
  </style>
</head>
<body>
  <h1>ðŸŽ¥ Cabine do Operador</h1>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="status">Iniciando...</div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    const SERVER_URL = "https://festadodavi.onrender.com";
    const session = "cabine-fixa"; // sempre fixo
    const socket = io(SERVER_URL, { transports:["websocket"], reconnection:true });

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const statusEl = document.getElementById("status");

    let stream, ctx;
    let sending = false;

    socket.on("connect", () => {
      statusEl.textContent = "ðŸŸ¢ Conectado â€” transmitindo sessÃ£o: " + session;
      socket.emit("join_session", { session, role: "operator" });
      startCamera();
    });

    socket.on("disconnect", () => {
      statusEl.textContent = "ðŸ”´ Desconectado. Tentando reconectar...";
    });

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
        video.srcObject = stream;
        video.play();
        ctx = canvas.getContext("2d");
        startSendingFrames();
      }catch(e){
        alert("Erro ao acessar webcam: " + e.message);
      }
    }

    function startSendingFrames(){
      if(sending) return;
      sending = true;
      const FPS = 10; // taxa de atualizaÃ§Ã£o
      const send = ()=>{
        if(!stream) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const frame = canvas.toDataURL("image/jpeg",0.6);
        socket.emit("stream_frame",{session,frame});
      };
      setInterval(send,1000/FPS);
    }

    // Exibir QR Code pro celular
    const qrCanvas = document.createElement("canvas");
    document.body.appendChild(qrCanvas);
    const url = `${location.origin}/celular.html?session=${session}&server=${SERVER_URL}`;
    QRCode.toCanvas(qrCanvas, url, {width:220}, err=>{
      if(err) console.error(err);
      statusEl.insertAdjacentHTML("beforebegin","<p>Escaneie com o celular:</p>");
    });
  </script>
</body>
</html>
