<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    /* ===== Geral ===== */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden;-webkit-tap-highlight-color:transparent}
    button{cursor:pointer}
    .hidden{display:none!important}
    .visible{display:flex!important}

    /* ===== Tela de entrar fullscreen (primeira tela) ===== */
    #enterFs {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg,#001e3c,#0b84ff);
      padding:18px;
    }
    #enterPanel {
      text-align:center;
      background: rgba(0,0,0,0.32);
      padding:20px;
      border-radius:15px;
      width:95%;
      max-width:420px;
      backdrop-filter: blur(8px);
    }
    #enterPanel .logo { max-width:160px; display:block; margin:0 auto 14px; border-radius:8px }
    #enterPanel h1{font-size:22px;color:#fff;margin-bottom:10px}
    #enterPanel p{color:#e6f2ff;margin-bottom:16px}
    #enterFsBtn {
      padding:14px 18px;border-radius:12px;border:none;
      background:#ffd600;color:#000;font-weight:700;font-size:18px;width:100%;
      box-shadow:0 6px 18px rgba(0,0,0,0.25);
    }

    /* ===== Tela de welcome com fundo personalizado (fundo_iniciar.png 4000x2250) ===== */
    #welcomeScreen {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: #111;
      background-size:cover;
      background-position:center center;
    }

    /* The start button must occupy the exact area in the 4000x2250 image:
       coords: 1726,1721 -> 3721,2134
       left = 1726/4000 = 43.15%
       top  = 1721/2250 = 76.49%
       width = (3721-1726)/4000 = 49.875% ~ 49.9%
       height = (2134-1721)/2250 = 18.4% (approx)
    */
    #startBtn {
      position: absolute;
      left: 43.15%;
      top: 76.49%;
      width: 49.875%;
      height: 18.4%;
      background: rgba(255,255,255,0.035);
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.06);
      /* make touch area clear but visually transparent â€” user presses on image area */
      display:block;
    }
    #startBtn:active { transform: translateY(1px); }

    /* optional halo to guide user (small pulse) */
    #startBtn.guide { box-shadow: 0 8px 30px rgba(11,132,255,0.12), inset 0 0 30px rgba(255,255,255,0.02); animation: pulse 2.2s infinite; }
    @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)} }

    /* ===== Camera / canvas / UI ===== */
    #videoEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none; z-index:5; transform: scaleX(-1);}
    #canvasEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none; z-index:6}
    #progress{position:fixed;left:50%;transform:translateX(-50%);top:18px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.55);font-weight:700;z-index:200}
    #countdown{position:fixed;left:50%;transform:translateX(-50%);top:28%;font-size:120px;font-weight:900;text-shadow:0 0 20px #000;color:#fff;z-index:201}
    #msg{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.55);z-index:200}

    /* Preview screen overlay */
    #previewScreen {
      position:fixed; inset:0; z-index:300; display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.88);
    }
    #previewContainer{position:relative;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
    #previewImage{max-width:100%;max-height:100%;object-fit:contain}
    .preview-buttons{position:absolute;bottom:38px;left:0;right:0;display:flex;gap:12px;justify-content:center;padding:0 20px;z-index:310}
    .preview-btn{padding:12px 18px;border-radius:10px;border:none;font-weight:700;cursor:pointer;font-size:16px;background:rgba(255,255,255,0.06);color:#fff}
    .btn-danger{background:rgba(220,53,69,0.9)}
    .btn-ok{background:rgba(40,167,69,0.9)}

    /* Thank screen */
    #thankScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#001e3c,#0b84ff);z-index:100}
    #thankBox{background:rgba(255,255,255,0.08);padding:20px;border-radius:14px;text-align:center;color:#fff}

    /* debug */
    #debugInfo{position:fixed;left:12px;bottom:12px;font-size:11px;color:#ccc;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:6px;z-index:999}
  </style>
</head>
<body>
  <!-- ENTRAR (primeira tela) -->
  <div id="enterFs">
    <div id="enterPanel">
      <img src="logo.png" class="logo" alt="Logo" onerror="this.style.display='none'">
      <h1>ðŸ“¸ Cabine FotogrÃ¡fica</h1>
      <p>Para melhor experiÃªncia, entre em tela cheia</p>
      <button id="enterFsBtn" type="button">ðŸŽ¬ Entrar em Tela Cheia</button>
    </div>
  </div>

  <!-- TELA DE INÃCIO PERSONALIZÃVEL: fundo_iniciar.png (4000x2250) -->
  <div id="welcomeScreen" class="hidden" aria-hidden="true" role="region" aria-label="Tela de InÃ­cio">
    <!-- startBtn Ã© o botÃ£o posicionado exatamente onde vocÃª pediu -->
    <button id="startBtn" title="Iniciar SessÃ£o" aria-label="Iniciar SessÃ£o"></button>
  </div>

  <!-- CAMERA / VIEW -->
  <video id="videoEl" autoplay playsinline muted></video>
  <canvas id="canvasEl"></canvas>

  <div id="progress" class="hidden" aria-hidden="true"></div>
  <div id="countdown" class="hidden" aria-hidden="true"></div>
  <div id="msg" class="hidden" aria-hidden="true"></div>

  <!-- PREVIEW -->
  <div id="previewScreen" class="hidden" aria-hidden="true">
    <div id="previewContainer">
      <img id="previewImage" src="" alt="Preview da foto">
      <div class="preview-buttons">
        <button id="refazerBtn" class="preview-btn btn-danger">ðŸ”„ Refazer</button>
        <button id="continuarBtn" class="preview-btn btn-ok">âœ… Continuar</button>
      </div>
    </div>
  </div>

  <!-- THANK -->
  <div id="thankScreen" class="hidden" aria-hidden="true">
    <div id="thankBox">
      <h2>âœ¨ Obrigado por utilizar a cabine!</h2>
      <p>Espere o operador encerrar a sessÃ£o.</p>
    </div>
  </div>

  <div id="debugInfo" aria-hidden="true"></div>

  <!-- sons opcionais -->
  <audio id="clack" src="clack.mp3" preload="auto"></audio>
  <audio id="inicio" src="inicio.mp3" preload="auto"></audio>
  <audio id="fim" src="fim.mp3" preload="auto"></audio>

  <script>
    /************************************************************************
     * celular.html (completo) - fluxo 3 fotos
     * - Front camera (facingMode: user)
     * - Enter Fullscreen -> welcome screen (fundo_iniciar.png) -> start
     * - Start -> camera -> 3x captura com preview (Refazer/Continuar)
     * - Envia photos array via socket 'photos_from_cell' (com retries)
     * - Robust visual feedback + debug logging
     **************************************************************************/

    // --------- ConfiguraÃ§Ãµes ----------
    const SERVER_URL = "festadodavi-production-0591.up.railway.app"; // preferencia do usuÃ¡rio
    const MAX_PHOTOS = 3;
    const COUNTDOWN_SECONDS = 5;

    // --------- Socket setup ----------
    const socket = io(SERVER_URL, {
      transports: ["websocket","polling"],
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1200,
      path: "/socket.io"
    });

    // --------- DOM refs ----------
    const enterFs = document.getElementById('enterFs');
    const enterFsBtn = document.getElementById('enterFsBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const startBtn = document.getElementById('startBtn');

    const videoEl = document.getElementById('videoEl');
    const canvasEl = document.getElementById('canvasEl');
    const progressEl = document.getElementById('progress');
    const countdownEl = document.getElementById('countdown');
    const msgEl = document.getElementById('msg');

    const previewScreen = document.getElementById('previewScreen');
    const previewImage = document.getElementById('previewImage');
    const refazerBtn = document.getElementById('refazerBtn');
    const continuarBtn = document.getElementById('continuarBtn');

    const thankScreen = document.getElementById('thankScreen');
    const debugInfo = document.getElementById('debugInfo');

    // --------- State ----------
    const params = new URLSearchParams(location.search);
    const session = params.get('session') || 'cabine-fixa';
    let stream = null;
    let photos = [];
    let currentPhotoIndex = 0;
    let currentPhotoData = null;
    let isCapturing = false;

    // debug updater
    setInterval(() => {
      debugInfo.textContent = `SessÃ£o: ${session} | Socket: ${socket.connected ? 'ðŸŸ¢' : 'ðŸ”´'} | Fotos: ${photos.length}/${MAX_PHOTOS} | Capturando: ${isCapturing ? 'SIM' : 'NÃƒO'}`;
    }, 700);

    // --------- Helpers UI ----------
    function showScreen(screenEl){
      // hide all main overlays first
      [enterFs, welcomeScreen, previewScreen, thankScreen].forEach(s=>{
        if(s) s.classList.add('hidden');
      });
      // hide camera overlays
      progressEl.classList.add('hidden'); countdownEl.classList.add('hidden'); msgEl.classList.add('hidden');
      // stop/hide video if no screen needs it (we will manage video visibility separately)
      if(screenEl === welcomeScreen || screenEl === enterFs) {
        // show background/welcome; stop camera if running
        stopCamera();
        videoEl.style.display = 'none';
      }
      // show requested
      if(screenEl) screenEl.classList.remove('hidden');
    }

    function showProgress(text){
      progressEl.textContent = text; progressEl.classList.remove('hidden');
    }
    function hideProgress(){ progressEl.classList.add('hidden'); }
    function showCountdown(text){ countdownEl.textContent = text; countdownEl.classList.remove('hidden'); }
    function hideCountdown(){ countdownEl.classList.add('hidden'); }

    // --------- Camera ----------
    async function startCamera(){
      try{
        // prefer front camera
        const constraints = { video: { facingMode: "user", width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = stream;
        videoEl.style.display = 'block';
        // mirror for natural preview
        videoEl.style.transform = 'scaleX(-1)';
        await videoEl.play().catch(()=>{ /* ignore play errors */ });
        // small delay to ensure real frames available
        await new Promise(r=>setTimeout(r,120));
      }catch(err){
        console.error('startCamera error', err);
        alert('NÃ£o foi possÃ­vel acessar a cÃ¢mera frontal. Verifique permissÃµes e tente novamente.');
        throw err;
      }
    }

    function stopCamera(){
      try {
        if(stream) {
          stream.getTracks().forEach(t=>t.stop());
          stream = null;
        }
      } catch(e){}
      videoEl.pause();
      videoEl.srcObject = null;
      videoEl.style.display = 'none';
    }

    // draw current video frame into canvas and return dataURL
    function grabFrameToDataURL(mirror=true, quality=0.95){
      const w = videoEl.videoWidth || Math.max(640, Math.round(window.innerWidth * devicePixelRatio));
      const h = videoEl.videoHeight || Math.max(480, Math.round(window.innerHeight * devicePixelRatio));
      canvasEl.width = w; canvasEl.height = h;
      const ctx = canvasEl.getContext('2d');
      // clear
      ctx.clearRect(0,0,w,h);
      if(mirror){
        ctx.save();
        ctx.translate(w,0); ctx.scale(-1,1);
        ctx.drawImage(videoEl,0,0,w,h);
        ctx.restore();
      } else {
        ctx.drawImage(videoEl,0,0,w,h);
      }
      const data = canvasEl.toDataURL('image/jpeg', quality);
      return data;
    }

    // --------- Capture flow ----------
    async function captureSinglePhotoFlow(){
      isCapturing = true;
      showProgress(`${currentPhotoIndex+1}/${MAX_PHOTOS}`);
      // ensure camera active & playing frames (sometimes video readyState can be 0)
      if(!stream) {
        await startCamera();
      } else {
        // ensure playing
        try { await videoEl.play().catch(()=>{}); } catch(e){}
      }
      videoEl.style.display = 'block';

      // countdown (visually show numbers then "ðŸ“¸" for last ticks)
      for(let t = COUNTDOWN_SECONDS; t > 0; t--){
        if(t <= 2){
          showCountdown('ðŸ“¸'); // emphasis on last 2
        } else {
          showCountdown(String(t));
        }
        // small clack sound on 2
        if(t === 2){
          try { document.getElementById('clack').currentTime = 0; document.getElementById('clack').play().catch(()=>{}); } catch(e){}
        }
        await new Promise(r=>setTimeout(r,1000));
      }
      hideCountdown();

      // Grab the frame into canvas and return dataURL
      const photoData = grabFrameToDataURL(true, 0.95);
      isCapturing = false;
      return photoData;
    }

    // --------- Sequence runner ----------
    async function runCaptureSequence(){
      try{
        // ensure camera is started
        await startCamera();
        // iterate until we have MAX_PHOTOS
        while(currentPhotoIndex < MAX_PHOTOS){
          // capture single
          const captured = await captureSinglePhotoFlow();
          currentPhotoData = captured;
          // show preview (pauses flow until user decides)
          await showPreviewAndAwaitDecision(captured);
          // loop continues inside continuation action
        }
        // after all photos taken:
        // cleanup & send
        stopCamera();
        showScreen(thankScreen);
        // emit to server
        sendPhotosToServerWithRetry(1,5);
      }catch(err){
        console.error('runCaptureSequence error', err);
        stopCamera();
        alert('Erro durante captura. Reinicie a sessÃ£o.');
        showScreen(welcomeScreen);
      }
    }

    // preview logic returns a promise resolved when user picks action
    function showPreviewAndAwaitDecision(photoData){
      return new Promise((resolve) => {
        previewImage.src = photoData;
        previewScreen.classList.remove('hidden');
        // disable autoplay of camera behind
        // bind handlers
        const onRefazer = async () => {
          // user wants to refazer same index: just hide preview and re-capture
          cleanup();
          // keep currentPhotoIndex unchanged
          resolve('refazer');
        };
        const onContinuar = async () => {
          // push photo and increment index
          photos.push(photoData);
          currentPhotoIndex++;
          cleanup();
          resolve('continuar');
        };
        function cleanup(){
          refazerBtn.removeEventListener('click', onRefazer);
          continuarBtn.removeEventListener('click', onContinuar);
          previewScreen.classList.add('hidden');
        }
        refazerBtn.addEventListener('click', onRefazer);
        continuarBtn.addEventListener('click', onContinuar);
      }).then(async (decision) => {
        // if refazer: simply re-run capture for same index
        if(decision === 'refazer'){
          // small pause so UI resets
          await new Promise(r=>setTimeout(r,180));
          // continue (caller will loop again)
        } else {
          // continuar chosen -> resume loop
        }
      });
    }

    // --------- Sending photos to server (with retry) ----------
    function sendPhotosToServerWithRetry(attempt = 1, maxAttempts = 5){
      if(!photos || photos.length === 0) return;
      showProgress('Enviando fotos...');
      const payload = { session, photos, ts: new Date().toISOString() };
      if(socket && socket.connected){
        try {
          socket.emit('photos_from_cell', payload, (ack) => {
            // optional ack handling
            hideProgress();
            console.log('photos_from_cell ack', ack);
          });
          // also keep retrying a few times to ensure delivery (idempotent)
          if(attempt < maxAttempts){
            setTimeout(()=> sendPhotosToServerWithRetry(attempt+1, maxAttempts), 1400 * attempt);
          }
        } catch(e){
          console.warn('emit error', e);
          hideProgress();
          if(attempt < maxAttempts) setTimeout(()=> sendPhotosToServerWithRetry(attempt+1, maxAttempts), 2000);
        }
      } else {
        // try reconnect and retry
        if(attempt < maxAttempts){
          socket.connect();
          setTimeout(()=> sendPhotosToServerWithRetry(attempt+1, maxAttempts), 1600);
        } else {
          hideProgress();
          alert('NÃ£o foi possÃ­vel enviar as fotos ao servidor. Verifique a conexÃ£o.');
        }
      }
    }

    // --------- Events wiring ----------
    // Enter fullscreen -> immediately show welcome screen with background
    enterFsBtn.addEventListener('click', async () => {
      try { await document.documentElement.requestFullscreen(); } catch(e){ console.warn('requestFullscreen failed', e); }
      // set the welcome background image if exists (fundo_iniciar.png)
      welcomeScreen.style.backgroundImage = "url('fundo_iniciar.png')";
      welcomeScreen.style.backgroundSize = 'cover';
      welcomeScreen.style.backgroundPosition = 'center center';
      // show welcome screen
      showScreen(welcomeScreen);
      // small guide on start button
      startBtn.classList.add('guide');
      // notify server that a phone entered fullscreen (optional)
      if(socket && socket.connected){
        socket.emit('cell_entered_fullscreen', { session });
      }
    });

    // Start button on the image area -> launch capture flow directly
    startBtn.addEventListener('click', async () => {
      startBtn.classList.remove('guide');
      // Play music feedback
      try { document.getElementById('inicio').currentTime = 0; document.getElementById('inicio').play().catch(()=>{}); } catch(e){}
      // go to capture flow: hide welcome UI, show camera
      showScreen(null); // hide overlays (camera view)
      // start camera + reset states
      currentPhotoIndex = 0;
      photos = [];
      currentPhotoData = null;
      await startCamera();
      // run capture sequence
      await runCaptureSequence();
    });

    // socket events (basic)
    socket.on('connect', () => {
      console.log('socket connected', socket.id);
      // inform server which session this cell belongs to
      socket.emit('cell_connected', { session, id: socket.id });
    });
    socket.on('disconnect', () => {
      console.log('socket disconnected');
    });
    socket.on('reset_session', (data) => {
      // server requested reset
      stopCamera();
      photos = []; currentPhotoIndex = 0; currentPhotoData = null;
      showScreen(welcomeScreen);
    });

    // preview controls fallback (keyboard ESC to cancel preview)
    document.addEventListener('keydown', (ev) => {
      if(ev.key === 'Escape'){
        // if preview visible, close it
        if(!previewScreen.classList.contains('hidden')){
          previewScreen.classList.add('hidden');
        }
      }
    });

    // ensure click on welcomeScreen outside button doesn't do anything accidental
    welcomeScreen.addEventListener('click', (ev) => {
      if(ev.target === welcomeScreen){
        // do nothing (force user to click the visible button)
      }
    });

    // initial UI
    showScreen(enterFs);

    // safety: if user leaves page, stop camera
    window.addEventListener('visibilitychange', () => {
      if(document.hidden) stopCamera();
    });

    // expose debug helpers to window for manual testing
    window._cabine = {
      startCamera: async () => { await startCamera(); },
      stopCamera: () => { stopCamera(); },
      grabFrame: () => grabFrameToDataURL(),
      photosState: () => photos.slice()
    };
  </script>
</body>
</html>
