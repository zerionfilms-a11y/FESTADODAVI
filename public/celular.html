<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
    button{cursor:pointer}
    .hidden{display:none!important}
    .visible{display:flex!important}

    /* ENTER FULLSCREEN */
    #enterFs{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#001e3c,#0b84ff);padding:18px;z-index:1000}
    #enterPanel{width:95%;max-width:420px;background:rgba(0,0,0,0.32);padding:20px;border-radius:12px;text-align:center;backdrop-filter:blur(8px)}
    #enterPanel .logo{max-width:140px;margin:0 auto 12px;display:block}
    #enterPanel h1{color:#fff;margin-bottom:8px}
    #enterPanel p{color:#dfefff;margin-bottom:14px}
    #enterFsBtn{padding:12px 16px;border-radius:10px;border:none;background:#ffd600;color:#000;font-weight:700;font-size:18px;width:100%}

    /* WELCOME SCREEN (with a real IMG as background) */
    #welcomeScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#111;padding:0;overflow:hidden}
    #welcomeBg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;display:block;z-index:1}
    /* Start button absolute on top of image using your coords mapping (4000x2250) */
    #startBtn {
      position:absolute;
      left:43.15%;
      top:76.49%;
      width:49.9875%;
      height:18.4%;
      border-radius:12px; border:2px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.18);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:22px;letter-spacing:0.6px;
      text-transform:uppercase;
      z-index:50;
    }
    #startBtn .label{ pointer-events:none }

    /* Video & canvas */
    #videoEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;z-index:5;transform:scaleX(-1)}
    #canvasEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;z-index:6}
    #progress{position:fixed;left:50%;transform:translateX(-50%);top:18px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.55);font-weight:700;z-index:200}
    #countdown{position:fixed;left:50%;transform:translateX(-50%);top:28%;font-size:120px;font-weight:900;text-shadow:0 0 20px #000;color:#fff;z-index:201}
    #msg{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.55);z-index:200}

    /* Preview overlay */
    #previewScreen{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9)}
    #previewContainer{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    #previewImage{max-width:100%;max-height:100%;object-fit:contain}
    .preview-buttons{position:absolute;bottom:36px;left:0;right:0;display:flex;gap:12px;justify-content:center;padding:0 20px}
    .preview-btn{padding:12px 18px;border-radius:10px;border:none;font-weight:700;cursor:pointer;font-size:16px;background:rgba(255,255,255,0.06);color:#fff}
    .btn-danger{background:rgba(220,53,69,0.9)}
    .btn-ok{background:rgba(40,167,69,0.9)}

    /* VISUALIZER overlay (QR or iframe video) */
    #visualizerOverlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.96);display:none;flex-direction:column;align-items:center;justify-content:center;padding:18px}
    #vizContainer{width:100%;max-width:920px;height:70vh;background:#111;border-radius:12px;display:flex;align-items:center;justify-content:center;position:relative}
    #vizIframe{width:100%;height:100%;border:0;border-radius:8px;background:#000}
    #vizQR{position:absolute;right:14px;bottom:14px;width:180px;height:180px;background:#fff;padding:8px;border-radius:8px;display:flex;align-items:center;justify-content:center}
    #vizNotice{margin-top:14px;color:#ddd;font-size:16px;text-align:center}
    #vizLockNote{position:absolute;left:12px;top:12px;color:#f77;font-weight:700;font-size:13px}

    /* thank screen */
    #thankScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#001e3c,#0b84ff);z-index:100}
    #thankBox{background:rgba(255,255,255,0.08);padding:18px;border-radius:12px;text-align:center;color:#fff}

    /* debug */
    #debugInfo{position:fixed;left:12px;bottom:12px;font-size:11px;color:#ccc;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:6px;z-index:999}
    @media (max-width:480px){
      #startBtn{font-size:18px}
      #countdown{font-size:72px; top:24%}
      #vizContainer{height:58vh}
    }
  </style>
</head>
<body>
  <!-- ENTER FULLSCREEN -->
  <div id="enterFs" role="dialog" aria-label="Entrar em tela cheia">
    <div id="enterPanel">
      <img src="logo.png" class="logo" alt="Logo" onerror="this.style.display='none'">
      <h1>ðŸ“¸ Cabine FotogrÃ¡fica</h1>
      <p>Para melhor experiÃªncia, entre em tela cheia</p>
      <button id="enterFsBtn" type="button">ðŸŽ¬ Entrar em Tela Cheia</button>
    </div>
  </div>

  <!-- WELCOME SCREEN - com IMG real como fundo -->
  <div id="welcomeScreen" class="hidden" aria-hidden="true">
    <img id="welcomeBg" src="iniciar.png" alt="Fundo iniciar" onerror="onWelcomeBgError()" />
    <button id="startBtn" aria-label="Iniciar SessÃ£o"><span class="label">INICIAR SESSÃƒO</span></button>
  </div>

  <!-- camera and canvas -->
  <video id="videoEl" autoplay playsinline muted></video>
  <canvas id="canvasEl"></canvas>

  <div id="progress" class="hidden" aria-hidden="true"></div>
  <div id="countdown" class="hidden" aria-hidden="true"></div>
  <div id="msg" class="hidden" aria-hidden="true"></div>

  <!-- preview -->
  <div id="previewScreen" class="hidden" aria-hidden="true">
    <div id="previewContainer">
      <img id="previewImage" src="" alt="Preview da foto">
      <div class="preview-buttons">
        <button id="refazerBtn" class="preview-btn btn-danger">ðŸ”„ Refazer</button>
        <button id="continuarBtn" class="preview-btn btn-ok">âœ… Continuar</button>
      </div>
    </div>
  </div>

  <!-- visualizer overlay (shows iframe or QR) -->
  <div id="visualizerOverlay" aria-hidden="true">
    <div id="vizContainer">
      <div id="vizLockNote">Aguardando finalizaÃ§Ã£o no Index â€” visualizador travado atÃ© o operador finalizar</div>
      <iframe id="vizIframe" src="about:blank" title="Visualizador"></iframe>
      <div id="vizQR"><canvas id="vizQrCanvas" width="160" height="160"></canvas></div>
    </div>
    <div id="vizNotice">Aguarde â€” a sessÃ£o sÃ³ serÃ¡ liberada quando o operador finalizar.</div>
  </div>

  <!-- thank -->
  <div id="thankScreen" class="hidden" aria-hidden="true">
    <div id="thankBox">
      <h2>âœ¨ Obrigado por utilizar a cabine!</h2>
      <p>Espere o operador encerrar a sessÃ£o.</p>
    </div>
  </div>

  <div id="debugInfo" aria-hidden="true"></div>

  <!-- optional sounds -->
  <audio id="clack" src="clack.mp3" preload="auto"></audio>
  <audio id="inicio" src="inicio.mp3" preload="auto"></audio>
  <audio id="fim" src="fim.mp3" preload="auto"></audio>

  <script>
    /* ---------- Config ---------- */
    // <<< ALTERAÃ‡ÃƒO: coloquei a URL com protocolo para evitar problemas de construÃ§Ã£o de URLs / socket.io
    const SERVER_URL = "https://festadodavi-production-0591.up.railway.app";
    const MAX_PHOTOS = 3;
    const COUNTDOWN_SECONDS = 5;

    /* ---------- Socket ---------- */
    const socket = io(SERVER_URL, {
      transports: ["websocket","polling"],
      reconnection: true,
      path: "/socket.io"
    });

    /* ---------- DOM ---------- */
    const enterFs = document.getElementById('enterFs');
    const enterFsBtn = document.getElementById('enterFsBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const startBtn = document.getElementById('startBtn');
    const welcomeBg = document.getElementById('welcomeBg');

    const videoEl = document.getElementById('videoEl');
    const canvasEl = document.getElementById('canvasEl');
    const progressEl = document.getElementById('progress');
    const countdownEl = document.getElementById('countdown');
    const msgEl = document.getElementById('msg');

    const previewScreen = document.getElementById('previewScreen');
    const previewImage = document.getElementById('previewImage');
    const refazerBtn = document.getElementById('refazerBtn');
    const continuarBtn = document.getElementById('continuarBtn');

    const visualizerOverlay = document.getElementById('visualizerOverlay');
    const vizIframe = document.getElementById('vizIframe');
    const vizQrCanvas = document.getElementById('vizQrCanvas');

    const thankScreen = document.getElementById('thankScreen');
    const debugInfo = document.getElementById('debugInfo');

    /* ---------- State ---------- */
    const params = new URLSearchParams(location.search);
    const session = params.get('session') || 'cabine-fixa';
    let stream = null;
    let photos = [];
    let currentPhotoIndex = 0;
    let currentPhotoData = null;
    let isCapturing = false;
    let visualizerLocked = false; // quando true, celular fica preso na tela do visualizador atÃ© finalizaÃ§Ã£o do index

    /* debug */
    setInterval(() => {
      debugInfo.textContent = `SessÃ£o: ${session} | Socket: ${socket.connected ? 'ðŸŸ¢' : 'ðŸ”´'} | Fotos: ${photos.length}/${MAX_PHOTOS} | Capturando: ${isCapturing ? 'SIM' : 'NÃƒO'} | VizLocked: ${visualizerLocked ? 'SIM' : 'NÃƒO'}`;
    }, 700);

    /* ---------- Helpers ---------- */
    function onWelcomeBgError(){
      console.warn('Falha ao carregar iniciar.png â€” verifique o caminho/nome (case-sensitive).');
      debugInfo.textContent = 'Erro: iniciar.png nÃ£o encontrado. Coloque iniciar.png na mesma pasta do celular.html (verifique maiÃºsculas/minÃºsculas).';
      welcomeBg.style.display = 'none';
    }

    function showScreen(screenEl){
      [enterFs, welcomeScreen, previewScreen, thankScreen].forEach(s => s && s.classList.add('hidden'));
      progressEl.classList.add('hidden'); countdownEl.classList.add('hidden'); msgEl.classList.add('hidden');
      if(screenEl === welcomeScreen || screenEl === enterFs) stopCamera();
      if(screenEl) screenEl.classList.remove('hidden');
    }
    function showProgress(text){ progressEl.textContent = text; progressEl.classList.remove('hidden'); }
    function hideProgress(){ progressEl.classList.add('hidden'); }
    function showCountdown(text){ countdownEl.textContent = text; countdownEl.classList.remove('hidden'); }
    function hideCountdown(){ countdownEl.classList.add('hidden'); }

    /* ---------- Camera ---------- */
    async function startCamera(){
      try{
        const constraints = { video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = stream;
        videoEl.style.display = 'block';
        videoEl.style.transform = 'scaleX(-1)';
        await videoEl.play().catch(()=>{});
        await new Promise(r=>setTimeout(r,100));
      }catch(err){
        console.error('startCamera', err);
        alert('NÃ£o foi possÃ­vel acessar a cÃ¢mera frontal. Verifique permissÃµes.');
        throw err;
      }
    }

    function stopCamera(){
      try{
        if(stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
      }catch(e){}
      try{ videoEl.pause(); videoEl.srcObject = null; }catch(e){}
      videoEl.style.display = 'none';
    }

    function grabFrameDataURL(quality=0.95){
      const w = videoEl.videoWidth || 3264;
      const h = videoEl.videoHeight || 1836;
      canvasEl.width = w; canvasEl.height = h;
      const ctx = canvasEl.getContext('2d');
      ctx.clearRect(0,0,w,h);
      ctx.save();
      ctx.translate(w,0); ctx.scale(-1,1);
      ctx.drawImage(videoEl, 0, 0, w, h);
      ctx.restore();
      return canvasEl.toDataURL('image/jpeg', quality);
    }

    /* ---------- Capture flow ---------- */
    async function captureSinglePhotoFlow(){
      isCapturing = true;
      showProgress(`${currentPhotoIndex+1}/${MAX_PHOTOS}`);
      if(!stream) await startCamera();
      videoEl.style.display = 'block';

      for(let t = COUNTDOWN_SECONDS; t > 0; t--){
        if(t <= 2){ showCountdown('ðŸ“¸'); }
        else { showCountdown(String(t)); }
        if(t === 2){
          try { document.getElementById('clack').currentTime = 0; document.getElementById('clack').play().catch(()=>{}); } catch(e){}
        }
        await new Promise(r=>setTimeout(r,1000));
      }
      hideCountdown();
      const data = grabFrameDataURL(0.95);
      isCapturing = false;
      return data;
    }

    async function runCaptureSequence(){
      try{
        await startCamera();
        while(currentPhotoIndex < MAX_PHOTOS && !visualizerLocked){
          currentPhotoData = await captureSinglePhotoFlow();
          await showPreviewAndAwaitDecision(currentPhotoData);
        }
        // Se travou no visualizer enquanto capturava, a lÃ³gica de envio/finalizaÃ§Ã£o Ã© feita via eventos socket
        if(!visualizerLocked){
          stopCamera();
          showScreen(thankScreen);
          await sendPhotosToServerWithRetry(1,5);
        } else {
          // se bloqueado, aguardamos finalizar pelo index; ainda enviamos as fotos imediatamente para o index para processar
          await sendPhotosToServerWithRetry(1,5);
        }
      }catch(err){
        console.error('runCaptureSequence error', err);
        stopCamera();
        alert('Erro durante captura. Reinicie a sessÃ£o.');
        showScreen(welcomeScreen);
      }
    }

    function showPreviewAndAwaitDecision(photoData){
      return new Promise((resolve) => {
        previewImage.src = photoData;
        previewScreen.classList.remove('hidden');

        const onRef = () => { cleanup(); resolve('refazer'); };
        const onCont = () => { cleanup(); photos.push(photoData); currentPhotoIndex++; resolve('continuar'); };
        function cleanup(){ refazerBtn.removeEventListener('click', onRef); continuarBtn.removeEventListener('click', onCont); previewScreen.classList.add('hidden'); }
        refazerBtn.addEventListener('click', onRef);
        continuarBtn.addEventListener('click', onCont);
      });
    }

    /* ---------- Send photos to server (socket ack + retry + HTTP fallback) ---------- */
    function sendPhotosToServerWithRetry(attempt=1, maxAttempts=5){
      return new Promise((resolve, reject) => {
        if(!photos || photos.length === 0) return resolve({ ok:false, reason:'no-photos' });
        showProgress('Enviando fotos...');
        const payload = { session, photos, ts:new Date().toISOString() };

        function tryHttpFallback(){
          const url = new URL('/upload_photos', SERVER_URL);
          fetch(url.toString(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(res => res.json()).then(json => {
            hideProgress();
            resolve({ ok:true, via:'http', resp:json });
          }).catch(err => {
            hideProgress();
            console.warn('HTTP fallback failed', err);
            reject(err);
          });
        }

        if(socket && socket.connected){
          try{
            socket.timeout(10000).emit('photos_from_cell', payload, (err, ack) => {
              if(err){
                console.warn('socket emit timeout/err', err);
                if(attempt < maxAttempts){
                  setTimeout(()=> sendPhotosToServerWithRetry(attempt+1,maxAttempts).then(resolve).catch(reject), 1200 * attempt);
                } else {
                  tryHttpFallback();
                }
              } else {
                // ðŸ”§ CORREÃ‡ÃƒO: apÃ³s envio bem-sucedido, avisamos o INDEX/SERVIDOR com 'photos_ready'
                try {
                  socket.emit('photos_ready', {
                    session,
                    uploaded: photos,
                    visualizadorUrl: `${SERVER_URL}/visualizador/${encodeURIComponent(session)}`
                  });
                } catch(e){
                  console.warn('emit local photos_ready falhou', e);
                }

                hideProgress();
                resolve({ ok:true, via:'socket', ack });
              }
            });
          }catch(e){
            console.warn('socket emit exception', e);
            if(attempt < maxAttempts){
              setTimeout(()=> sendPhotosToServerWithRetry(attempt+1,maxAttempts).then(resolve).catch(reject), 1200 * attempt);
            } else {
              tryHttpFallback();
            }
          }
        } else {
          if(attempt < maxAttempts){
            socket.connect();
            setTimeout(()=> sendPhotosToServerWithRetry(attempt+1,maxAttempts).then(resolve).catch(reject), 1500);
          } else {
            tryHttpFallback();
          }
        }
      });
    }

    /* ---------- Visualizer lock flow (novo) ---------- */
    function showVisualizerOverlay({ visualizerUrl, qrUrl }){
      visualizerLocked = true;
      // pause camera for CPU and privacy
      stopCamera();
      // block interactions
      visualizerOverlay.style.display = 'flex';
      visualizerOverlay.setAttribute('aria-hidden','false');
      // set iframe src
      try { vizIframe.src = visualizerUrl || 'about:blank'; } catch(e){ vizIframe.src = 'about:blank'; }
      // draw QR if supplied
      if(qrUrl){
        try {
          const ctx = vizQrCanvas.getContext('2d');
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => {
            ctx.clearRect(0,0,vizQrCanvas.width,vizQrCanvas.height);
            const sx = img.width, sy = img.height;
            const scale = Math.min(vizQrCanvas.width / sx, vizQrCanvas.height / sy);
            const w = sx * scale, h = sy * scale;
            ctx.drawImage(img, (vizQrCanvas.width - w)/2, (vizQrCanvas.height - h)/2, w, h);
          };
          img.onerror = () => {
            ctx.clearRect(0,0,vizQrCanvas.width,vizQrCanvas.height);
            ctx.fillStyle='#000'; ctx.fillRect(0,0,vizQrCanvas.width,vizQrCanvas.height);
            ctx.fillStyle='#fff'; ctx.font='12px Arial'; ctx.fillText('QR',20,20);
          };
          img.src = qrUrl;
        } catch(e){
          console.warn('erro desenhando qr', e);
        }
      } else {
        const ctx = vizQrCanvas.getContext('2d');
        ctx.clearRect(0,0,vizQrCanvas.width,vizQrCanvas.height);
      }

      // ensure UI elements disabled while locked
      enterFsBtn.disabled = true;
      startBtn.disabled = true;
    }

    function hideVisualizerOverlay(){
      visualizerLocked = false;
      visualizerOverlay.style.display = 'none';
      visualizerOverlay.setAttribute('aria-hidden','true');
      vizIframe.src = 'about:blank';
      // re-enable UI
      enterFsBtn.disabled = false;
      startBtn.disabled = false;
      // return to welcome screen
      showScreen(welcomeScreen);
    }

    /* ---------- Events wiring ---------- */
    enterFsBtn.addEventListener('click', async () => {
      try { await document.documentElement.requestFullscreen(); } catch(e){ console.warn('fullscreen failed', e); }
      if(!visualizerLocked) showScreen(welcomeScreen);
      if(socket && socket.connected) socket.emit('cell_entered_fullscreen', { session });
    });

    startBtn.addEventListener('click', async () => {
      if(visualizerLocked) return; // bloqueado
      try { document.getElementById('inicio').currentTime = 0; document.getElementById('inicio').play().catch(()=>{}); } catch(e){}
      showScreen(null); // hide overlays -> camera
      currentPhotoIndex = 0; photos = []; currentPhotoData = null;
      await runCaptureSequence();
    });

    // socket basic events
    socket.on('connect', () => {
      console.log('socket connected', socket.id);
      if(session) socket.emit('cell_connected', { session, id: socket.id });
    });
    socket.on('disconnect', () => { console.log('socket disconnected'); });

    // servidor diz "mostra o visualizador e trava o celular atÃ© eu finalizar"
    socket.on('visualizer_ready', (data) => {
      if(!data) return;
      if(data.session && data.session !== session) return;
      showVisualizerOverlay({ visualizerUrl: data.visualizerUrl || data.visualizadorUrl || data.url, qrUrl: data.qrUrl || data.qrcode || data.qr });
    });

    // novo: server pode emitir show_qr_on_viewer (index uses this)
    socket.on('show_qr_on_viewer', (data) => {
      if(!data) return;
      // server typically sends { viewerId, visualizadorUrl }
      const url = data.visualizadorUrl || data.visualizerUrl || data.url || data.visualizador;
      const qr = data.visualizadorUrl || data.qrUrl || data.qrcode || data.qr;
      if(data.session && data.session !== session) {
        // ignore if for other session
        // but many server implementations won't include session here, so we accept
      }
      showVisualizerOverlay({ visualizerUrl: url, qrUrl: qr || url });
    });

    // server may send show_qr (compat)
    socket.on('show_qr', ({ visualizadorUrl }) => {
      if(!visualizadorUrl) return;
      showVisualizerOverlay({ visualizerUrl: visualizadorUrl, qrUrl: visualizadorUrl });
    });

    // servidor finaliza sessÃ£o â€” libera celular
    socket.on('finalize_session', (data) => {
      if(data && data.session && data.session !== session) return;
      console.log('finalize_session received, unlocking celular');
      hideVisualizerOverlay();
      photos = []; currentPhotoIndex = 0; currentPhotoData = null;
    });
    // tambÃ©m aceita 'reset_session' para compatibilidade
    socket.on('reset_session', (data) => {
      if(data && data.session && data.session !== session) return;
      console.log('reset_session received, unlocking celular');
      hideVisualizerOverlay();
      photos = []; currentPhotoIndex = 0; currentPhotoData = null;
    });

    // keyboard escape hides preview if shown (but not visualizer when locked)
    document.addEventListener('keydown', ev => {
      if(ev.key === 'Escape'){
        if(!previewScreen.classList.contains('hidden')) previewScreen.classList.add('hidden');
      }
    });

    // initial state
    showScreen(enterFs);

    // stop camera on page hide
    document.addEventListener('visibilitychange', () => {
      if(document.hidden) stopCamera();
    });

    // expose helpers for debug
    window._cabine = {
      startCamera: async ()=> await startCamera(),
      stopCamera: ()=> stopCamera(),
      grabFrame: ()=> grabFrameDataURL(),
      photos: ()=> photos.slice(),
      unlockVisualizer: ()=> hideVisualizerOverlay()
    };
  </script>
</body>
</html>
