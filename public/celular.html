<!doctype html>

<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
    .screen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:15px}
    #enterFsBtn{padding:18px 25px;border-radius:12px;border:none;background:#ffd600;color:#000;font-weight:700;cursor:pointer;font-size:20px;margin:15px;width:90%;max-width:300px}
    #welcome{background:rgba(255,255,255,0.15);padding:25px;text-align:center;border-radius:15px;width:95%;max-width:400px;backdrop-filter:blur(15px);border:2px solid rgba(255,255,255,0.3)}
    #startBtn{padding:20px 28px;border-radius:14px;border:none;background:#b07e09;color:#fff;font-weight:800;cursor:pointer;font-size:22px;margin-top:12px;box-shadow:0 6px 18px rgba(0,0,0,0.35);width:100%;max-width:340px;transition:all 0.25s ease}
    .logo{max-width:180px;margin-bottom:20px;border-radius:10px}
    #videoEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;z-index:1}
    #canvasEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;z-index:1}
    #progress{position:fixed;top:20px;left:0;right:0;text-align:center;font-size:28px;font-weight:700;z-index:150;color:#fff;text-shadow:0 0 10px #000;background:rgba(0,0,0,0.5);padding:10px;backdrop-filter:blur(5px)}
    #countdown{position:fixed;top:30%;left:0;right:0;text-align:center;font-size:120px;font-weight:800;text-shadow:0 0 20px #000, 0 0 30px #000;z-index:200;color:#ffffff;pointer-events:none}
    #msg{position:fixed;top:50%;left:0;right:0;text-align:center;font-size:28px;font-weight:700;z-index:100;color:#fff;text-shadow:0 0 10px #000}
    #previewScreen{background:rgba(0,0,0,0.9);z-index:300;padding:0}
    #previewContainer{position:relative;width:100%;height:100%;display:flex;flex-direction:column}
    #previewImage{width:100%;height:100%;object-fit:contain;display:block;transform: none;}
    .preview-buttons{position:absolute;bottom:30px;left:0;right:0;display:flex;gap:15px;justify-content:center;padding:0 20px;z-index:310}
    .preview-btn{padding:12px 18px;border-radius:8px;border:none;font-weight:700;cursor:pointer;font-size:16px;flex:1;max-width:140px;background:rgba(0,0,0,0.7);color:white;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.3)}
    #refazerBtn{background:rgba(220,53,69,0.8)}
    #continuarBtn{background:rgba(40,167,69,0.8)}
    #thank { background: rgba(255,255,255,0.15); padding: 25px; border-radius: 15px; width:95%;max-width:400px;text-align:center;backdrop-filter:blur(15px);border:2px solid rgba(255,255,255,0.3)}
    .hidden { display: none !important; }
    .visible { display: flex !important; }
    #debugInfo {position:fixed;bottom:10px;left:10px;font-size:10px;color:#888;background:rgba(0,0,0,0.7);padding:4px;border-radius:4px;z-index:1000;white-space:pre-line;max-width:46%}
    .qr-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:400; opacity:0; pointer-events:none; transition:opacity 280ms cubic-bezier(.2,.9,.2,1); }
    .qr-overlay.visible { opacity:1; pointer-events:auto; }
    .qr-backdrop { position:absolute; inset:0; backdrop-filter:blur(10px); background: rgba(0,0,0,0.45); }
    .qr-modal { position:relative; background:rgba(255,255,255,0.98); padding:18px; border-radius:12px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.4); max-width:90%; width:360px; transform:translateY(12px) scale(.98); transition:transform 260ms cubic-bezier(.2,.9,.2,1); }
    .qr-overlay.visible .qr-modal { transform:translateY(0) scale(1); }
    .qr-modal canvas { width:260px; height:260px; object-fit:contain; display:block; margin:0 auto 12px; background:#fff; border-radius:6px; }
    @media (max-width:480px){ #countdown { font-size:84px } }
  </style>
</head>
<body>
  <div id="enterFs" class="screen visible" style="background:linear-gradient(135deg,#fff,#f5f5f5);">
    <div style="text-align:center;background:rgba(0,0,0,0.03);padding:20px;border-radius:15px;backdrop-filter:blur(10px);width:95%;max-width:400px">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <h1 style="font-size:24px;margin-bottom:20px;color:#222">ðŸ“¸ Cabine FotogrÃ¡fica</h1>
      <p style="font-size:16px;margin-bottom:20px;color:#444">Para melhor experiÃªncia, entre em tela cheia</p>
      <button id="enterFsBtn">ðŸŽ¬ Entrar em Tela Cheia</button>
    </div>
  </div>

  <div id="welcomeScreen" class="screen hidden" style="background:linear-gradient(135deg,#fff,#f7f7f7)">
    <div id="welcome">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <h1 style="color:#222">ðŸ“¸ Bem-vindo Ã  Cabine FotogrÃ¡fica</h1>
      <p style="color:#444">Clique abaixo para iniciar</p>
      <button id="startBtn">ðŸŽ¬ Iniciar SessÃ£o de Fotos</button>
    </div>
  </div>

<canvas id="canvasEl"></canvas> <video id="videoEl" autoplay playsinline muted></video>

  <div id="progress" class="hidden"></div>
  <div id="countdown"></div>
  <div id="msg"></div>

  <div id="previewScreen" class="screen hidden">
    <div id="previewContainer">
      <img id="previewImage" src="" alt="Preview da foto">
      <div class="preview-buttons">
        <button id="refazerBtn" class="preview-btn">ðŸ”„ Refazer</button>
        <button id="continuarBtn" class="preview-btn">âœ… Continuar</button>
      </div>
    </div>
  </div>

  <div id="thankScreen" class="screen hidden" style="background:linear-gradient(135deg,#fff,#f7f7f7)">
    <div id="thank">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <h1 style="color:#222">âœ¨ Obrigado por utilizar a cabine!</h1>
      <p style="color:#444">Espere o operador encerrar a sessÃ£o.</p>
    </div>
  </div>

  <div id="qrOverlay" class="qr-overlay hidden" aria-hidden="true">
    <div class="qr-backdrop"></div>
    <div class="qr-modal" role="dialog" aria-modal="true">
      <div id="qrTitle" style="font-weight:700;margin-bottom:8px;color:#222">Escaneie o QR para ver suas fotos</div>
      <canvas id="qrCanvas" width="260" height="260"></canvas>
      <div style="font-size:14px;color:#333;margin-top:6px">As fotos ficarÃ£o disponÃ­veis por 7 dias</div>
    </div>
  </div>

  <div id="debugInfo"></div>

<audio id="clack" src="clack.mp3" preload="auto"></audio> <audio id="inicio" src="inicio.mp3" preload="auto"></audio> <audio id="fim" src="fim.mp3" preload="auto"></audio>

  <script>
/* ==================== CONFIG ====================
   Controle a orientaÃ§Ã£o exibida (ao vivo + preview)
   - true = tudo espelhado (mirror) â€” recomendado para placas legÃ­veis
   - false = tudo normal (not mirrored)
*/
const DISPLAY_MIRROR = true; // <-- altere aqui para false se quiser tudo normal
/* ================================================= */

(function(){
  const SERVER_URL = "https://festadodavi-production.up.railway.app";
  const socket = io(SERVER_URL, {
    transports: ['polling','websocket'],
    reconnection: true,
    reconnectionAttempts: 10,
    reconnectionDelay: 1000,
    timeout: 20000,
    withCredentials: true,
    path: '/socket.io'
  });

  const params = new URLSearchParams(location.search);
  const session = params.get('session') || 'cabine-fixa';

  // DOM refs
  const debugEl = document.getElementById('debugInfo');
  const enterFsBtn = document.getElementById('enterFsBtn');
  const welcomeScreen = document.getElementById('welcomeScreen');
  const startBtn = document.getElementById('startBtn');
  const canvasEl = document.getElementById('canvasEl');
  const videoEl = document.getElementById('videoEl');
  const progressEl = document.getElementById('progress');
  const countdownEl = document.getElementById('countdown');
  const previewScreen = document.getElementById('previewScreen');
  const previewImage = document.getElementById('previewImage');
  const refazerBtn = document.getElementById('refazerBtn');
  const continuarBtn = document.getElementById('continuarBtn');
  const thankScreen = document.getElementById('thankScreen');
  const clack = document.getElementById('clack');
  const inicio = document.getElementById('inicio');
  const fim = document.getElementById('fim');
  const qrOverlay = document.getElementById('qrOverlay');
  const qrCanvas = document.getElementById('qrCanvas');

  // state
  let stream = null;
  let photos = [];
  let currentPhotoIndex = 0;
  let currentPhotoData = null;
  let mode = 'idle';
  let streamImageLoader = null;
  let lastFrameTs = 0;

  // debug panel
  setInterval(()=> {
    debugEl.textContent = `SessÃ£o: ${session}\nSocket: ${socket.connected ? 'ðŸŸ¢ conectado' : 'ðŸ”´ desconectado'}\nModo: ${mode}\nFotos capturadas: ${photos.length}`;
  }, 900);

  // UI helpers
  function showScreen(screenElement){
    const enterFs = document.getElementById('enterFs');
    [enterFs,welcomeScreen,previewScreen,thankScreen].forEach(s=>{
      if(s){ s.classList.add('hidden'); s.classList.remove('visible'); s.style.display='none'; }
    });
    canvasEl.style.display = 'none';
    countdownEl.textContent = '';
    progressEl.classList.add('hidden');
    if(screenElement){ screenElement.classList.remove('hidden'); screenElement.classList.add('visible'); screenElement.style.display='flex'; }
  }
  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
  showScreen(document.getElementById('enterFs'));

  // Draw live frames (mirror or not depending on DISPLAY_MIRROR)
  function drawFrameToCanvas(dataUrl){
    if(!dataUrl) return;
    const now = Date.now();
    if (now - lastFrameTs < 12) {}
    lastFrameTs = now;

    if (streamImageLoader) {
      try { streamImageLoader.onload = null; streamImageLoader.onerror = null; } catch(e){}
    }
    const img = new Image();
    streamImageLoader = img;
    img.onload = () => {
      if (mode !== 'capturing') return;
      const ctx = canvasEl.getContext('2d');
      canvasEl.width = window.innerWidth;
      canvasEl.height = window.innerHeight;
      const scale = Math.max(canvasEl.width / img.width, canvasEl.height / img.height);
      const w = img.width * scale, h = img.height * scale;
      const dx = (canvasEl.width - w) / 2;
      const dy = (canvasEl.height - h) / 2;

      ctx.clearRect(0,0,canvasEl.width,canvasEl.height);
      ctx.save();
      if (DISPLAY_MIRROR) {
        // desenha espelhado (como um espelho)
        ctx.translate(canvasEl.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(img, dx, dy, w, h);
      } else {
        // desenha normal
        ctx.drawImage(img, dx, dy, w, h);
      }
      ctx.restore();
      canvasEl.style.display = 'block';
    };
    img.onerror = () => {};
    img.src = dataUrl;
  }

  // Socket events
  socket.on('connect', () => {
    logDebug('connected to server: ' + socket.id);
    socket.emit('join_session', { session, role: 'viewer' });
    socket.emit('request_stream', { session, viewerId: socket.id });
  });

  socket.on('disconnect', (reason) => { logDebug('socket disconnected: ' + reason); });

  socket.on('stream_frame', ({ session: s, frame }) => {
    if (s && s !== session) return;
    if (mode === 'capturing') {
      try { drawFrameToCanvas(frame); } catch(e) { console.warn('draw err', e); }
    }
  });

  socket.on('stream_pending', ({ session: s }) => {
    if (s && s !== session) return;
    if (mode === 'capturing') {
      progressEl.textContent = 'Aguardando cÃ¢mera do operador...';
      progressEl.classList.remove('hidden');
    }
  });

  // When operator sends high-res photo_ready
  socket.on('photo_ready', ({ index, photo }) => {
    // dispatch event to unify handling
    document.dispatchEvent(new CustomEvent('operator_photo_ready', { detail: { index, photo } }));
    // if not in capture mode, show preview immediately
    if (mode !== 'capturing') {
      currentPhotoData = photo;
      showPhotoPreview(photo);
    }
  });

  // Show QR overlay when server sends visualizadorUrl
  socket.on('show_qr', ({ visualizadorUrl }) => {
    if (!visualizadorUrl) return;
    try {
      QRCode.toCanvas(qrCanvas, visualizadorUrl, { width: 260 }, (err) => {
        // if error, we fallback below
        qrOverlay.classList.add('visible');
        qrOverlay.classList.remove('hidden');
        qrOverlay.setAttribute('aria-hidden','false');
      });
    } catch(e) {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const ctx = qrCanvas.getContext('2d');
        ctx.clearRect(0,0,qrCanvas.width,qrCanvas.height);
        ctx.drawImage(img,0,0,qrCanvas.width,qrCanvas.height);
        qrOverlay.classList.add('visible');
        qrOverlay.classList.remove('hidden');
        qrOverlay.setAttribute('aria-hidden','false');
      };
      img.onerror = () => {
        const ctx = qrCanvas.getContext('2d');
        ctx.clearRect(0,0,qrCanvas.width,qrCanvas.height);
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,qrCanvas.width,qrCanvas.height);
        ctx.fillStyle = '#fff'; ctx.font = '12px Arial';
        ctx.fillText('Abra o link: ' + visualizadorUrl.substring(0,30), 8, 20);
        qrOverlay.classList.add('visible');
        qrOverlay.classList.remove('hidden');
        qrOverlay.setAttribute('aria-hidden','false');
      };
      img.src = `https://chart.googleapis.com/chart?cht=qr&chs=260x260&chl=${encodeURIComponent(visualizadorUrl)}`;
    }
  });

  // Reset session -> hide overlay + go to welcome
  socket.on('reset_session', ({ session: s }) => {
    if (s && s !== session) return;
    photos = []; currentPhotoIndex = 0; currentPhotoData = null;
    mode = 'idle';
    qrOverlay.classList.add('hidden');
    qrOverlay.classList.remove('visible');
    qrOverlay.setAttribute('aria-hidden','true');
    showScreen(welcomeScreen);
  });

  // Local camera (optional)
  async function startCamera(){
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
      videoEl.srcObject = stream;
      videoEl.style.display = 'block';
      if (DISPLAY_MIRROR) videoEl.style.transform = 'scaleX(-1)'; else videoEl.style.transform = 'none';
      await videoEl.play();
    } catch(e) {
      console.warn('startCamera err', e);
      alert('NÃ£o foi possÃ­vel acessar a cÃ¢mera. Verifique permissÃµes.');
      showScreen(welcomeScreen);
    }
  }
  function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } videoEl.style.display='none'; }

  // PREVIEW: show photo in the SAME orientation as live (respect DISPLAY_MIRROR)
  function showPhotoPreview(photoDataUrl) {
    currentPhotoData = photoDataUrl;
    // simply set image src and apply CSS transform to match live orientation
    previewImage.style.transform = DISPLAY_MIRROR ? 'scaleX(-1)' : 'none';
    previewImage.src = photoDataUrl;
    showScreen(previewScreen);
    mode = 'preview';
  }

  // NOTE: original normalize function (keeps available if later needed)
  function normalizeAndShowPreview(photoDataUrl) {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = img.width; c.height = img.height;
      const ctx = c.getContext('2d');
      ctx.save();
      // unflip horizontally (legacy behavior). Not used when DISPLAY_MIRROR = true.
      ctx.translate(c.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(img, 0, 0);
      ctx.restore();
      const normalized = c.toDataURL('image/jpeg', 0.95);
      previewImage.style.transform = 'none';
      previewImage.src = normalized;
      showScreen(previewScreen);
      mode = 'preview';
    };
    img.onerror = () => {
      previewImage.style.transform = 'none';
      previewImage.src = photoDataUrl;
      showScreen(previewScreen);
      mode = 'preview';
    };
    img.src = photoDataUrl;
  }

  // Operator capture flow helpers
  function requestOperatorCapture(index){
    socket.emit('take_photo', { session, index, viewerId: socket.id });
    logDebug('take_photo pedido (index ' + index + ')');
  }

  async function takeOneAndWait(index, timeoutMs = 15000) {
    progressEl.textContent = `${index+1}/3`;
    progressEl.classList.remove('hidden');

    for (let t=5; t>0; t--) {
      if (t <= 2) {
        countdownEl.textContent = 'SORRIA!';
        countdownEl.style.color = '#ffd600';
        if (t === 2) { try { clack.currentTime = 0; clack.play().catch(()=>{}); } catch(e){} }
      } else {
        countdownEl.textContent = String(t);
        countdownEl.style.color = '#fff';
      }
      await sleep(1000);
    }
    countdownEl.textContent = '';

    requestOperatorCapture(index);

    return new Promise((resolve, reject) => {
      const onReady = (ev) => {
        const detail = ev.detail || {};
        if (typeof detail.index === 'undefined') return;
        if (detail.index !== index) return;
        document.removeEventListener('operator_photo_ready', onReady);
        clearTimeout(timer);
        resolve(detail.photo);
      };
      document.addEventListener('operator_photo_ready', onReady);
      const timer = setTimeout(() => {
        document.removeEventListener('operator_photo_ready', onReady);
        reject(new Error('Timeout aguardando photo_ready do operador'));
      }, timeoutMs);
    });
  }

  async function startCaptureSequenceUsingOperator(){
    socket.emit('request_stream', { session, viewerId: socket.id });
    mode = 'capturing';
    photos = []; currentPhotoIndex = 0; currentPhotoData = null;
    canvasEl.style.display = 'block';
    await sleep(200);

    for (let i = 0; i < 3; i++) {
      try {
        const photo = await takeOneAndWait(i, 15000);
        photos.push(photo);
        currentPhotoIndex = photos.length;
        // IMPORTANT: show preview matching live orientation
        showPhotoPreview(photo);

        const decision = await new Promise((resolve) => {
          const onRef = () => { refazerBtn.removeEventListener('click', onRef); continuarBtn.removeEventListener('click', onCont); resolve('refazer'); };
          const onCont = () => { refazerBtn.removeEventListener('click', onRef); continuarBtn.removeEventListener('click', onCont); resolve('continuar'); };
          refazerBtn.addEventListener('click', onRef);
          continuarBtn.addEventListener('click', onCont);
        });

        if (decision === 'refazer') {
          photos.pop();
          currentPhotoIndex = photos.length;
          currentPhotoData = null;
          mode = 'capturing';
          showScreen(null);
          await sleep(250);
          i = i - 1;
          continue;
        } else {
          mode = 'capturing';
          showScreen(null);
          await sleep(250);
          continue;
        }
      } catch (err) {
        logDebug('Erro/timeout aguardando foto do operador: ' + (err && err.message ? err.message : err));
        progressEl.textContent = 'Erro ao capturar. Tentando novamente...';
        progressEl.classList.remove('hidden');
        await sleep(1200);
        i = i - 1;
        continue;
      }
    }

    mode = 'thank';
    showScreen(thankScreen);
    socket.emit('photos_submit', { session, viewerId: socket.id, photos });
    try{ fim.currentTime = 0; fim.play().catch(()=>{}); } catch(e){}
  }

  // UI wiring
  enterFsBtn.addEventListener('click', async () => {
    try { await document.documentElement.requestFullscreen(); } catch(e){}
    showScreen(welcomeScreen);
    socket.emit('cell_entered_fullscreen', { session, viewerId: socket.id });
  });

  startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    startBtn.textContent = 'ðŸŽµ Preparando...';
    await inicio.play().catch(()=>{});
    startBtn.disabled = false;
    startBtn.textContent = 'ðŸŽ¬ Iniciar SessÃ£o de Fotos';
    showScreen(null);
    await startCaptureSequenceUsingOperator();
  });

  function logDebug(msg){
    const t = new Date().toLocaleTimeString();
    debugEl.textContent = `[${t}] ${msg}\n` + debugEl.textContent;
    console.log(msg);
  }

  document.addEventListener('operator_photo_ready', (ev) => {
    logDebug('operator_photo_ready event received index=' + (ev.detail && ev.detail.index));
  });

  // expose some debug helpers
  window._cabine = { socket, startCaptureSequenceUsingOperator, photos };

})(); // end IIFE
  </script>

</body>
</html>
