<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine â€” Celular (cliente)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
    .screen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:12px}
    #streamImg{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1;filter:brightness(0.6)}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:2;display:flex;align-items:center;justify-content:center;flex-direction:column}
    .btn{padding:16px 22px;border-radius:12px;border:none;background:#ffd600;color:#000;font-weight:700;font-size:18px;cursor:pointer}
    #countdown{font-size:140px;font-weight:800;text-align:center;color:#fff;text-shadow:0 0 20px #000;display:none}
    #preview{position:fixed;bottom:10%;left:50%;transform:translateX(-50%);z-index:3;display:none; flex-direction:column;align-items:center}
    #preview img{max-width:90vw;border-radius:8px;border:4px solid rgba(0,0,0,0.5)}
    .preview-controls{display:flex;gap:12px;margin-top:12px}
    .control-btn{padding:10px 14px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    #refazer{background:#dc3545;color:white}
    #continuar{background:#28a745;color:white}
    #debug{position:fixed;left:8px;bottom:8px;font-size:12px;color:#aaa;background:rgba(0,0,0,0.4);padding:6px;border-radius:6px;z-index:10}
  </style>
</head>
<body>
  <img id="streamImg" src="" crossorigin="anonymous">
  <div id="overlay" class="screen">
    <div style="text-align:center;z-index:5">
      <h1>ðŸ“¸ Cabine</h1>
      <button id="startBtn" class="btn">ðŸŽ¬ Iniciar SessÃ£o de Fotos</button>
      <div id="waiting" style="margin-top:12px;color:#ffd600;display:none">Aguardando cÃ¢mera do operador...</div>
    </div>
    <div id="countdown">3</div>
  </div>

  <div id="preview">
    <img id="previewImg" src="">
    <div class="preview-controls">
      <button id="refazer" class="control-btn">ðŸ”„ Refazer</button>
      <button id="continuar" class="control-btn">âœ… Continuar</button>
    </div>
  </div>

  <div id="debug">debug</div>

<script>
const SERVER_URL = location.origin.replace(/\/$/, '') || 'http://localhost:3000';
const params = new URLSearchParams(location.search);
const SESSION = params.get('session') || 'cabine-fixa';
const STREAM_FALLBACK = params.get('stream') || null;

const streamImg = document.getElementById('streamImg');
const startBtn = document.getElementById('startBtn');
const countdownEl = document.getElementById('countdown');
const waitingEl = document.getElementById('waiting');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const refazerBtn = document.getElementById('refazer');
const continuarBtn = document.getElementById('continuar');
const debugEl = document.getElementById('debug');

let socket = null;
let photos = [];
let currentIndex = 0;
let lastFrame = null;
let waitingForPhoto = false;

function dbg(msg){ console.log(msg); debugEl.textContent = msg; }

function connectSocket(){
  socket = io(SERVER_URL, { transports:['websocket'] });
  socket.on('connect', ()=>{
    dbg('connected: ' + socket.id);
    socket.emit('join_session', { session: SESSION, role: 'viewer' });
    // request stream immediately
    socket.emit('request_stream', { session: SESSION });
    waitingEl.style.display = 'block';
  });

  socket.on('stream_frame', ({ session, frame }) => {
    // update preview image background
    lastFrame = frame;
    streamImg.src = frame;
    waitingEl.style.display = 'none';
  });

  socket.on('stream_pending', ()=>{
    waitingEl.style.display = 'block';
  });

  socket.on('photo_ready', ({ index, photo }) => {
    dbg('photo_ready index=' + index);
    // show preview and let user decide
    previewImg.src = photo;
    preview.style.display = 'flex';
    waitingForPhoto = false;
  });

  socket.on('viewer_count', (c)=> { dbg('viewers=' + c.viewers); });

  socket.on('disconnect', ()=> dbg('socket disconnected'));
}

async function countdownAndRequest(){
  // show live stream behind and overlay countdown
  countdownEl.style.display = 'block';
  for (let t=3; t>0; t--) {
    countdownEl.textContent = t;
    await new Promise(r=>setTimeout(r, 800));
  }
  countdownEl.style.display = 'none';
  // ask server to instruct operator to take photo
  waitingForPhoto = true;
  socket.emit('take_photo', { session: SESSION, index: currentIndex, viewerId: socket.id });
  dbg('take_photo requested index=' + currentIndex);
}

startBtn.addEventListener('click', async ()=>{
  startBtn.disabled = true;
  photos = []; currentIndex = 0;
  await countdownAndRequest();
});

refazerBtn.addEventListener('click', async ()=>{
  preview.style.display = 'none';
  // request again for same index
  await countdownAndRequest();
});

continuarBtn.addEventListener('click', async ()=>{
  // save current preview image
  if (previewImg.src) photos.push(previewImg.src);
  currentIndex++;
  preview.style.display = 'none';
  if (currentIndex >= 3) {
    // send photos to server for montage
    socket.emit('photos_submit', { session: SESSION, viewerId: socket.id, photos });
    // show thank you screen briefly
    overlayShowThank();
  } else {
    // request next photo
    await countdownAndRequest();
  }
});

function overlayShowThank(){
  // simple thank you overlay
  overlay = document.getElementById('overlay');
  overlay.innerHTML = '<div style="text-align:center"><h2>Obrigado!</h2><p>Aguarde enquanto montamos suas fotos.</p></div>';
  setTimeout(()=> location.reload(), 5000);
}

window.addEventListener('DOMContentLoaded', ()=>{
  connectSocket();
  // if a direct stream was supplied via query ?stream=..., use it as background as fallback
  if (STREAM_FALLBACK) {
    streamImg.src = STREAM_FALLBACK;
  }
});
</script>
</body>
</html>
