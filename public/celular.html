<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
    .screen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:15px}
    #enterFsBtn{padding:18px 25px;border-radius:12px;border:none;background:#ffd600;color:#000;font-weight:700;cursor:pointer;font-size:20px;margin:15px;width:90%;max-width:300px}
    #welcome{background:rgba(255,255,255,0.06);padding:25px;text-align:center;border-radius:15px;width:95%;max-width:420px;backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.06)}
    #welcome h1{font-size:24px;margin-bottom:12px}
    #startBtn{padding:14px 22px;border-radius:12px;border:none;background:#fff;color:#0b84ff;font-weight:700;cursor:pointer;font-size:18px;margin-top:10px;box-shadow:0 4px 10px rgba(0,0,0,0.3);width:100%;max-width:300px}
    .logo{max-width:160px;margin-bottom:18px;border-radius:8px}
    #videoEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none; transform: scaleX(-1);z-index:0}
    #canvasEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;z-index:5}
    #progress{position:fixed;top:18px;left:18px;padding:8px 10px;border-radius:10px;background:rgba(0,0,0,0.5);z-index:220;color:#fff;font-weight:700}
    #statusDot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;vertical-align:middle;background:#b22222;box-shadow:0 0 6px rgba(0,0,0,0.6)}
    #countdown{position:fixed;top:30%;left:0;right:0;text-align:center;font-size:120px;font-weight:800;text-shadow:0 0 20px #000;z-index:200;color:#fff;pointer-events:none}
    #previewScreen{background:rgba(0,0,0,0.9);z-index:210;padding:0;display:none}
    #previewContainer{position:relative;width:100%;height:100%;display:flex;flex-direction:column}
    #previewImage{width:100%;height:100%;object-fit:contain;display:block}
    .preview-buttons{position:absolute;bottom:30px;left:0;right:0;display:flex;gap:15px;justify-content:center;padding:0 20px;z-index:230}
    .preview-btn{padding:12px 18px;border-radius:8px;border:none;font-weight:700;cursor:pointer;font-size:16px;flex:1;max-width:160px;background:rgba(0,0,0,0.7);color:white;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.12)}
    #refazerBtn{background:rgba(220,53,69,0.9)}
    #continuarBtn{background:rgba(40,167,69,0.9)}
    #thankScreen{background:linear-gradient(135deg,#001e3c,#0b84ff);z-index:200;display:none}
    #thank { background: rgba(255,255,255,0.06); padding: 20px; border-radius: 12px; width:95%;max-width:420px;text-align:center;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.06)}
    #debugInfo {position:fixed;bottom:10px;left:10px;font-size:11px;color:#ddd;background:rgba(0,0,0,0.5);padding:6px;border-radius:6px;z-index:999;max-width:46%}
    .hidden { display: none !important; }
    .visible { display: flex !important; }
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    @media (max-width:480px){ #countdown{font-size:72px} .preview-btn{font-size:14px} }
  </style>
</head>
<body>
  <!-- ENTER FULLSCREEN SCREEN -->
  <div id="enterFs" class="screen visible" style="background: url('iniciar.png') center/cover no-repeat;">
    <!-- note: background is iniciar.png (you should place it in public/) -->
    <div style="text-align:center;background:rgba(0,0,0,0.45);padding:18px;border-radius:12px;width:95%;max-width:420px">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <h1 style="font-size:22px;margin-bottom:10px">ðŸ“¸ Cabine FotogrÃ¡fica</h1>
      <p style="font-size:15px;margin-bottom:12px">Toque em entrar para iniciar</p>
      <!-- this is the visible clickable area (the image is the background) -->
      <button id="enterFsBtn" aria-label="Entrar em tela cheia">ðŸŽ¬ Entrar em Tela Cheia</button>
    </div>
  </div>

  <!-- WELCOME / START SCREEN (after fullscreen) -->
  <div id="welcomeScreen" class="screen hidden" style="background:linear-gradient(135deg,#001e3c,#0b84ff)">
    <div id="welcome">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <h1>ðŸ“¸ Bem-vindo Ã  Cabine FotogrÃ¡fica</h1>
      <p>Toque iniciar para comeÃ§ar</p>
      <button id="startBtn">ðŸŽ¬ Iniciar SessÃ£o</button>
    </div>
  </div>

  <!-- LIVE CAMERA + CANVAS -->
  <video id="videoEl" autoplay playsinline muted></video>
  <canvas id="canvasEl"></canvas>

  <div id="progress" class="hidden"><span id="statusDot" title="estado"></span><span id="progressText">Aguardando</span></div>
  <div id="countdown" class="hidden"></div>

  <!-- PREVIEW -->
  <div id="previewScreen" class="screen hidden">
    <div id="previewContainer">
      <img id="previewImage" src="" alt="Preview da foto">
      <div class="preview-buttons">
        <button id="refazerBtn" class="preview-btn">ðŸ”„ Refazer</button>
        <button id="continuarBtn" class="preview-btn">âœ… Continuar</button>
      </div>
    </div>
  </div>

  <!-- THANK YOU -->
  <div id="thankScreen" class="screen hidden">
    <div id="thank">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <h1>âœ¨ Obrigado!</h1>
      <p>Enviando suas fotos... <span id="sendStatusText">(aguardando)</span></p>
      <p style="font-size:12px;opacity:0.9;margin-top:10px">Aguarde enquanto processamos â€” o QR aparecerÃ¡ automaticamente.</p>
    </div>
  </div>

  <div id="debugInfo" class="hidden" aria-hidden="true"></div>

  <audio id="clack" src="clack.mp3" preload="auto"></audio>
  <audio id="inicio" src="inicio.mp3" preload="auto"></audio>
  <audio id="fim" src="fim.mp3" preload="auto"></audio>

<script>
/*
  celular.html â€” VersÃ£o corrigida de envio

  Principais correÃ§Ãµes:
  - Garante socket conectado antes de enviar photos_from_cell
  - Retry/backoff e espera por confirmaÃ§Ã£o (photos_ready / visualizer_ready)
  - Indicador visual (bolinha vermelho/verde) e mensagens
  - ReconexÃ£o automÃ¡tica e re-join na sessÃ£o
  - MantÃ©m fluxo: entrar fullscreen -> welcome -> iniciar -> startCamera -> capturar 3 fotos -> enviar
*/

(() => {
  // CONFIG: altere se necessÃ¡rio (usa o backend preferido)
  const BASE_SERVER = "festadodavi-production-0591.up.railway.app"; // <-- seu backend preferido
  const SOCKET_PATH = "/socket.io"; // keep default

  // socket init (we don't connect instantly; we'll call connect explicitly)
  const socket = io(BASE_SERVER, {
    autoConnect: false,
    transports: ['websocket','polling'],
    path: SOCKET_PATH,
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: 1000,
    timeout: 20000,
    withCredentials: true,
  });

  // DOM
  const enterFs = document.getElementById('enterFs');
  const enterFsBtn = document.getElementById('enterFsBtn');
  const welcomeScreen = document.getElementById('welcomeScreen');
  const startBtn = document.getElementById('startBtn');
  const videoEl = document.getElementById('videoEl');
  const canvasEl = document.getElementById('canvasEl');
  const countdownEl = document.getElementById('countdown');
  const previewScreen = document.getElementById('previewScreen');
  const previewImage = document.getElementById('previewImage');
  const refazerBtn = document.getElementById('refazerBtn');
  const continuarBtn = document.getElementById('continuarBtn');
  const thankScreen = document.getElementById('thankScreen');
  const progressEl = document.getElementById('progress');
  const progressText = document.getElementById('progressText');
  const statusDot = document.getElementById('statusDot');
  const sendStatusText = document.getElementById('sendStatusText');
  const debugInfo = document.getElementById('debugInfo');

  // session param from URL
  const params = new URLSearchParams(location.search);
  const session = params.get('session') || 'cabine-fixa';

  // state
  let stream = null;
  let photos = [];
  let currentPhotoIndex = 0;
  let currentPhotoData = null;
  let sendingInProgress = false;
  let visualizerLocked = false; // when visualizer is shown block until finalize

  // UI helpers
  function show(el) { if(el){ el.classList.remove('hidden'); el.style.display = 'flex'; } }
  function hide(el) { if(el){ el.classList.add('hidden'); el.style.display = 'none'; } }
  function setProgress(text, colorDot) {
    progressText.textContent = text || '';
    progressEl.classList.remove('hidden');
    if(colorDot === 'green') statusDot.style.background = '#28a745';
    else if(colorDot === 'red') statusDot.style.background = '#b22222';
    else statusDot.style.background = '#b22222';
  }
  function hideProgress(){ progressEl.classList.add('hidden'); }

  function debug(msg) {
    console.log('[CELULAR]', msg);
    if (debugInfo) {
      debugInfo.classList.remove('hidden');
      debugInfo.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + debugInfo.textContent;
    }
  }

  // sleep helper
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  // show initial screen
  function showScreen(screenElement) {
    // hide all main
    [enterFs, welcomeScreen, previewScreen, thankScreen].forEach(s => {
      if (!s) return;
      s.classList.add('hidden');
      s.style.display = 'none';
    });
    // hide canvas/video overlay elements by default
    videoEl.style.display = 'none';
    canvasEl.style.display = 'none';
    countdownEl.classList.add('hidden');
    hideProgress();

    if (screenElement) {
      screenElement.classList.remove('hidden');
      screenElement.style.display = 'flex';
    }
  }

  showScreen(enterFs);

  /* -------------------------
     CAMERA
  ------------------------- */
  async function startCamera() {
    try {
      // prefer facingMode user but allow fallback
      const constraints = { video: { facingMode: "user" }, audio: false };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      videoEl.srcObject = stream;
      videoEl.style.display = 'block';
      videoEl.play().catch(()=>{});
      videoEl.muted = true;
      videoEl.setAttribute('playsinline','');
      debug('Camera iniciada');
    } catch (err) {
      console.error('Erro ao abrir cÃ¢mera:', err);
      alert('NÃ£o foi possÃ­vel acessar a cÃ¢mera. Verifique permissÃµes do navegador.');
      showScreen(welcomeScreen);
      throw err;
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    videoEl.style.display = 'none';
    canvasEl.style.display = 'none';
    debug('Camera parada');
  }

  /* -------------------------
     CAPTURE FLOW (3 fotos)
  ------------------------- */
  async function captureSinglePhoto() {
    // show camera, show progress
    videoEl.style.display = 'block';
    setProgress(`${currentPhotoIndex+1}/3`, 'red');
    countdownEl.classList.remove('hidden');

    // 5..1 countdown
    for (let t = 5; t > 0; t--) {
      if (t <= 2) {
        countdownEl.textContent = 'SORRIA!';
      } else {
        countdownEl.textContent = String(t);
      }
      await sleep(1000);
    }
    countdownEl.classList.add('hidden');

    // draw into canvas, unmirror to keep natural orientation for operator
    canvasEl.width = videoEl.videoWidth || 1280;
    canvasEl.height = videoEl.videoHeight || 720;
    const ctx = canvasEl.getContext('2d');
    // draw unmirrored (operator often expects unmirrored images)
    ctx.save();
    ctx.translate(canvasEl.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
    ctx.restore();

    // get dataURL (jpeg)
    const dataUrl = canvasEl.toDataURL('image/jpeg', 0.95);
    debug('Foto capturada (dataURL tamanho=' + dataUrl.length + ')');
    return dataUrl;
  }

  function showPhotoPreview(photoData) {
    previewImage.src = photoData;
    previewScreen.classList.remove('hidden');
    previewScreen.style.display = 'flex';
    canvasEl.style.display = 'none';
    videoEl.style.display = 'none';
  }

  async function runCaptureSequence() {
    // start at index 0
    currentPhotoIndex = 0;
    photos = [];
    while (currentPhotoIndex < 3) {
      try {
        currentPhotoData = await captureSinglePhoto();
        showPhotoPreview(currentPhotoData);

        // wait for user action (refazer / continuar)
        const userDecision = await new Promise((resolve) => {
          const onRef = () => { refazerBtn.removeEventListener('click', onRef); continuarBtn.removeEventListener('click', onCont); resolve('refazer'); };
          const onCont = () => { refazerBtn.removeEventListener('click', onRef); continuarBtn.removeEventListener('click', onCont); resolve('continuar'); };
          refazerBtn.addEventListener('click', onRef);
          continuarBtn.addEventListener('click', onCont);
        });

        if (userDecision === 'refazer') {
          // keep index same and retake
          previewScreen.classList.add('hidden');
          previewScreen.style.display = 'none';
          videoEl.style.display = 'block';
          await sleep(200);
          continue;
        } else {
          // accept photo
          photos.push(currentPhotoData);
          currentPhotoIndex++;
          previewScreen.classList.add('hidden');
          previewScreen.style.display = 'none';
          videoEl.style.display = 'block';
          await sleep(250);
          continue;
        }
      } catch (err) {
        console.error('Erro no fluxo de captura:', err);
        setProgress('Erro ao capturar. Tente novamente', 'red');
        await sleep(1200);
      }
    }

    // finished 3 photos
    stopCamera();
    setProgress('Fotos prontas â€” enviando...', 'red');
    showScreen(thankScreen);
    await sendPhotosToServerWithConfirm();
  }

  /* -------------------------
     SOCKET + SEND LOGIC (robusto)
     - garante socket conectado
     - envia photos_from_cell { session, photos }
     - espera por photos_ready ou visualizer_ready com matching session
     - retry/backoff
  ------------------------- */

  // helpers for socket lifecycle
  function joinSessionOnSocket() {
    if (!socket || !socket.connected) return;
    socket.emit('join_session', { session, role: 'viewer' });
    debug('join_session emitido: ' + session);
  }

  socket.on('connect', () => {
    debug('Socket conectado: ' + socket.id);
    setProgress('Conectado', 'green');
    joinSessionOnSocket();
  });

  socket.on('reconnect', (attempt) => {
    debug('Socket reconectado, tentativa: ' + attempt);
    setProgress('Reconectado', 'green');
    joinSessionOnSocket();
  });

  socket.on('connect_error', (err) => {
    console.warn('connect_error', err && err.message);
    setProgress('Erro conexÃ£o', 'red');
  });

  socket.on('disconnect', (reason) => {
    debug('Socket desconectado: ' + reason);
    setProgress('Desconectado', 'red');
  });

  // server confirms photos processed
  socket.on('photos_ready', (payload) => {
    try {
      if (!payload) return;
      if (payload.session && payload.session !== session) return; // not our session
      debug('photos_ready recebido do servidor');
      // When server confirms, mark sending done and show visualizer if needed
      setProgress('Fotos recebidas no servidor', 'green');
      sendStatusText.textContent = '(enviado)';
      visualizerLocked = true; // lock until finalize_session
      // optionally server may pass visualizadorUrl -> you can show it here
      if (payload.visualizadorUrl) {
        // show QR or open visualizer in a new tab? we purposely only show message.
        debug('visualizadorUrl: ' + payload.visualizadorUrl);
      }
    } catch (e) { console.error(e); }
  });

  // visualizer_ready may be used to show QR image data directly
  socket.on('visualizer_ready', (payload) => {
    if (!payload) return;
    if (payload.session && payload.session !== session) return;
    debug('visualizer_ready recebido');
    sendStatusText.textContent = '(visualizador pronto)';
    setProgress('Visualizador pronto', 'green');
    visualizerLocked = true;
    // If payload.qrDataUrl available we could show it: payload.qrDataUrl
    if (payload.qrDataUrl) {
      // small modal for QR? for now log
      debug('QR recebido (dataURL) length=' + (payload.qrDataUrl.length || 0));
    }
  });

  // finalize_session or reset_session -> unlock and return to start
  socket.on('finalize_session', (payload) => {
    const sid = payload && payload.session ? payload.session : session;
    if (sid !== session) return;
    debug('finalize_session recebido -> reset celular UI');
    // reset
    photos = [];
    currentPhotoIndex = 0;
    currentPhotoData = null;
    visualizerLocked = false;
    sendStatusText.textContent = '(pronto)';
    showScreen(welcomeScreen);
    hideProgress();
  });

  socket.on('reset_session', (payload) => {
    const sid = payload && payload.session ? payload.session : session;
    if (sid !== session) return;
    debug('reset_session recebido -> reset celular UI');
    photos = [];
    currentPhotoIndex = 0;
    currentPhotoData = null;
    visualizerLocked = false;
    sendStatusText.textContent = '(pronto)';
    showScreen(welcomeScreen);
    hideProgress();
  });

  // send photos with retry and await confirmation
  async function sendPhotosToServerWithConfirm(opts = {}) {
    if (sendingInProgress) {
      debug('Envio jÃ¡ em andamento, retornando');
      return;
    }
    sendingInProgress = true;
    setProgress('Tentando enviar fotos...', 'red');
    sendStatusText.textContent = '(enviando...)';

    const maxAttempts = opts.maxAttempts || 6;
    let attempt = 0;
    let confirmed = false;

    // helper to wait for visualizer_ready or photos_ready for this session
    function waitForConfirmation(timeoutMs = 12000) {
      return new Promise((resolve) => {
        let resolved = false;
        const onPhotosReady = (payload) => {
          if (payload && payload.session && payload.session !== session) return;
          if (!resolved) { resolved = true; socket.off('photos_ready', onPhotosReady); socket.off('visualizer_ready', onVisualizer); resolve({ ok: true, payload }); }
        };
        const onVisualizer = (payload) => {
          if (payload && payload.session && payload.session !== session) return;
          if (!resolved) { resolved = true; socket.off('photos_ready', onPhotosReady); socket.off('visualizer_ready', onVisualizer); resolve({ ok: true, payload }); }
        };
        socket.on('photos_ready', onPhotosReady);
        socket.on('visualizer_ready', onVisualizer);
        setTimeout(() => {
          if (!resolved) {
            resolved = true;
            socket.off('photos_ready', onPhotosReady);
            socket.off('visualizer_ready', onVisualizer);
            resolve({ ok: false, reason: 'timeout' });
          }
        }, timeoutMs);
      });
    }

    // try send loop
    while (attempt < maxAttempts && !confirmed) {
      attempt++;
      // ensure socket connected
      if (!socket.connected) {
        setProgress(`Conectando... (tentativa ${attempt})`, 'red');
        try {
          socket.connect();
          // wait a bit for connect
          let waited = 0;
          while (!socket.connected && waited < 6000) { await sleep(300); waited += 300; }
          if (!socket.connected) {
            debug('Socket nÃ£o conectou ainda, retry...');
            await sleep(400);
            continue;
          }
        } catch (e) {
          debug('Erro ao conectar socket: ' + e.message);
          await sleep(800);
          continue;
        }
      }

      // now emit
      try {
        setProgress(`Enviando fotos (tentativa ${attempt})`, 'red');
        // include session explicitly
        socket.emit('photos_from_cell', { session, photos }, (ack) => {
          // note: server may not ack via callback; we rely on photos_ready event
          debug('emit photos_from_cell callback (se houver): ' + JSON.stringify(ack || {}));
        });

        // wait for server confirmation event
        const res = await waitForConfirmation(11000);
        if (res.ok) {
          confirmed = true;
          setProgress('Enviado e confirmado', 'green');
          sendStatusText.textContent = '(enviado)';
          break;
        } else {
          debug('Nenhuma confirmaÃ§Ã£o do servidor (timeout), tentativa: ' + attempt);
          await sleep(800 + attempt * 400);
          continue;
        }
      } catch (err) {
        debug('Erro no envio: ' + (err && err.message));
        await sleep(1000 + attempt * 300);
        continue;
      }
    }

    if (!confirmed) {
      setProgress('Falha ao enviar fotos. Verifique conexÃ£o.', 'red');
      sendStatusText.textContent = '(erro no envio)';
    }

    sendingInProgress = false;
    return confirmed;
  }

  /* -------------------------
     UI wiring
  ------------------------- */

  enterFsBtn.addEventListener('click', async () => {
    try { await document.documentElement.requestFullscreen(); } catch (e) { /* ignore */ }
    // After entering fullscreen, go directly to welcome/choice
    showScreen(welcomeScreen);
    // ensure socket started and join session
    if (!socket.connected) {
      socket.connect();
    } else {
      joinSessionOnSocket();
    }
  });

  startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    startBtn.textContent = 'ðŸŽµ Preparando...';
    try { await document.getElementById('inicio').play().catch(()=>{}); } catch(e){}
    startBtn.disabled = false;
    startBtn.textContent = 'ðŸŽ¬ Iniciar SessÃ£o';

    // Start camera and run capture
    showScreen(null); // hide to show camera
    try {
      await startCamera();
      currentPhotoIndex = 0;
      photos = [];
      await runCaptureSequence();
    } catch (err) {
      console.error('Erro iniciar sessÃ£o:', err);
      showScreen(welcomeScreen);
    }
  });

  refazerBtn.addEventListener('click', async () => {
    // handled in runCaptureSequence via event promise
  });

  continuarBtn.addEventListener('click', async () => {
    // handled in runCaptureSequence via event promise
  });

  // ensure we re-join session when reconnecting
  socket.on('reconnect_attempt', () => {
    debug('reconnect_attempt');
  });

  // initial small UI status
  setProgress('Pronto', 'red');
  sendStatusText && (sendStatusText.textContent = '(pronto)');

  // expose some debug on window for manual testing
  window._cabine_client = {
    socket,
    sendPhotosToServerWithConfirm,
    startCamera,
    stopCamera,
  };

  // auto connect quietly when page loads so join happens after user clicks FS
  // But do not auto-emit join session until after fullscreen click
  // We'll keep socket created at top; start connecting to keep TCP warm
  // Connect on user gesture above (enterFsBtn -> connects)

  debug('celular.js carregado â€” pronto');

})();
</script>
</body>
</html>
