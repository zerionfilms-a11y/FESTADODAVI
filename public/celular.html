<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Celular (Tela da Webcam)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
    .screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:15px;z-index:900}
    .card{width:95%;max-width:420px;padding:22px;border-radius:14px;background:rgba(0,0,0,0.45);backdrop-filter:blur(8px);text-align:center;border:1px solid rgba(255,255,255,0.08)}
    .logo{max-width:160px;margin-bottom:18px}
    h1{font-size:24px;margin-bottom:8px}
    p{font-size:16px;color:#ddd;margin-bottom:12px}
    button{padding:14px 18px;border-radius:12px;border:none;cursor:pointer;font-weight:800}
    #enterFsBtn{background:#ffd600;color:#000;font-size:18px;width:100%}
    #startBtn{background:#b07e09;color:#fff;font-size:20px;width:100%}
    #remoteImg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;display:none;transform:scaleX(-1);z-index:100}
    #countdownOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:920;pointer-events:none}
    #countdownText{color:#fff;font-size:140px;font-weight:900;text-shadow:0 8px 30px rgba(0,0,0,0.7)}
    #previewScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:930;background:rgba(0,0,0,0.9)}
    #previewImage{max-width:95%;max-height:85%;object-fit:contain;border-radius:8px}
    .preview-controls{position:absolute;bottom:28px;left:0;right:0;display:flex;gap:14px;justify-content:center;z-index:940}
    .preview-btn{padding:12px 18px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn-refazer{background:rgba(220,53,69,0.9);color:#fff}
    .btn-continuar{background:rgba(40,167,69,0.95);color:#fff}
    #thankCard{width:95%;max-width:420px;padding:22px;border-radius:14px;background:rgba(0,0,0,0.45);backdrop-filter:blur(8px);text-align:center;border:1px solid rgba(255,255,255,0.08)}
    #debugInfo {position:fixed;bottom:8px;left:8px;font-size:12px;color:#ddd;background:rgba(0,0,0,0.35);padding:6px;border-radius:6px;z-index:995}
  </style>
</head>
<body>
  <img id="remoteImg" alt="Stream do Operador">

  <div id="enterScreen" class="screen">
    <div class="card" role="region" aria-label="Entrar em tela cheia">
      <img src="logo1.png" class="logo" alt="Logo" onerror="this.onerror=null;this.src='logo.png'">
      <h1>ðŸ“¸ Cabine FotogrÃ¡fica</h1>
      <p>Para melhor experiÃªncia, entre em tela cheia.</p>
      <button id="enterFsBtn">ðŸŽ¬ Entrar em Tela Cheia</button>
    </div>
  </div>

  <div id="welcomeScreen" class="screen" style="display:none">
    <div class="card" role="region" aria-label="Bem-vindo">
      <img src="logo1.png" class="logo" alt="Logo" onerror="this.onerror=null;this.src='logo.png'">
      <h1>ðŸ“¸ Bem-vindo Ã  Cabine FotogrÃ¡fica</h1>
      <p>Esta tela exibirÃ¡ a webcam do operador. Quando estiver pronta, pressione iniciar.</p>
      <button id="startBtn">ðŸŽ¬ Iniciar SessÃ£o de Fotos</button>
    </div>
  </div>

  <div id="countdownOverlay">
    <div id="countdownText">3</div>
  </div>

  <div id="previewScreen">
    <img id="previewImage" src="" alt="Preview">
    <div class="preview-controls">
      <button id="refazerBtn" class="preview-btn btn-refazer">ðŸ”„ Refazer</button>
      <button id="continuarBtn" class="preview-btn btn-continuar">âœ… Continuar</button>
    </div>
  </div>

  <div id="thankScreen" class="screen" style="display:none">
    <div id="thankCard">
      <img src="logo1.png" class="logo" alt="Logo" onerror="this.onerror=null;this.src='logo.png'">
      <h1>âœ¨ Obrigado por utilizar a cabine!</h1>
      <p>Espere o operador encerrar a sessÃ£o.</p>
    </div>
  </div>

  <div id="debugInfo"></div>

  <audio id="clack" src="clack.mp3" preload="auto"></audio>
  <audio id="inicio" src="inicio.mp3" preload="auto"></audio>
  <audio id="fim" src="fim.mp3" preload="auto"></audio>

  <script>
    const SERVER_URL = "https://festadodavi.onrender.com/";
    const socket = io(SERVER_URL, { transports:["websocket"], reconnection:true, reconnectionAttempts:5, reconnectionDelay:1000, timeout:20000, forceNew:true, withCredentials:true });

    const params = new URLSearchParams(location.search);
    const session = params.get('session');

    const enterScreen = document.getElementById('enterScreen');
    const enterFsBtn  = document.getElementById('enterFsBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const startBtn = document.getElementById('startBtn');
    const remoteImg = document.getElementById('remoteImg');
    const countdownOverlay = document.getElementById('countdownOverlay');
    const countdownText = document.getElementById('countdownText');
    const previewScreen = document.getElementById('previewScreen');
    const previewImage = document.getElementById('previewImage');
    const refazerBtn = document.getElementById('refazerBtn');
    const continuarBtn = document.getElementById('continuarBtn');
    const thankScreen = document.getElementById('thankScreen');
    const debugInfo = document.getElementById('debugInfo');
    const clack = document.getElementById('clack'), inicio = document.getElementById('inicio'), fim = document.getElementById('fim');

    let lastRemoteFrame = null;
    let remoteAvailable = false;
    let photos = [];
    let currentPhotoIndex = 0;
    let currentPhotoData = null;
    const WAIT_FOR_FIRST_FRAME_MS = 7000;
    const COUNTDOWN_SECONDS = 5;

    setInterval(()=>{ debugInfo.textContent = `SessÃ£o:${session||'none'} | Socket:${socket.connected?'ðŸŸ¢':'ðŸ”´'} | Remote:${remoteAvailable?'ðŸŸ¢':'ðŸ”´'} | Fotos:${photos.length}` }, 800);

    socket.on('connect', () => {
      if(session) {
        socket.emit('want_stream', { session });
      } else {
        socket.emit('cell_connected', {});
      }
    });

    socket.on('stream_frame', ({ session: s, frame }) => {
      if(!session) return;
      if(s !== session) return;
      lastRemoteFrame = frame;
      remoteAvailable = true;
      remoteImg.src = frame;
      remoteImg.style.display = 'block';
    });

    socket.on('stop_stream', ({ session: s }) => {
      if(!session) return;
      if(s !== session) return;
      lastRemoteFrame = null;
      remoteAvailable = false;
      remoteImg.style.display = 'none';
    });

    function showOnly(elm){
      [enterScreen,welcomeScreen,previewScreen,thankScreen].forEach(s=>s.style.display='none');
      countdownOverlay.style.display='none';
      if(elm) elm.style.display = 'flex';
    }
    showOnly(enterScreen);

    enterFsBtn.addEventListener('click', async () => {
      try { await document.documentElement.requestFullscreen(); } catch(e){}
      showOnly(welcomeScreen);
      if(session) socket.emit('cell_entered_fullscreen');
    });

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true; startBtn.textContent='ðŸŽµ Preparando...';
      await inicio.play().catch(()=>{});
      startBtn.disabled = false; startBtn.textContent='ðŸŽ¬ Iniciar SessÃ£o de Fotos';

      const got = await waitForFirstFrame(WAIT_FOR_FIRST_FRAME_MS);
      if(!got){
        alert('NÃ£o recebeu stream do operador. PeÃ§a para reiniciar o stream no PC e tente novamente.');
        showOnly(welcomeScreen);
        return;
      }
      currentPhotoIndex = 0;
      photos = [];
      await runCaptureSequence();
    });

    function waitForFirstFrame(timeout){
      if(remoteAvailable) return Promise.resolve(true);
      return new Promise((resolve) => {
        const onStream = ({session:s}) => { if(s===session){ socket.off('stream_frame', onStream); clearTimeout(tid); resolve(true); } };
        socket.on('stream_frame', onStream);
        const tid = setTimeout(()=>{ socket.off('stream_frame', onStream); resolve(false); }, timeout);
      });
    }

    async function captureSinglePhoto(){
      countdownOverlay.style.display = 'flex';
      for(let t=COUNTDOWN_SECONDS; t>0; t--){
        if(t<=2){
          countdownText.textContent = 'SORRIA!';
          if(t===2) try{ clack.currentTime=0; clack.play().catch(()=>{}); }catch(e){}
        } else countdownText.textContent = String(t);
        await new Promise(r=>setTimeout(r,1000));
      }
      countdownOverlay.style.display = 'none';
      if(lastRemoteFrame){ return lastRemoteFrame; }
      throw new Error('no-frame');
    }

    function showPhotoPreview(photoData){ previewImage.src = photoData; previewScreen.style.display = 'flex'; }

    async function runCaptureSequence(){
      if(currentPhotoIndex >= 3){ showOnly(thankScreen); sendPhotosToServer(); return; }
      try {
        const data = await captureSinglePhoto();
        currentPhotoData = data;
        showPhotoPreview(data);
      } catch (e) {
        alert('Erro ao capturar â€” stream indisponÃ­vel.');
        showOnly(welcomeScreen);
      }
    }

    refazerBtn.addEventListener('click', async () => {
      previewScreen.style.display = 'none';
      currentPhotoData = null;
      if(session) socket.emit('want_stream', { session });
      const ok = await waitForFirstFrame(WAIT_FOR_FIRST_FRAME_MS);
      if(!ok){ alert('Stream nÃ£o disponÃ­vel.'); showOnly(welcomeScreen); return; }
      await runCaptureSequence();
    });

    continuarBtn.addEventListener('click', async () => {
      photos.push(currentPhotoData);
      currentPhotoIndex++;
      previewScreen.style.display = 'none';
      currentPhotoData = null;
      if(session) socket.emit('want_stream', { session });
      await runCaptureSequence();
    });

    function sendPhotosToServer(){
      if(session && photos.length>0){
        const sendPhotosWithRetry=(attempt=1,maxAttempts=6)=>{
          if(socket.connected){
            socket.emit('photos_from_cell',{ session, photos, attempt, totalAttempts:maxAttempts });
            if(attempt < maxAttempts) setTimeout(()=>sendPhotosWithRetry(attempt+1,maxAttempts),1500);
          } else if(attempt < maxAttempts){
            setTimeout(()=>sendPhotosWithRetry(attempt+1,maxAttempts),2000);
          } else alert('Falha ao enviar fotos.');
        };
        sendPhotosWithRetry();
      }
    }
  </script>
</body>
</html>
