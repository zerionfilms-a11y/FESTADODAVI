<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine Fotogr√°fica ‚Äî Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#ffffff;color:#222222;overflow:hidden}
    /* telas */
    .screen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:15px}

    /* -------- INICIO/BOAS-VINDAS: CARD BEM MAIOR -------- */
    #enterFs{display:flex;align-items:center;justify-content:center; padding: 20px; }
    #enterFs .card, #welcome { 
      width: 96%;
      max-width: 1000px;           /* grande para telas maiores */
      padding: 44px;               /* mais espa√ßo interno */
      border-radius: 18px;
      background: rgba(255,255,255,0.98);
      box-shadow: 0 12px 40px rgba(0,0,0,0.08);
      text-align:center;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* logo: tenta logo1.png e cai para logo.png se n√£o houver */
    .logo{max-width:320px;margin-bottom:22px;border-radius:10px;display:block;margin-left:auto;margin-right:auto}
    #enterFs h1, #welcome h1 { font-size: 34px; margin-bottom: 14px; color:#222222; }
    #enterFs p, #welcome p { font-size: 20px; color:#444; margin-bottom:20px }

    #enterFsBtn{padding:20px 34px;border-radius:12px;border:none;background:#b07e09;color:#fff;font-weight:800;cursor:pointer;font-size:24px;margin:10px auto;width:92%;max-width:520px;display:block}
    #startBtn{padding:18px 30px;border-radius:12px;border:none;background:#b07e09;color:#fff;font-weight:800;cursor:pointer;font-size:22px;margin-top:12px;width:92%;max-width:480px;display:block}

    /* v√≠deo e canvas (por baixo da UI) */
    #videoWrap{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:0}
    #videoEl{width:100%;height:100%;object-fit:cover;display:none;transform:scaleX(-1);z-index:1}
    #canvasEl{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:1}

    /* progress */
    #progress{position:fixed;top:20px;left:50%;transform:translateX(-50%);text-align:center;font-size:20px;font-weight:700;z-index:220;color:#222;background:rgba(255,255,255,0.95);padding:8px 14px;border-radius:10px;display:none}

    /* -------- CONTAGEM - OVERLAY FULLSCREEN -------- */
    #countdownOverlay{
      position:fixed;
      inset:0;
      display:none; /* s√≥ durante countdown */
      align-items:center;
      justify-content:center;
      z-index:300;
      background: rgba(0,0,0,0.85); /* bloqueia totalmente o v√≠deo por baixo */
    }
    #countdownText {
      color: #ffffff;
      font-size: 140px;
      font-weight:900;
      text-align:center;
      line-height:1;
      -webkit-text-stroke: 0.5px rgba(0,0,0,0.25);
      padding: 10px 18px;
    }
    @media (max-width:480px){
      #countdownText { font-size: 86px; }
      #enterFs h1, #welcome h1 { font-size: 28px; }
      #enterFsBtn{font-size:20px;padding:16px 20px}
    }

    /* -------- PREVIEW: manter mesmo crop que v√≠deo -------- */
    #previewScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:400;background:rgba(0,0,0,0.88)}
    #previewInner{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    #previewImage{max-width:100%;max-height:100%;object-fit:cover;border-radius:4px}

    .preview-controls{position:absolute;bottom:28px;left:0;right:0;display:flex;justify-content:center;gap:12px;z-index:410}
    .btn { padding:12px 18px;border-radius:10px;border:none;font-weight:700;cursor:pointer }
    .btn--brand{background:#b07e09;color:#fff}
    .btn--light{background:#fff;color:#222;border:1px solid rgba(0,0,0,0.06)}

    /* thank screen / outras */
    #thankScreen .card{max-width:720px}

    /* debug */
    #debugInfo {position:fixed;bottom:10px;left:10px;font-size:12px;color:#666;background:rgba(255,255,255,0.95);padding:6px;border-radius:6px;z-index:500;border:1px solid rgba(0,0,0,0.06)}
  </style>
</head>
<body>
  <!-- INICIAR TELA (maior) -->
  <div id="enterFs" class="screen visible">
    <div class="card">
      <!-- tenta logo1.png primeiro; se falhar, usa logo.png -->
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.onerror=null; this.src='logo.png'">
      <h1>üì∏ Cabine Fotogr√°fica</h1>
      <p style="max-width:820px;margin:0 auto 18px">Para melhor experi√™ncia, entre em tela cheia e clique em iniciar sess√£o. Use o bot√£o abaixo para come√ßar.</p>
      <button id="enterFsBtn">üé¨ Entrar em Tela Cheia</button>
    </div>
  </div>

  <!-- WELCOME maior -->
  <div id="welcomeScreen" class="screen hidden">
    <div id="welcome" class="card">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.onerror=null; this.src='logo.png'">
      <h1>üì∏ Bem-vindo √† Cabine Fotogr√°fica</h1>
      <p style="max-width:820px;margin:0 auto 18px">Clique abaixo para iniciar a sess√£o de fotos. Toque o bot√£o para come√ßar a captura.</p>
      <button id="startBtn">üé¨ Iniciar Sess√£o de Fotos</button>
    </div>
  </div>

  <!-- VIDEO (por baixo) -->
  <div id="videoWrap" aria-hidden="true">
    <video id="videoEl" autoplay playsinline muted></video>
    <canvas id="canvasEl"></canvas>
  </div>

  <div id="progress" aria-hidden="true"></div>

  <!-- OVERLAY DE CONTAGEM -->
  <div id="countdownOverlay" aria-hidden="true">
    <div id="countdownText">3</div>
  </div>

  <!-- PREVIEW -->
  <div id="previewScreen" class="hidden" aria-hidden="true">
    <div id="previewInner">
      <img id="previewImage" src="" alt="Preview da foto">
    </div>
    <div class="preview-controls">
      <button id="refazerBtn" class="btn btn--light">üîÑ Refazer</button>
      <button id="continuarBtn" class="btn btn--brand">‚úÖ Continuar</button>
    </div>
  </div>

  <div id="thankScreen" class="screen hidden">
    <div class="card">
      <img src="logo1.png" alt="Logo" class="logo" onerror="this.onerror=null; this.src='logo.png'">
      <h1>‚ú® Obrigado por utilizar a cabine!</h1>
      <p>Aguarde o operador encerrar a sess√£o.</p>
    </div>
  </div>

  <div id="debugInfo" aria-hidden="true"></div>

  <audio id="clack" src="clack.mp3" preload="auto"></audio>
  <audio id="inicio" src="inicio.mp3" preload="auto"></audio>
  <audio id="fim" src="fim.mp3" preload="auto"></audio>

  <script>
    // servidor/socket (mantive sua URL)
    const SERVER_URL = "https://festadodavi.onrender.com";
    const socket = io(SERVER_URL, { transports:["websocket"], reconnection:true, reconnectionAttempts:5, reconnectionDelay:1000, timeout:20000, forceNew:false, withCredentials:true });

    // elementos
    const enterFs = document.getElementById('enterFs');
    const enterFsBtn = document.getElementById('enterFsBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const startBtn = document.getElementById('startBtn');
    const videoEl = document.getElementById('videoEl');
    const canvasEl = document.getElementById('canvasEl');
    const progressEl = document.getElementById('progress');
    const countdownOverlay = document.getElementById('countdownOverlay');
    const countdownText = document.getElementById('countdownText');
    const previewScreen = document.getElementById('previewScreen');
    const previewImage = document.getElementById('previewImage');
    const refazerBtn = document.getElementById('refazerBtn');
    const continuarBtn = document.getElementById('continuarBtn');
    const thankScreen = document.getElementById('thankScreen');
    const clack = document.getElementById('clack');
    const inicio = document.getElementById('inicio');
    const fim = document.getElementById('fim');
    const debugEl = document.getElementById('debugInfo');

    const params = new URLSearchParams(location.search);
    const session = params.get('session');

    let stream = null, photos = [], currentPhotoIndex = 0, currentPhotoData = null;

    setInterval(()=>{ debugEl.textContent = `Sess√£o: ${session || 'none'} | Socket: ${socket.connected ? 'üü¢' : 'üî¥'}` }, 1000);

    function showScreen(screenElement){
      // esconder telas (exceto videoWrap que fica atr√°s)
      [enterFs, welcomeScreen, previewScreen, thankScreen].forEach(s => {
        if(!s) return;
        s.classList.add('hidden');
        s.style.display = 'none';
      });
      // hide overlays
      countdownOverlay.style.display = 'none';
      progressEl.style.display = 'none';
      // show requested
      if(screenElement){
        screenElement.classList.remove('hidden');
        screenElement.style.display = 'flex';
      }
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    // startCamera com fallback para compatibilidade (corrige muitos Android)
    async function startCamera(){
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "user" } }, audio:false });
      } catch(e1){
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
        } catch(e2){
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio:false });
          } catch(e3){
            alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.');
            showScreen(welcomeScreen);
            return;
          }
        }
      }
      videoEl.srcObject = stream;
      videoEl.style.display = 'block';
      await videoEl.play();
    }

    // ajusta previewImage para ocupar o mesmo espa√ßo vis√≠vel do video (evita "jump")
    function fitPreviewToVideo(){
      const rect = videoEl.getBoundingClientRect();
      previewImage.style.width = rect.width + 'px';
      previewImage.style.height = rect.height + 'px';
      previewImage.style.objectFit = 'cover';
    }

    // captura com qualidade reduzida pra Android (0.8)
    async function captureSinglePhoto(){
      progressEl.textContent = `${currentPhotoIndex+1}/3`;
      progressEl.style.display = 'block';

      // mostra overlay que bloqueia a c√¢mera
      countdownOverlay.style.display = 'flex';
      let c = 5;
      countdownText.textContent = String(c);
      await sleep(120);

      for(; c>0; c--){
        if(c <= 2){
          countdownText.textContent = 'SORRIA!';
          countdownText.style.color = '#ffffff';
          if(c===2){ clack.currentTime = 0; clack.play().catch(()=>{}); }
        } else {
          countdownText.textContent = String(c);
          countdownText.style.color = '#ffffff';
        }
        await sleep(1000);
      }

      // hide overlay just before capture to avoid black frame (still keeps consistent framing)
      countdownOverlay.style.display = 'none';

      // capture
      canvasEl.width = videoEl.videoWidth || 1280;
      canvasEl.height = videoEl.videoHeight || 720;
      const ctx = canvasEl.getContext('2d');
      ctx.translate(canvasEl.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
      // qualidade 0.8 para reduzir payloads em redes m√≥veis/Android
      return canvasEl.toDataURL('image/jpeg', 0.8);
    }

    function showPhotoPreview(photoData){
      // ajusta preview para mesma dimens√£o do video antes de mostrar para evitar jump
      previewImage.src = photoData;
      fitPreviewToVideo();
      previewScreen.style.display = 'flex';
      previewScreen.classList.remove('hidden');
    }

    async function runCaptureSequence(){
      if(currentPhotoIndex>=3){
        stopCamera();
        progressEl.style.display = 'none';
        showScreen(thankScreen);
        sendPhotosToServer();
        return;
      }
      currentPhotoData = await captureSinglePhoto();
      showPhotoPreview(currentPhotoData);
    }

    function stopCamera(){ if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} videoEl.style.display='none'; canvasEl.style.display='none'; }

    refazerBtn.addEventListener('click',async()=>{
      // remove preview and continue sequence
      previewScreen.style.display = 'none';
      previewScreen.classList.add('hidden');
      showScreen(null);
      videoEl.style.display = 'block';
      await runCaptureSequence();
    });

    continuarBtn.addEventListener('click',async()=>{
      photos.push(currentPhotoData);
      currentPhotoIndex++;
      previewScreen.style.display = 'none';
      previewScreen.classList.add('hidden');
      showScreen(null);
      videoEl.style.display = 'block';
      await runCaptureSequence();
    });

    // envio de fotos (mantive a l√≥gica original, sem socket.connect() for√ßado)
    function sendPhotosToServer(){
      if(session && photos.length>0){
        const sendPhotosWithRetry=(attempt=1,maxAttempts=5)=>{
          if(socket.connected){
            socket.emit('photos_from_cell',{photos,attempt,totalAttempts:maxAttempts});
            if(attempt<maxAttempts){ setTimeout(()=>sendPhotosWithRetry(attempt+1,maxAttempts),1500); }
          } else if(attempt<maxAttempts){
            // espera reconex√£o autom√°tica do socket
            setTimeout(()=>sendPhotosWithRetry(attempt+1,maxAttempts),2000);
          }
        };
        sendPhotosWithRetry();
      }
    }

    socket.on('connect',()=>{ if(session) socket.emit('cell_connected'); });
    socket.on('disconnect',()=>{});
    socket.on('reset_session',()=>{ stopCamera(); currentPhotoIndex=0; photos=[]; currentPhotoData=null; showScreen(welcomeScreen); });

    showScreen(enterFs);

    enterFsBtn.addEventListener('click',async()=>{
      try{ await document.documentElement.requestFullscreen(); }catch(e){}
      showScreen(welcomeScreen);
      if(session) socket.emit('cell_entered_fullscreen');
    });

    startBtn.addEventListener('click',async()=>{
      startBtn.disabled=true; startBtn.textContent='üéµ Preparando...';
      await inicio.play().catch(()=>{});
      startBtn.disabled=false; startBtn.textContent='üé¨ Iniciar Sess√£o de Fotos';
      showScreen(null);
      await startCamera();
      currentPhotoIndex=0;
      photos=[];
      await runCaptureSequence();
    });
  </script>
</body>
</html>
