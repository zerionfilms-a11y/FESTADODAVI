<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
    button{cursor:pointer}
    .hidden{display:none!important}
    .visible{display:flex!important}

    /* ENTER FULLSCREEN */
    #enterFs{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#001e3c,#0b84ff);padding:18px;z-index:1000}
    #enterPanel{width:95%;max-width:420px;background:rgba(0,0,0,0.32);padding:20px;border-radius:12px;text-align:center;backdrop-filter:blur(8px)}
    #enterPanel .logo{max-width:140px;margin:0 auto 12px;display:block}
    #enterPanel h1{color:#fff;margin-bottom:8px}
    #enterPanel p{color:#dfefff;margin-bottom:14px}
    #enterFsBtn{padding:12px 16px;border-radius:10px;border:none;background:#ffd600;color:#000;font-weight:700;font-size:18px;width:100%}

    /* WELCOME SCREEN (with a real IMG as background) */
    #welcomeScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#111;padding:0;overflow:hidden}
    #welcomeBg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;display:block;z-index:1}
    /* Start button absolute on top of image using your coords mapping (4000x2250) */
    #startBtn {
      position:absolute;
      left:43.15%;
      top:76.49%;
      width:49.9875%;
      height:18.4%;
      border-radius:12px; border:2px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.18);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:22px;letter-spacing:0.6px;
      text-transform:uppercase;
      z-index:50;
    }
    #startBtn .label{ pointer-events:none }

    /* Video & canvas */
    #videoEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;z-index:5;transform:scaleX(-1)}
    #canvasEl{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;display:none;z-index:6}
    #progress{position:fixed;left:50%;transform:translateX(-50%);top:18px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.55);font-weight:700;z-index:200}
    #countdown{position:fixed;left:50%;transform:translateX(-50%);top:28%;font-size:120px;font-weight:900;text-shadow:0 0 20px #000;color:#fff;z-index:201}
    #msg{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.55);z-index:200;max-width:90%;text-align:center}

    /* Preview overlay */
    #previewScreen{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9)}
    #previewContainer{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    #previewImage{max-width:90%;max-height:70%;object-fit:contain;border-radius:8px;border:2px solid rgba(255,255,255,0.06)}
    .preview-buttons{position:absolute;bottom:36px;left:0;right:0;display:flex;gap:12px;justify-content:center;padding:0 20px}
    .preview-btn{padding:12px 18px;border-radius:10px;border:none;font-weight:700;cursor:pointer;font-size:16px;background:rgba(255,255,255,0.06);color:#fff}
    .btn-danger{background:rgba(220,53,69,0.9)}
    .btn-ok{background:rgba(40,167,69,0.9)}

    /* VISUALIZER overlay (QR centered) */
    #visualizerOverlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.96);display:none;flex-direction:column;align-items:center;justify-content:center;padding:18px}
    #vizContainer{width:100%;max-width:920px;height:70vh;background:#111;border-radius:12px;display:flex;align-items:center;justify-content:center;position:relative;padding:18px;flex-direction:column}
    #vizIframe{width:100%;height:100%;border:0;border-radius:8px;background:#000;display:none}
    #vizQR{width:320px;height:320px;background:#fff;padding:8px;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    #vizQrCanvas{width:100%;height:100%;display:block}
    #vizNotice{margin-top:14px;color:#ddd;font-size:16px;text-align:center;display:none}
    #vizLockNote{display:none}

    /* thank screen */
    #thankScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#001e3c,#0b84ff);z-index:100}
    #thankBox{background:rgba(255,255,255,0.08);padding:18px;border-radius:12px;text-align:center;color:#fff}

    /* debug */
    #debugInfo{position:fixed;left:12px;bottom:12px;font-size:11px;color:#ccc;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:6px;z-index:999}
    @media (max-width:480px){
      #startBtn{font-size:18px}
      #countdown{font-size:72px; top:24%}
      #vizContainer{height:58vh}
      #vizQR{width:220px;height:220px}
    }
  </style>
</head>
<body>
  <!-- ENTER FULLSCREEN -->
  <div id="enterFs" role="dialog" aria-label="Entrar em tela cheia">
    <div id="enterPanel">
      <img src="logo.png" class="logo" alt="Logo" onerror="this.style.display='none'">
      <h1>ðŸ“¸ Cabine FotogrÃ¡fica</h1>
      <p>Para melhor experiÃªncia, entre em tela cheia</p>
      <button id="enterFsBtn" type="button">ðŸŽ¬ Entrar em Tela Cheia</button>
    </div>
  </div>

  <!-- WELCOME SCREEN - com IMG real como fundo -->
  <div id="welcomeScreen" class="hidden" aria-hidden="true">
    <img id="welcomeBg" src="iniciar.png" alt="Fundo iniciar" onerror="onWelcomeBgError()" />
    <button id="startBtn" aria-label="Iniciar SessÃ£o"><span class="label">INICIAR SESSÃƒO</span></button>
  </div>

  <!-- camera and canvas -->
  <video id="videoEl" autoplay playsinline muted></video>
  <canvas id="canvasEl"></canvas>

  <div id="progress" class="hidden" aria-hidden="true"></div>
  <div id="countdown" class="hidden" aria-hidden="true"></div>
  <div id="msg" class="hidden" aria-hidden="true"></div>

  <!-- preview -->
  <div id="previewScreen" class="hidden" aria-hidden="true">
    <div id="previewContainer">
      <img id="previewImage" src="" alt="Preview da foto">
      <div class="preview-buttons">
        <button id="refazerBtn" class="preview-btn btn-danger">ðŸ”„ Refazer</button>
        <button id="continuarBtn" class="preview-btn btn-ok">âœ… Continuar</button>
      </div>
    </div>
  </div>

  <!-- visualizer overlay (shows iframe or QR) -->
  <div id="visualizerOverlay" aria-hidden="true">
    <div id="vizContainer">
      <iframe id="vizIframe" src="about:blank" title="Visualizador"></iframe>
      <div id="vizQR" title="Abrir visualizador">
        <canvas id="vizQrCanvas" width="300" height="300"></canvas>
      </div>
    </div>
    <div id="vizNotice">Aguarde â€” a sessÃ£o sÃ³ serÃ¡ liberada quando o operador finalizar.</div>
  </div>

  <!-- thank -->
  <div id="thankScreen" class="hidden" aria-hidden="true">
    <div id="thankBox">
      <h2>âœ¨ Obrigado por utilizar a cabine!</h2>
      <p>As fotos foram enviadas. Aguarde o operador liberar o visualizador.</p>
    </div>
  </div>

  <div id="debugInfo" aria-hidden="true"></div>

  <!-- optional sounds -->
  <audio id="clack" src="clack.mp3" preload="auto"></audio>
  <audio id="inicio" src="inicio.mp3" preload="auto"></audio>
  <audio id="fim" src="fim.mp3" preload="auto"></audio>

  <script>
    /* ---------- Config ---------- */
    const SERVER_URL = "https://festadodavi-production-0591.up.railway.app";
    const MAX_PHOTOS = 3;
    const COUNTDOWN_SECONDS = 5;
    const MAX_SEND_WIDTH = 1280; // resize before sending to reduce upload time
    const SEND_QUALITY = 0.78; // jpeg quality for faster transfers
    const SOCKET_TIMEOUT_MS = 10000;

    /* ---------- Socket ---------- */
    const socket = io(SERVER_URL, {
      transports: ["websocket","polling"],
      reconnection: true,
      path: "/socket.io"
    });

    /* ---------- DOM ---------- */
    const enterFs = document.getElementById('enterFs');
    const enterFsBtn = document.getElementById('enterFsBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const startBtn = document.getElementById('startBtn');
    const welcomeBg = document.getElementById('welcomeBg');

    const videoEl = document.getElementById('videoEl');
    const canvasEl = document.getElementById('canvasEl');
    const progressEl = document.getElementById('progress');
    const countdownEl = document.getElementById('countdown');
    const msgEl = document.getElementById('msg');

    const previewScreen = document.getElementById('previewScreen');
    const previewImage = document.getElementById('previewImage');
    const refazerBtn = document.getElementById('refazerBtn');
    const continuarBtn = document.getElementById('continuarBtn');

    const visualizerOverlay = document.getElementById('visualizerOverlay');
    const vizIframe = document.getElementById('vizIframe');
    const vizQrCanvas = document.getElementById('vizQrCanvas');
    const vizQR = document.getElementById('vizQR');
    const vizNotice = document.getElementById('vizNotice');

    const thankScreen = document.getElementById('thankScreen');
    const debugInfo = document.getElementById('debugInfo');

    /* ---------- State ---------- */
    const params = new URLSearchParams(location.search);
    const session = params.get('session') || 'cabine-fixa';
    let stream = null;
    let photos = [];              // array of dataURLs (resized)
    let currentPhotoIndex = 0;
    let currentPhotoData = null;
    let isCapturing = false;
    let visualizerLocked = false;
    let currentVisualizerUrl = null; // stored so clicking canvas opens the link
    let sending = false;

    /* debug */
    setInterval(() => {
      debugInfo.textContent = `SessÃ£o: ${session} | Socket: ${socket.connected ? 'ðŸŸ¢' : 'ðŸ”´'} | Fotos: ${photos.length}/${MAX_PHOTOS} | Capturando: ${isCapturing ? 'SIM' : 'NÃƒO'} | Enviando: ${sending ? 'SIM' : 'NÃƒO'} | VizLocked: ${visualizerLocked ? 'SIM' : 'NÃƒO'}`;
    }, 700);

    /* ---------- Helpers ---------- */
    function onWelcomeBgError(){
      console.warn('Falha ao carregar iniciar.png â€” verifique o caminho/nome (case-sensitive).');
      debugInfo.textContent = 'Erro: iniciar.png nÃ£o encontrado. Coloque iniciar.png na mesma pasta do celular.html (verifique maiÃºsculas/minÃºsculas).';
      welcomeBg.style.display = 'none';
    }

    function showScreen(screenEl){
      [enterFs, welcomeScreen, previewScreen, thankScreen].forEach(s => s && s.classList.add('hidden'));
      progressEl.classList.add('hidden'); countdownEl.classList.add('hidden'); msgEl.classList.add('hidden');
      if(screenEl === welcomeScreen || screenEl === enterFs) stopCamera();
      if(screenEl) screenEl.classList.remove('hidden');
    }
    function showProgress(text){ progressEl.textContent = text; progressEl.classList.remove('hidden'); }
    function hideProgress(){ progressEl.classList.add('hidden'); }
    function showCountdown(text){ countdownEl.textContent = text; countdownEl.classList.remove('hidden'); }
    function hideCountdown(){ countdownEl.classList.add('hidden'); }
    function showMsg(text){ msgEl.textContent = text; msgEl.classList.remove('hidden'); }
    function hideMsg(){ msgEl.classList.add('hidden'); }

    /* ---------- Camera ---------- */
    async function startCamera(){
      try{
        const constraints = { video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = stream;
        videoEl.style.display = 'block';
        videoEl.style.transform = 'scaleX(-1)';
        await videoEl.play().catch(()=>{});
        await new Promise(r=>setTimeout(r,100));
      }catch(err){
        console.error('startCamera', err);
        alert('NÃ£o foi possÃ­vel acessar a cÃ¢mera frontal. Verifique permissÃµes.');
        throw err;
      }
    }

    function stopCamera(){
      try{
        if(stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
      }catch(e){}
      try{ videoEl.pause(); videoEl.srcObject = null; }catch(e){}
      videoEl.style.display = 'none';
    }

    // grab and compress/rescale frame for faster transfer
    function grabFrameDataURL(maxWidth=MAX_SEND_WIDTH, quality=SEND_QUALITY){
      const vw = videoEl.videoWidth || 1280;
      const vh = videoEl.videoHeight || 720;
      let targetW = vw, targetH = vh;
      if (vw > maxWidth) {
        targetW = maxWidth;
        targetH = Math.round((vh * maxWidth) / vw);
      }
      canvasEl.width = targetW; canvasEl.height = targetH;
      const ctx = canvasEl.getContext('2d');
      ctx.clearRect(0,0,targetW,targetH);
      ctx.save();
      ctx.translate(targetW,0); ctx.scale(-1,1);
      ctx.drawImage(videoEl, 0, 0, targetW, targetH);
      ctx.restore();
      return canvasEl.toDataURL('image/jpeg', quality);
    }

    /* ---------- Capture flow (3 photos, preview each) ---------- */
    async function captureSinglePhotoFlow(){
      isCapturing = true;
      showProgress(`Foto ${currentPhotoIndex+1} de ${MAX_PHOTOS}`);
      if(!stream) await startCamera();
      videoEl.style.display = 'block';

      for(let t = COUNTDOWN_SECONDS; t > 0; t--){
        if(t <= 2){ showCountdown('ðŸ“¸'); }
        else { showCountdown(String(t)); }
        if(t === 2){
          try { document.getElementById('clack').currentTime = 0; document.getElementById('clack').play().catch(()=>{}); } catch(e){}
        }
        await new Promise(r=>setTimeout(r,1000));
      }
      hideCountdown();
      const data = grabFrameDataURL(MAX_SEND_WIDTH, SEND_QUALITY);
      isCapturing = false;
      return data;
    }

    // orchestrates capturing 3 photos with preview and per-photo retake option
    async function runCaptureSequence(){
      try{
        photos = [];
        currentPhotoIndex = 0;
        await startCamera();
        while (currentPhotoIndex < MAX_PHOTOS && !visualizerLocked) {
          const frame = await captureSinglePhotoFlow();
          const decision = await showPreviewAndAwaitDecision(frame);
          if (decision === 'continuar') {
            photos.push(frame);
            currentPhotoIndex++;
            hideMsg();
            // short feedback
            showMsg(`âœ… Foto ${photos.length} salva`);
            setTimeout(()=>hideMsg(), 900);
          } else {
            // refazer -> loop repeats same index
            showMsg('RefaÃ§a a foto');
            setTimeout(()=>hideMsg(), 700);
          }
        }

        // after capturing 3 photos, send them as one batch to server
        if (photos.length >= 1) {
          // disable start to avoid double sends
          startBtn.disabled = true;
          sending = true;
          showProgress('Enviando 3 fotos ao servidor...');
          try {
            const resp = await sendThreePhotosBatch(photos);
            sending = false;
            hideProgress();
            if (resp && resp.ok) {
              // show thank screen and wait for server to emit show_qr
              stopCamera();
              showScreen(thankScreen);
              // keep photos array in memory
            } else {
              // fallback message
              showMsg('âŒ Erro no envio. Tente novamente.');
              setTimeout(()=>hideMsg(),2000);
              showScreen(welcomeScreen);
            }
          } catch(e){
            sending = false;
            hideProgress();
            console.error('sendThreePhotosBatch err', e);
            showMsg('âŒ Falha ao enviar. Verifique a rede.');
            setTimeout(()=>hideMsg(),3000);
            showScreen(welcomeScreen);
          } finally {
            startBtn.disabled = false;
          }
        } else {
          stopCamera();
          showScreen(welcomeScreen);
        }
      }catch(err){
        console.error('runCaptureSequence error', err);
        stopCamera();
        alert('Erro durante captura. Reinicie a sessÃ£o.');
        showScreen(welcomeScreen);
      }
    }

    function showPreviewAndAwaitDecision(photoData){
      return new Promise((resolve) => {
        previewImage.src = photoData;
        previewScreen.classList.remove('hidden');

        const onRef = () => { cleanup(); resolve('refazer'); };
        const onCont = () => { cleanup(); resolve('continuar'); };
        function cleanup(){ refazerBtn.removeEventListener('click', onRef); continuarBtn.removeEventListener('click', onCont); previewScreen.classList.add('hidden'); }
        refazerBtn.addEventListener('click', onRef);
        continuarBtn.addEventListener('click', onCont);
      });
    }

    /* ---------- Send photos to server: try socket with timeout, fallback to HTTP /upload_photos ---------- */
    function sendThreePhotosBatch(photoDataArray, attempt = 1, maxAttempts = 4) {
      return new Promise((resolve, reject) => {
        const payload = { session, photos: photoDataArray, ts: new Date().toISOString() };

        // helper: HTTP fallback
        function tryHttpFallback() {
          const url = (SERVER_URL.replace(/\/+$/,'')) + '/upload_photos';
          fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }).then(r => r.json()).then(json => {
            resolve({ ok:true, via:'http', resp:json });
          }).catch(err => {
            reject(err);
          });
        }

        if (socket && socket.connected) {
          try {
            // use socket.timeout to allow server to ack quickly (server creates viewerId fast)
            socket.timeout(SOCKET_TIMEOUT_MS).emit('photos_from_cell', payload, (err, ack) => {
              if (err) {
                console.warn('socket emit photos_from_cell err/timeout', err);
                if (attempt < maxAttempts) {
                  setTimeout(()=> sendThreePhotosBatch(photoDataArray, attempt+1, maxAttempts).then(resolve).catch(reject), 900 * attempt);
                } else {
                  tryHttpFallback();
                }
              } else {
                // ack may include viewerId / visualizadorUrl on HTTP flow; but server will also emit show_qr later
                resolve({ ok:true, via:'socket', ack });
              }
            });
          } catch(e) {
            console.warn('socket.emit exception', e);
            if (attempt < maxAttempts) {
              setTimeout(()=> sendThreePhotosBatch(photoDataArray, attempt+1, maxAttempts).then(resolve).catch(reject), 900 * attempt);
            } else {
              tryHttpFallback();
            }
          }
        } else {
          // not connected: try to connect then retry
          if (attempt < maxAttempts) {
            try { socket.connect(); } catch(e){}
            setTimeout(()=> sendThreePhotosBatch(photoDataArray, attempt+1, maxAttempts).then(resolve).catch(reject), 1200);
          } else {
            tryHttpFallback();
          }
        }
      });
    }

    /* ---------- Visualizer lock flow (server-driven) ---------- */
    // draw QR (url may be image or plain link)
    function drawQrOnCanvas(canvas, url){
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!url){
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#fff'; ctx.font = '14px Arial'; ctx.fillText('QR', 10, 20);
        return;
      }
      const isImage = /\.(png|jpe?g|gif|svg)(\?|$)/i.test(url);
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
        const w = img.width * scale, h = img.height * scale;
        ctx.drawImage(img, (canvas.width - w)/2, (canvas.height - h)/2, w, h);
      };
      img.onerror = () => {
        // fallback: generate QR via qrserver API
        const gen = new Image();
        gen.crossOrigin = 'anonymous';
        gen.onload = () => {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          const scale = Math.min(canvas.width / gen.width, canvas.height / gen.height);
          const w = gen.width * scale, h = gen.height * scale;
          ctx.drawImage(gen, (canvas.width - w)/2, (canvas.height - h)/2, w, h);
        };
        gen.onerror = () => {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = '#fff'; ctx.font = '12px Arial'; ctx.fillText(url, 6, 20);
        };
        gen.src = 'https://api.qrserver.com/v1/create-qr-code/?size=' + canvas.width + 'x' + canvas.height + '&data=' + encodeURIComponent(url);
      };
      img.src = url;
    }

    function showVisualizerOverlay({ visualizerUrl, qrUrl, showIframe }) {
      visualizerLocked = true;
      stopCamera();
      visualizerOverlay.style.display = 'flex';
      visualizerOverlay.setAttribute('aria-hidden','false');
      currentVisualizerUrl = visualizerUrl || qrUrl || null;
      vizNotice.style.display = 'block';
      // choose iframe only if requested by operator and URL is same-origin or safe
      if (showIframe && visualizerUrl) {
        vizIframe.style.display = 'block';
        vizIframe.src = visualizerUrl;
        vizQR.style.display = 'none';
      } else {
        vizIframe.style.display = 'none';
        vizIframe.src = 'about:blank';
        vizQR.style.display = 'flex';
        const source = qrUrl || visualizerUrl || null;
        drawQrOnCanvas(vizQrCanvas, source);
      }
      // disable UI
      enterFsBtn.disabled = true;
      startBtn.disabled = true;
      showMsg('Visualizador aberto â€” aguarde liberaÃ§Ã£o do operador.');
    }

    function hideVisualizerOverlay(){
      visualizerLocked = false;
      visualizerOverlay.style.display = 'none';
      visualizerOverlay.setAttribute('aria-hidden','true');
      vizIframe.src = 'about:blank';
      enterFsBtn.disabled = false;
      startBtn.disabled = false;
      currentVisualizerUrl = null;
      vizNotice.style.display = 'none';
      hideMsg();
      showScreen(welcomeScreen);
    }

    /* ---------- Events wiring ---------- */
    enterFsBtn.addEventListener('click', async () => {
      try { await document.documentElement.requestFullscreen(); } catch(e){ console.warn('fullscreen failed', e); }
      if(!visualizerLocked) showScreen(welcomeScreen);
      if(socket && socket.connected) socket.emit('cell_entered_fullscreen', { session });
    });

    startBtn.addEventListener('click', async () => {
      if(visualizerLocked || sending) return;
      try { document.getElementById('inicio').currentTime = 0; document.getElementById('inicio').play().catch(()=>{}); } catch(e){}
      showScreen(null); // hide overlays -> camera
      currentPhotoIndex = 0; photos = []; currentPhotoData = null;
      await runCaptureSequence();
    });

    // clicking QR opens visualizer in new tab (if currentVisualizerUrl set)
    vizQR.addEventListener('click', (ev) => {
      if(!currentVisualizerUrl) return;
      try {
        window.open(currentVisualizerUrl, '_blank', 'noopener');
      } catch(e){}
    });

    // socket basic events
    socket.on('connect', () => {
      console.log('socket connected', socket.id);
      if(session) socket.emit('cell_connected', { session, id: socket.id });
    });
    socket.on('disconnect', () => { console.log('socket disconnected'); });

    // server instructs show visualizer and lock the cell UI
    socket.on('visualizer_ready', (data) => {
      if(!data) return;
      if(data.session && data.session !== session) return;
      showVisualizerOverlay({ visualizerUrl: data.visualizerUrl || data.visualizadorUrl || data.url, qrUrl: data.qrUrl || data.qrcode || data.qr, showIframe: data.showIframe });
    });

    // server may instruct show_qr_on_viewer (index uses this)
    socket.on('show_qr_on_viewer', (data) => {
      if(!data) return;
      if (data.session && data.session !== session) {
        // ignore different session
      }
      const url = data.visualizadorUrl || data.visualizerUrl || data.url || data.visualizador;
      const qr = data.visualizadorUrl || data.qrUrl || data.qrcode || data.qr;
      showVisualizerOverlay({ visualizerUrl: url, qrUrl: qr || url, showIframe: data.showIframe });
    });

    socket.on('show_qr', (data) => {
      if(!data) return;
      const url = data.visualizadorUrl || data.visualizerUrl || data.url || data.visualizador || data.qr;
      showVisualizerOverlay({ visualizerUrl: url, qrUrl: url });
    });

    // server finalizes session â€” unlock cell
    socket.on('finalize_session', (data) => {
      if(data && data.session && data.session !== session) return;
      console.log('finalize_session received, unlocking celular');
      hideVisualizerOverlay();
      photos = []; currentPhotoIndex = 0; currentPhotoData = null;
    });

    socket.on('reset_session', (data) => {
      if(data && data.session && data.session !== session) return;
      console.log('reset_session received, unlocking celular');
      hideVisualizerOverlay();
      photos = []; currentPhotoIndex = 0; currentPhotoData = null;
    });

    // keyboard escape hides preview if shown (but not visualizer when locked)
    document.addEventListener('keydown', ev => {
      if(ev.key === 'Escape'){
        if(!previewScreen.classList.contains('hidden')) previewScreen.classList.add('hidden');
      }
    });

    // initial state
    showScreen(enterFs);

    // stop camera on page hide
    document.addEventListener('visibilitychange', () => {
      if(document.hidden) stopCamera();
    });

    // expose helpers for debug
    window._cabine = {
      startCamera: async ()=> await startCamera(),
      stopCamera: ()=> stopCamera(),
      grabFrame: ()=> grabFrameDataURL(),
      photos: ()=> photos.slice(),
      unlockVisualizer: ()=> hideVisualizerOverlay()
    };
  </script>
</body>
</html>
