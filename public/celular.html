<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#000;overflow:hidden}
    .screen{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;flex-direction:column;padding:15px;text-align:center}
    .visible{display:flex}
    button{padding:18px 25px;border-radius:12px;border:none;background:#ffd600;color:#000;font-weight:700;cursor:pointer;font-size:20px;margin:15px;width:90%;max-width:300px}
    #videoBg{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1;display:none;filter:brightness(0.8)}
    #countdown{position:fixed;top:30%;left:0;right:0;text-align:center;font-size:120px;font-weight:800;text-shadow:0 0 20px #000;z-index:2;display:none;color:#fff}
    #previewScreen img{max-width:90vw;border-radius:10px;border:4px solid rgba(0,0,0,0.4)}
    .buttons{display:flex;gap:15px;margin-top:20px}
    .buttons button{flex:1;max-width:150px}
    #refazer{background:#dc3545;color:#fff}
    #continuar{background:#28a745;color:#fff}
  </style>
</head>
<body>

  <div id="fullscreenScreen" class="screen visible" style="background:#222;color:#fff;">
    <h1 style="font-size:28px;margin-bottom:15px;">ðŸ“¸ Cabine FotogrÃ¡fica</h1>
    <p style="font-size:18px;margin-bottom:15px;">Para comeÃ§ar, entre em tela cheia</p>
    <button id="enterFullscreenBtn">ðŸ”² Entrar em Tela Cheia</button>
  </div>

  <div id="welcomeScreen" class="screen" style="background:#fff;color:#000;">
    <h1 style="font-size:26px;margin-bottom:15px;">ðŸ“¸ Bem-vindo Ã  Cabine!</h1>
    <p style="font-size:18px;margin-bottom:15px;">Clique abaixo para iniciar</p>
    <button id="startBtn">ðŸŽ¬ Iniciar SessÃ£o</button>
    <p id="waitingMsg" style="color:#555;margin-top:10px;display:none;">Aguardando cÃ¢mera do operador...</p>
  </div>

  <img id="videoBg" src="">
  <div id="countdown">3</div>

  <div id="previewScreen" class="screen" style="background:rgba(0,0,0,0.9);z-index:3;">
    <img id="previewImg" src="">
    <div class="buttons">
      <button id="refazer">ðŸ”„ Refazer</button>
      <button id="continuar">âœ… Continuar</button>
    </div>
  </div>

  <div id="thankScreen" class="screen" style="background:#0b84ff;color:#fff;">
    <h1>âœ¨ Obrigado por participar!</h1>
    <p>Espere o operador finalizar.</p>
  </div>

  <script>
    const SERVER_URL = "https://festadodavi.onrender.com";
    const session = "cabine-fixa";

    const socket = io(SERVER_URL, { transports:["websocket"], reconnection:true });

    const el = id => document.getElementById(id);
    const fullscreenScreen = el("fullscreenScreen");
    const welcomeScreen = el("welcomeScreen");
    const videoBg = el("videoBg");
    const countdown = el("countdown");
    const previewScreen = el("previewScreen");
    const previewImg = el("previewImg");
    const thankScreen = el("thankScreen");
    const waitingMsg = el("waitingMsg");

    function show(screen){
      [fullscreenScreen,welcomeScreen,previewScreen,thankScreen].forEach(s=>s.classList.remove("visible"));
      if(screen) screen.classList.add("visible");
    }

    let framesOk = false, currentPhoto=0, photos=[];

    socket.on("connect",()=>{
      socket.emit("join_session",{session,role:"viewer"});
    });

    socket.on("stream_frame",({frame})=>{
      videoBg.src = frame;
      videoBg.style.display="block";
      waitingMsg.style.display="none";
      framesOk = true;
    });

    socket.on("photo_ready",({photo})=>{
      previewImg.src = photo;
      show(previewScreen);
    });

    function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

    async function countdownAndCapture(){
      if(!framesOk){
        waitingMsg.style.display="block";
        await sleep(2000);
        if(!framesOk){ alert("Aguardando cÃ¢mera do operador..."); return; }
      }
      countdown.style.display="block";
      for(let i=3;i>0;i--){
        countdown.textContent=i;
        await sleep(1000);
      }
      countdown.style.display="none";
      socket.emit("take_photo",{session,index:currentPhoto,viewerId:socket.id});
    }

    el("enterFullscreenBtn").onclick = async()=>{
      try{await document.documentElement.requestFullscreen();}catch(e){}
      show(welcomeScreen);
    };

    el("startBtn").onclick = async()=>{
      await countdownAndCapture();
    };

    el("refazer").onclick = async()=>{
      show(null);
      await countdownAndCapture();
    };

    el("continuar").onclick = async()=>{
      photos.push(previewImg.src);
      currentPhoto++;
      if(currentPhoto>=3){
        socket.emit("photos_submit",{session,photos});
        show(thankScreen);
        setTimeout(()=>location.reload(),4000);
      }else{
        show(null);
        await countdownAndCapture();
      }
    };
  </script>
</body>
</html>
