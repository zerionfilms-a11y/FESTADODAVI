<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine Fotogr√°fica ‚Äî Celular</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#ffffff;color:#222222;overflow:hidden}

    /* telas (cards) sempre acima do v√≠deo */
    .screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:18px;z-index:800}

    /* CARD IN√çCIO: grande e leg√≠vel */
    .card {
      width: 96%;
      max-width: 1100px;
      padding: 48px;
      border-radius: 18px;
      background: rgba(255,255,255,0.995);
      box-shadow: 0 18px 50px rgba(0,0,0,0.08);
      text-align:center;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* logo: tenta caminhos comuns */
    .logo{height:120px; width:auto; margin-bottom:26px; border-radius:10px; display:block; margin-left:auto; margin-right:auto; object-fit:contain;}
    h1 { font-size: 40px; line-height:1.05; margin-bottom: 12px; color:#222222; }
    p.lead { font-size: 20px; color:#444; margin-bottom:22px; max-width:920px; margin-left:auto; margin-right:auto; }

    /* bot√µes grandes para toque */
    .btn-primary { padding:22px 36px;border-radius:14px;border:none;background:#b07e09;color:#fff;font-weight:900;cursor:pointer;font-size:26px;margin:12px auto;width:90%;max-width:560px;display:block; }
    .btn-start { padding:20px 32px;border-radius:14px;border:none;background:#b07e09;color:#fff;font-weight:900;cursor:pointer;font-size:24px;margin-top:18px;width:90%;max-width:520px;display:block; }

    /* v√≠deo fica por baixo (z-index baixo) */
    #videoWrap{position:fixed;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:100}
    #videoEl{width:100%;height:100%;object-fit:cover;display:none;transform:scaleX(-1);z-index:101}
    #canvasEl{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:102}

    /* progresso */
    #progress{position:fixed;top:18px;left:50%;transform:translateX(-50%);text-align:center;font-size:18px;font-weight:700;z-index:810;color:#222;background:rgba(255,255,255,0.95);padding:10px 14px;border-radius:10px;display:none}

    /* overlay contagem fullscreen (bloqueia c√¢mera) */
    #countdownOverlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;background:rgba(0,0,0,0.88);
    }
    #countdownText{color:#fff;font-size:140px;font-weight:900;text-align:center;line-height:1;padding:8px 16px;}

    /* PREVIEW (tamb√©m acima do v√≠deo) */
    #previewScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:920;background:rgba(0,0,0,0.92)}
    #previewInner{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    #previewImage{max-width:100%;max-height:100%;object-fit:cover;border-radius:6px}
    .preview-controls{position:absolute;bottom:28px;left:0;right:0;display:flex;justify-content:center;gap:16px;z-index:930}
    .btn { padding:14px 20px;border-radius:12px;border:none;font-weight:800;cursor:pointer }
    .btn--brand{background:#b07e09;color:#fff;font-size:18px}
    .btn--light{background:#fff;color:#222;border:1px solid rgba(0,0,0,0.06);font-size:18px}

    /* debug */
    #debugInfo {position:fixed;bottom:12px;left:12px;font-size:12px;color:#666;background:rgba(255,255,255,0.95);padding:6px;border-radius:6px;z-index:850;border:1px solid rgba(0,0,0,0.06)}

    /* responsivo: mant√©m leg√≠vel em telas pequenas */
    @media (max-width:480px){
      .logo{height:84px}
      h1{font-size:26px}
      p.lead{font-size:16px}
      .btn-primary{font-size:18px;padding:14px 20px}
      #countdownText{font-size:86px}
    }
  </style>
</head>
<body>
  <!-- TELA DE IN√çCIO (vis√≠vel por padr√£o) -->
  <div id="enterFs" class="screen">
    <div class="card" role="region" aria-label="Iniciar Sess√£o">
      <!-- tenta caminhos comuns: /public/logo1.png -> /public/logo.png -> /logo1.png -> /logo.png -->
      <img src="/public/logo1.png" alt="Logo" class="logo" 
           onerror="if(this.src!='/public/logo.png'){ this.src='/public/logo.png'; this.onerror=function(){ if(this.src!='/logo1.png'){ this.src='/logo1.png'; this.onerror=function(){ this.src='/logo.png'; } } } }">
      <h1>üì∏ Cabine Fotogr√°fica</h1>
      <p class="lead">Para melhor experi√™ncia, entre em tela cheia e clique em iniciar sess√£o. Use o bot√£o abaixo para come√ßar.</p>
      <button id="enterFsBtn" class="btn-primary" aria-label="Entrar em tela cheia">üé¨ Entrar em Tela Cheia</button>
    </div>
  </div>

  <!-- WELCOME (escondido inicialmente) -->
  <div id="welcomeScreen" class="screen hidden" style="display:none">
    <div class="card" role="region" aria-label="Bem-vindo">
      <img src="/public/logo1.png" alt="Logo" class="logo" 
           onerror="if(this.src!='/public/logo.png'){ this.src='/public/logo.png'; this.onerror=function(){ if(this.src!='/logo1.png'){ this.src='/logo1.png'; this.onerror=function(){ this.src='/logo.png'; } } } }">
      <h1>üì∏ Bem-vindo √† Cabine Fotogr√°fica</h1>
      <p class="lead">Clique abaixo para iniciar a sess√£o de fotos.</p>
      <button id="startBtn" class="btn-start" aria-label="Iniciar sess√£o">üé¨ Iniciar Sess√£o de Fotos</button>
    </div>
  </div>

  <!-- video por baixo -->
  <div id="videoWrap" aria-hidden="true">
    <video id="videoEl" autoplay playsinline muted></video>
    <canvas id="canvasEl"></canvas>
  </div>

  <div id="progress" aria-hidden="true"></div>

  <!-- overlay contagem -->
  <div id="countdownOverlay" aria-hidden="true">
    <div id="countdownText">3</div>
  </div>

  <!-- preview -->
  <div id="previewScreen" class="hidden" aria-hidden="true">
    <div id="previewInner">
      <img id="previewImage" src="" alt="Preview da foto">
    </div>
    <div class="preview-controls">
      <button id="refazerBtn" class="btn btn--light">üîÑ Refazer</button>
      <button id="continuarBtn" class="btn btn--brand">‚úÖ Continuar</button>
    </div>
  </div>

  <div id="thankScreen" class="screen hidden" style="display:none">
    <div class="card" role="region" aria-label="Obrigado">
      <img src="/public/logo1.png" alt="Logo" class="logo" 
           onerror="if(this.src!='/public/logo.png'){ this.src='/public/logo.png'; this.onerror=function(){ if(this.src!='/logo1.png'){ this.src='/logo1.png'; this.onerror=function(){ this.src='/logo.png'; } } } }">
      <h1>‚ú® Obrigado por utilizar a cabine!</h1>
      <p class="lead">Aguarde o operador encerrar a sess√£o.</p>
    </div>
  </div>

  <div id="debugInfo" aria-hidden="true"></div>

  <audio id="clack" src="clack.mp3" preload="auto"></audio>
  <audio id="inicio" src="inicio.mp3" preload="auto"></audio>
  <audio id="fim" src="fim.mp3" preload="auto"></audio>

  <script>
    const SERVER_URL = "https://festadodavi.onrender.com";
    const socket = io(SERVER_URL, { transports:["websocket"], reconnection:true, reconnectionAttempts:5, reconnectionDelay:1000, timeout:20000, forceNew:false, withCredentials:true });

    const enterFs = document.getElementById('enterFs');
    const enterFsBtn = document.getElementById('enterFsBtn');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const startBtn = document.getElementById('startBtn');
    const videoEl = document.getElementById('videoEl');
    const canvasEl = document.getElementById('canvasEl');
    const progressEl = document.getElementById('progress');
    const countdownOverlay = document.getElementById('countdownOverlay');
    const countdownText = document.getElementById('countdownText');
    const previewScreen = document.getElementById('previewScreen');
    const previewImage = document.getElementById('previewImage');
    const refazerBtn = document.getElementById('refazerBtn');
    const continuarBtn = document.getElementById('continuarBtn');
    const thankScreen = document.getElementById('thankScreen');
    const clack = document.getElementById('clack');
    const inicio = document.getElementById('inicio');
    const fim = document.getElementById('fim');
    const debugEl = document.getElementById('debugInfo');

    const params = new URLSearchParams(location.search);
    const session = params.get('session');

    let stream = null, photos = [], currentPhotoIndex = 0, currentPhotoData = null;

    setInterval(()=>{ debugEl.textContent = `Sess√£o: ${session || 'none'} | Socket: ${socket.connected ? 'üü¢' : 'üî¥'}` }, 1000);

    function showScreen(screenElement){
      // esconder telas (exceto videoWrap)
      [enterFs, welcomeScreen, previewScreen, thankScreen].forEach(s => {
        if(!s) return;
        s.classList.add('hidden');
        s.style.display = 'none';
      });
      // hide overlays
      countdownOverlay.style.display = 'none';
      progressEl.style.display = 'none';
      // show requested
      if(screenElement){
        screenElement.classList.remove('hidden');
        screenElement.style.display = 'flex';
      }
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    // startCamera com fallback para compatibilidade (Android)
    async function startCamera(){
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "user" } }, audio:false });
      } catch(e1){
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio:false });
        } catch(e2){
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio:false });
          } catch(e3){
            alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.');
            showScreen(welcomeScreen);
            return;
          }
        }
      }
      videoEl.srcObject = stream;
      videoEl.style.display = 'block';
      await videoEl.play();
    }

    function fitPreviewToVideo(){
      const rect = videoEl.getBoundingClientRect();
      previewImage.style.width = rect.width + 'px';
      previewImage.style.height = rect.height + 'px';
      previewImage.style.objectFit = 'cover';
    }

    // captura com qualidade reduzida pra Android (0.8)
    async function captureSinglePhoto(){
      progressEl.textContent = `${currentPhotoIndex+1}/3`;
      progressEl.style.display = 'block';

      // mostra overlay que bloqueia a c√¢mera
      countdownOverlay.style.display = 'flex';
      let c = 5;
      countdownText.textContent = String(c);
      await sleep(120);

      for(; c>0; c--){
        if(c <= 2){
          countdownText.textContent = 'SORRIA!';
          countdownText.style.color = '#ffffff';
          if(c===2){ clack.currentTime = 0; clack.play().catch(()=>{}); }
        } else {
          countdownText.textContent = String(c);
          countdownText.style.color = '#ffffff';
        }
        await sleep(1000);
      }

      // hide overlay shortly before capture to avoid black frame on some devices
      countdownOverlay.style.display = 'none';

      // captura
      canvasEl.width = videoEl.videoWidth || 1280;
      canvasEl.height = videoEl.videoHeight || 720;
      const ctx = canvasEl.getContext('2d');
      ctx.translate(canvasEl.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
      return canvasEl.toDataURL('image/jpeg', 0.8);
    }

    function showPhotoPreview(photoData){
      previewImage.src = photoData;
      fitPreviewToVideo();
      previewScreen.style.display = 'flex';
      previewScreen.classList.remove('hidden');
    }

    async function runCaptureSequence(){
      if(currentPhotoIndex>=3){
        stopCamera();
        progressEl.style.display = 'none';
        showScreen(thankScreen);
        sendPhotosToServer();
        return;
      }
      currentPhotoData = await captureSinglePhoto();
      showPhotoPreview(currentPhotoData);
    }

    function stopCamera(){ if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} videoEl.style.display='none'; canvasEl.style.display='none'; }

    refazerBtn.addEventListener('click',async()=>{
      previewScreen.style.display = 'none';
      previewScreen.classList.add('hidden');
      showScreen(null);
      videoEl.style.display = 'block';
      await runCaptureSequence();
    });

    continuarBtn.addEventListener('click',async()=>{
      photos.push(currentPhotoData);
      currentPhotoIndex++;
      previewScreen.style.display = 'none';
      previewScreen.classList.add('hidden');
      showScreen(null);
      videoEl.style.display = 'block';
      await runCaptureSequence();
    });

    // envio de fotos (mantive a l√≥gica original)
    function sendPhotosToServer(){
      if(session && photos.length>0){
        const sendPhotosWithRetry=(attempt=1,maxAttempts=5)=>{
          if(socket.connected){
            socket.emit('photos_from_cell',{photos,attempt,totalAttempts:maxAttempts});
            if(attempt<maxAttempts){ setTimeout(()=>sendPhotosWithRetry(attempt+1,maxAttempts),1500); }
          } else if(attempt<maxAttempts){
            setTimeout(()=>sendPhotosWithRetry(attempt+1,maxAttempts),2000);
          }
        };
        sendPhotosWithRetry();
      }
    }

    socket.on('connect',()=>{ if(session) socket.emit('cell_connected'); });
    socket.on('disconnect',()=>{});
    socket.on('reset_session',()=>{ stopCamera(); currentPhotoIndex=0; photos=[]; currentPhotoData=null; showScreen(welcomeScreen); });

    showScreen(enterFs);

    // fullscreen + ir para welcome
    enterFsBtn.addEventListener('click',async()=>{
      try{ await document.documentElement.requestFullscreen(); }catch(e){}
      showScreen(welcomeScreen);
      if(session) socket.emit('cell_entered_fullscreen');
    });

    startBtn.addEventListener('click',async()=>{
      startBtn.disabled=true; startBtn.textContent='üéµ Preparando...';
      await inicio.play().catch(()=>{});
      startBtn.disabled=false; startBtn.textContent='üé¨ Iniciar Sess√£o de Fotos';
      showScreen(null);
      await startCamera();
      currentPhotoIndex=0;
      photos=[];
      await runCaptureSequence();
    });
  </script>
</body>
</html>
